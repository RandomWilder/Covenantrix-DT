# OCR PDF Processing Fix - Technical Plan

## Overview
Fix scanned PDF OCR processing by converting PDF pages to images before sending to Google Vision API. Currently, raw PDF bytes are being sent to the `/images:annotate` endpoint which only accepts image formats, resulting in 0 text extracted.

## Root Cause
Google Vision's `/images:annotate` endpoint accepts only image formats (PNG, JPG, etc.), not raw PDF bytes. When PDF bytes are sent, the API silently fails and returns empty text.

## Files to Modify

### 1. `backend/requirements.txt`
**Add dependency:**
- `PyMuPDF==1.24.0` - Pure Python PDF-to-image rendering library (no system dependencies)

### 2. `backend/infrastructure/external/google_vision_ocr.py`

**Method: `_process_pdf(self, pdf_content: bytes, filename: str)` (lines 129-160)**

**Current behavior:** Sends raw PDF bytes directly to Google Vision API
```python
response = await client.detect_text(
    image_content=pdf_content,  # Raw PDF bytes - WRONG
    use_document_detection=True
)
```

**Required changes:**
1. Import PyMuPDF (`import fitz`) and PIL Image
2. Convert PDF to images using PyMuPDF at 300 DPI resolution:
   - Open PDF with `fitz.open(stream=pdf_content, filetype="pdf")`
   - Iterate through each page
   - Render each page to pixmap with matrix `fitz.Matrix(300/72, 300/72)`
   - Convert pixmap to PIL Image with `Image.frombytes("RGB", [pix.width, pix.height], pix.samples)`
   - Convert PIL Image to PNG bytes via BytesIO
3. Send each page image to Google Vision API separately
4. Collect results from all pages (text, confidence scores)
5. Combine multi-page results:
   - Concatenate text from all pages with newline separators
   - Calculate average confidence across all pages
   - Return combined OCRResult

**Method: `__init__` (lines 33-56)**
- Change `self.min_char_count = 5` to `self.min_char_count = 1` (line 31 DEFAULT_MIN_CHAR_COUNT constant)
- Reason: Threshold of 5 characters too strict for short documents

### 3. `backend/infrastructure/external/google_vision_client.py`

**Method: `_make_api_request(self, endpoint: str, request_data: Dict[str, Any])` (lines 402-446)**

**Location: Error handling block for status 400 (lines 425-428)**

**Add logging:**
```python
elif response.status == 400:
    error_data = await response.json()
    self.logger.error(f"Google Vision API 400 error: {error_data}")  # ADD THIS
    error_msg = error_data.get("error", {}).get("message", "Bad request")
    raise GoogleVisionAPIError(f"Bad request: {error_msg}", 400)
```

**Purpose:** Log full error response when Google Vision returns 400 errors for debugging

## Implementation Algorithm

### PDF-to-Image Processing Flow

1. **Open PDF Document**
   - Use `fitz.open(stream=pdf_content, filetype="pdf")` to load PDF from bytes
   - Get page count with `len(pdf_doc)`

2. **Process Each Page**
   - For each page index from 0 to page_count:
     - Get page: `page = pdf_doc[page_num]`
     - Create 300 DPI transformation matrix: `mat = fitz.Matrix(300/72, 300/72)`
     - Render page to pixmap: `pix = page.get_pixmap(matrix=mat)`
     - Convert to PIL Image: `img = Image.frombytes("RGB", [pix.width, pix.height], pix.samples)`
     - Convert to PNG bytes using BytesIO
     - Send to Google Vision API: `await client.detect_text(image_content=img_bytes)`
     - Store extracted text and confidence

3. **Combine Results**
   - Join all page texts with `\n\n` separator
   - Calculate average confidence: `sum(confidences) / len(confidences)`
   - Return OCRResult with combined text, average confidence, total page count

## Technical Constraints

**Do NOT use:**
- `pdf2image` library - requires system-level Poppler installation (platform-specific)
- `/files:annotate` endpoint - async API with different response structure
- Any dependencies requiring external system libraries

**Use PyMuPDF because:**
- Pure Python implementation (cross-platform)
- No external system dependencies
- Fast rendering performance
- Production-ready

## Expected Behavior Change

**Before (broken):**
```
Google Vision response: text_length=0, confidence=0.0
No text extracted from חוזה עלם.pdf
```

**After (fixed):**
```
Converting PDF to images: חוזה עלם.pdf
Converted 2 pages
Page 1: extracted 1247 chars
Page 2: extracted 983 chars
PDF processing complete: 2230 chars, 0.87 confidence
```

