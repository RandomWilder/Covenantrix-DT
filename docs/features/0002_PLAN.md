# Storage Location Migration - Technical Plan

## Brief Description

Update the LightRAG storage location configuration to use the user's home directory (`~/.covenantrix/rag_storage/` on Unix systems, `%USERPROFILE%\.covenantrix\rag_storage\` on Windows) instead of the backend directory. This change will isolate user data from the application installation directory, making the application suitable for distribution. The existing data will be manually moved to the new location, and the application will be configured to use the new storage path.

## Files and Functions to be Modified/Created

### Backend Configuration Changes

**Files to modify:**
- `backend/core/config.py` - Update default storage path to user directory
- `backend/core/dependencies.py` - No changes needed (uses config)
- `backend/infrastructure/storage/lightrag_storage.py` - No changes needed (uses config)
- `backend/infrastructure/storage/analytics_storage.py` - No changes needed (uses config)
- `backend/infrastructure/storage/document_registry.py` - No changes needed (uses config)
- `backend/infrastructure/storage/file_storage.py` - No changes needed (uses config)
- `backend/infrastructure/ai/rag_engine.py` - No changes needed (uses config)

**New functions to create:**
- `get_user_data_directory()` - Cross-platform user directory detection

### Desktop Application Changes

**Files to create:**
- `covenantrix-desktop/electron/storage-manager.js` - User directory management

**Files to modify:**
- `covenantrix-desktop/electron/main.js` - Initialize user data directory
- `covenantrix-desktop/electron/ipc-handlers.js` - Add storage management handlers
- `covenantrix-desktop/electron/preload.js` - Expose storage management APIs

### Environment and Deployment Changes

**Files to modify:**
- `covenantrix-desktop/electron-builder.yml` - Update app data directory configuration

## Algorithms and Implementation Details

### User Directory Detection Algorithm

1. **Cross-platform path resolution:**
   - Windows: `%USERPROFILE%\.covenantrix\rag_storage\`
   - macOS: `~/.covenantrix/rag_storage/`
   - Linux: `~/.covenantrix/rag_storage/`

2. **Directory structure creation:**
   ```
   ~/.covenantrix/rag_storage/
   ├── kv_store_*.json        # LightRAG kv files
   ├── vdb_*.json             # Vector database files
   ├── graph_*.graphml         # Graph files
   └── document_registry.json  # Document registry
   ```

### Configuration Update Algorithm

1. **Environment variable handling:**
   - Default to user directory if `STORAGE_WORKING_DIR` not set
   - Allow override via environment variable for development
   - Support relative paths (resolved from user directory)

2. **Directory creation:**
   - Ensure user directory is writable
   - Create directory structure if missing
   - Set appropriate permissions (700 on Unix, hidden on Windows)

## Implementation Phases

### Phase 1: Core Infrastructure (Data Layer)
- Implement user directory detection and creation
- Update configuration system to use user directories
- Update all storage classes to use new directory structure

### Phase 2: Desktop Application Integration (UI Layer)
- Implement user data directory management in Electron
- Update IPC handlers for storage management
- Create user-friendly directory initialization

### Phase 3: Manual Data Migration
- Manually move existing `backend/rag_storage/` to `~/.covenantrix/rag_storage/`
- Verify data integrity after manual migration
- Test application with new storage location

## Critical Implementation Details

### Storage Path Resolution
- Use `pathlib.Path` for cross-platform path handling
- Implement proper path expansion for `~` and environment variables
- Handle Windows vs Unix path separators correctly
- Ensure paths are absolute to avoid relative path issues

### Permission Management
- Ensure user directory has proper read/write permissions
- Handle cases where user directory cannot be created
- Provide clear error messages for permission issues
- Support running with different user privileges

### Manual Data Migration
- User will manually move `backend/rag_storage/` to `~/.covenantrix/rag_storage/`
- No automatic migration logic needed
- Simple directory copy operation
- Verify data integrity after manual move

## Files Requiring Specific Changes

### `backend/core/config.py`
- Add `get_user_data_directory()` function
- Update `storage_working_dir` default value to use user directory
- Implement cross-platform path resolution

### `covenantrix-desktop/electron/main.js`
- Add user directory initialization
- Add error handling for directory creation failures

### `covenantrix-desktop/electron/ipc-handlers.js`
- Add storage management IPC handlers
- Add storage directory validation

## Manual Migration Steps

1. **Stop the application** to ensure no files are in use
2. **Create user directory**: `mkdir -p ~/.covenantrix/rag_storage/` (Unix) or create `%USERPROFILE%\.covenantrix\rag_storage\` (Windows)
3. **Move existing data**: Copy all files from `backend/rag_storage/` to `~/.covenantrix/rag_storage/`
4. **Update configuration**: Deploy the updated code that uses the new storage location
5. **Start application**: Verify it works with the new storage location
6. **Clean up**: Remove the old `backend/rag_storage/` directory after verification

## Testing Requirements

- Test with fresh installations (no existing data)
- Test with manually migrated data
- Test cross-platform compatibility (Windows, macOS, Linux)
- Test permission handling and error scenarios
- Test data integrity after manual migration
