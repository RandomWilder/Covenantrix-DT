## Document-Scoped Query – Technical Plan

### Description
Implement document-scoped queries by filtering LightRAG retrieval to only the chunks that belong to user-selected documents. When no documents are selected, behavior remains unchanged (full knowledge base).

### Files and Functions to Add/Modify

- **New – `backend/infrastructure/ai/document_chunk_mapper.py`**
  - Provide a utility to map user document IDs (UUIDs) to LightRAG chunk IDs.
  - Input: list of user document IDs and the LightRAG storage path. Output: list of chunk IDs.
  - Read `document_registry.json` (user doc ID → content_hash) and `kv_store_doc_status.json` (LightRAG doc ID → chunks_list).
  - Compute LightRAG doc ID from the content hash using the same convention LightRAG uses.
  - Log mapping results and benign skips; raise on corrupted/missing storage when appropriate.

- **Modify – `backend/infrastructure/ai/rag_engine.py`**
  - `query(...)`: add `document_ids: Optional[List[str]] = None`.
    - If provided and non-empty: map to chunk IDs and pass via LightRAG `QueryParam(ids=...)`.
    - If empty/None: call LightRAG without `ids` (current behavior).
    - Add structured logs for FILTERED vs UNFILTERED queries.
  - `query_stream(...)`: same parameter and filtering logic, ensuring streaming uses the filtered context.

- **Modify – `backend/domain/chat/service.py`**
  - `send_message_stream(...)`: extract `selectedDocuments` from chat context and pass as `document_ids` to both streaming and non-streaming RAG calls.

- **Modify – `backend/domain/documents/service.py`**
  - `query_documents(...)`: add `document_ids: Optional[List[str]] = None`; forward to RAG engine; remove any warnings claiming filtering is unsupported; update docstring.

- **Modify – `backend/infrastructure/ai/agent_data_access.py`**
  - Update any `query_documents(...)` wrappers/usages to accept `document_ids` (default `None`) and pass through unchanged when not provided.

- **Modify – `backend/infrastructure/storage/lightrag_storage.py`**
  - `query_documents(...)`: add `document_ids` parameter and pass through to the RAG engine.

- **Frontend – `covenantrix-desktop/src/features/chat/ChatScreen.tsx`**
  - No API changes required; `selectedDocuments` already flows in chat context.
  - Optional: show an indicator of the active document scope (chips with selected doc names) and an "All documents" state when none selected.

### Algorithms and Data Flow

- **Mapping Chain**
  - User Document ID (UUID) → content_hash (from `document_registry.json`)
  - content_hash → LightRAG doc ID (deterministic format used by LightRAG)
  - LightRAG doc ID → `chunks_list` (from `kv_store_doc_status.json`)
  - Aggregate chunk IDs → pass to LightRAG `QueryParam(ids=...)`

- **LightRAG Doc ID Computation**
  - Derive LightRAG doc ID from the document content hash using LightRAG’s internal convention (prefix `doc-` with a consistent hash prefix). Validate by checking presence in `kv_store_doc_status.json` for existing docs.

### Control Flow Changes

- Backend chat receives `selectedDocuments` in the chat context.
- Chat service forwards `document_ids` into RAG engine calls for both streaming and non-streaming paths.
- RAG engine conditionally applies chunk filtering based on `document_ids`.
- LightRAG executes retrieval limited to provided chunk IDs when present.

### Error Handling (Backend)

- Invalid/missing user document ID in registry: log and skip; proceed with remaining IDs.
- Missing `kv_store_doc_status.json`: treat as uninitialized storage; raise a clear initialization error.
- Corrupted JSON: log with file path and raise a user-friendly exception.
- Empty chunk ID set after filtering: allow query to proceed; LightRAG returns empty results.

### Logging

- Mapper: log the number of input document IDs, resulting chunk count, and LightRAG doc IDs discovered.
- RAG Engine: log whether a query is FILTERED (with chunk count) or UNFILTERED.


