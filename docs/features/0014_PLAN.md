# Feature 0014: API Key Strict Mode Enhancement

## Description

Enhance the API key resolution system to enforce strict mode behavior with no automatic fallback between custom and default modes. The system will respect the user's explicit mode choice, gracefully disable features when keys are missing, and provide clear user guidance. Services (RAG/Chat, Cohere reranking, Google OCR) will initialize with available keys or remain disabled with visible status indicators.

**Core Principle:** One mode → One key source → No fallback

## Architecture Flow

### Startup Sequence
1. Load `.env` (system keys)
2. Load `user_settings.json` (user keys + mode preference)
3. Resolve keys using strict mode (no cross-mode fallback)
4. Initialize services with resolved keys or set to `None`
5. Features with missing keys remain disabled with clear messaging

### Key Resolution Algorithm
```
IF mode == "custom":
  → Check user_settings.json for key
  → Return key if exists, else None
  → NEVER check .env

IF mode == "default":
  → Check .env for key
  → Return key if exists, else None
  → NEVER check user_settings.json
```

### Settings Update Flow
1. User enters keys in settings UI
2. Validation on blur (per-key validation endpoint)
3. User clicks save
4. Backend validates ALL provided keys
5. Backend saves to `user_settings.json` (encrypted)
6. Backend reinitializes services with new keys
7. Frontend receives success → updates UI state
8. Frontend checks service status → updates feature availability

---

## File Changes

### Backend Core

#### `backend/core/api_key_resolver.py`
**Status:** Already implemented with strict mode
**Verification needed:**
- Confirm `_resolve_key()` method has no fallback logic between modes
- Ensure detailed logging is present for debugging
- Verify return type is `Optional[str]` with `None` when key unavailable

**Current Implementation Review:**
- Lines 88-136: `_resolve_key()` method correctly implements strict mode
- Custom mode: Returns user key or None (no fallback to system)
- Default mode: Returns fallback key or None (no fallback to user)
- Logging present at lines 117-122, 127-130

**Action:** No changes required - already correct

---

#### `backend/main.py`
**Status:** Already implements graceful degradation
**Current Implementation:**
- Lines 56-62: Resolves OpenAI key with strict mode
- Lines 64-68: Sets global `rag_engine = None` if no key available
- Lines 71-92: Initializes RAG engine if key exists, sets to `None` on failure
- Lines 94-96: Handles LightRAG unavailable scenario

**Action:** No changes required - already correct

---

#### `backend/api/routes/settings.py`
**Status:** Validation logic exists, needs verification
**Current Implementation:**
- Lines 29-62: `_validate_openai_key()` - performs format + API call validation
- Lines 65-95: `_validate_cohere_key()` - performs format + API call validation  
- Lines 98-116: `_validate_google_key()` - performs format validation only
- Lines 158-192: Custom mode validation blocks save on invalid keys
- Lines 219-277: `/api-keys/validate` endpoint for on-blur validation

**Action:** No changes required - validation already comprehensive

---

#### `backend/api/routes/chat.py`
**Status:** Guards already implemented
**Current Implementation:**
- Lines 41-47: Pre-operation check for OpenAI key (blocks if `None`)
- Lines 102-108: Same check for streaming endpoint
- Returns HTTP 400 with clear error message directing user to Settings

**Action:** No changes required - guards already in place

---

#### `backend/api/routes/documents.py`
**Status:** Guards already implemented
**Current Implementation:**
- Lines 48-55: Pre-operation check for OpenAI key in `/upload`
- Lines 128-134: Same check for `/upload/stream` 
- Returns HTTP 400 with clear error message directing user to Settings

**Action:** No changes required - guards already in place

---

#### `backend/core/dependencies.py`
**Status:** Review OCR service initialization
**Current Implementation:**
- Lines 40-48: `set_rag_engine()` accepts `Optional[RAGEngine]` including `None`
- Lines 101-119: `get_rag_engine()` raises HTTP 503 if `None` (NOT correct for optional checks)
- Lines 122-146: `get_ocr_service()` initializes with system key
- Lines 149-189: `update_ocr_service_with_user_settings()` handles custom mode with fallback

**Issues Found:**
1. `get_rag_engine()` raises exception when `None` - prevents optional access
2. OCR service doesn't use `api_key_resolver` for strict mode resolution

**Required Changes:**
1. Add helper function `rag_engine_available() -> bool` that checks if global instance is not `None`
2. Add helper function `ocr_service_available() -> bool` for OCR availability
3. Keep `get_rag_engine()` raising exception for required dependencies
4. Update OCR initialization to use `api_key_resolver` for strict mode

---

#### `backend/core/config.py`
**Status:** Documentation only
**Action:** Add comments explaining:
- This file provides system fallback keys only
- Actual key resolution happens in `api_key_resolver.py`
- System keys used only when mode is "default"

---

### Backend New Files

#### `backend/api/routes/services.py`
**Status:** NEW FILE REQUIRED
**Purpose:** Status endpoint for frontend service availability checks

**Endpoints:**

```python
@router.get("/status")
async def get_services_status():
    """Check availability of all services based on global state"""
    return {
        "openai_available": rag_engine_available(),
        "cohere_available": reranker_available(),
        "google_available": ocr_available(),
        "features": {
            "chat": rag_engine_available(),
            "upload": rag_engine_available(),
            "reranking": reranker_available(),
            "ocr": ocr_available()
        }
    }
```

**Helper Functions:**
- `rag_engine_available() -> bool`: Check if global RAG engine is not `None`
- `reranker_available() -> bool`: Check if Cohere configured in RAG engine
- `ocr_available() -> bool`: Check if OCR service is not `None`

---

### Frontend Core

#### `covenantrix-desktop/src/contexts/SettingsContext.tsx`
**Status:** Already has key status checking
**Current Implementation:**
- Lines 108-118: `validateApiKeys()` method calls backend validation
- Lines 120-141: `applySettings()` method applies settings and checks restart status

**Required Changes:**
1. Add service status state: `serviceStatus: ServiceStatus | null`
2. Add method `fetchServiceStatus()` to query `/services/status`
3. Call `fetchServiceStatus()` after successful settings save
4. Provide `serviceStatus` in context value

---

#### `covenantrix-desktop/src/features/settings/ApiKeysTab.tsx`
**Status:** Validation already implemented
**Current Implementation:**
- Validation on blur exists
- Shows validation errors per key type

**Action:** Verify all three key types (OpenAI, Cohere, Google) have:
- On-blur validation
- Clear error messages
- Warning messages for missing optional keys
- Service-specific feature impact messaging

---

#### `covenantrix-desktop/src/features/chat/ChatScreen.tsx`
**Status:** Needs service availability guards
**Required Changes:**
1. Import `useServiceStatus()` hook
2. Check `openaiAvailable` on mount
3. If unavailable, render banner:
   - "⚠️ Chat Disabled - OpenAI API key not configured"
   - Link/button to open Settings → API Keys tab
4. Disable input field when unavailable

---

#### `covenantrix-desktop/src/features/upload/UploadScreen.tsx`
**Status:** Needs service availability guards
**Required Changes:**
1. Import `useServiceStatus()` hook
2. Check `openaiAvailable` on mount
3. If unavailable, render banner:
   - "⚠️ Upload Disabled - OpenAI API key not configured"
   - Link/button to open Settings → API Keys tab
4. Disable upload button when unavailable

---

### Frontend New Files

#### `covenantrix-desktop/src/hooks/useServiceStatus.ts`
**Status:** Already exists!
**File Location:** `covenantrix-desktop/src/hooks/useApiKeyStatus.ts`
**Current Implementation:** Checks OpenAI key status only

**Required Changes:**
1. Rename to `useServiceStatus.ts` for broader scope
2. Update to call `/services/status` endpoint instead of `/settings/key-status`
3. Return status for all services (OpenAI, Cohere, Google)
4. Return feature availability (chat, upload, reranking, ocr)

**Interface:**
```typescript
export interface UseServiceStatusReturn {
  openaiAvailable: boolean;
  cohereAvailable: boolean;
  googleAvailable: boolean;
  features: {
    chat: boolean;
    upload: boolean;
    reranking: boolean;
    ocr: boolean;
  };
  isLoading: boolean;
  error: string | null;
  refreshStatus: () => Promise<void>;
}
```

---

#### `covenantrix-desktop/src/types/services.ts`
**Status:** NEW FILE REQUIRED
**Purpose:** TypeScript types for service status

**Types:**
```typescript
export interface ServiceStatus {
  openai_available: boolean;
  cohere_available: boolean;
  google_available: boolean;
  features: {
    chat: boolean;
    upload: boolean;
    reranking: boolean;
    ocr: boolean;
  };
}

export interface ServiceFeatureGuard {
  available: boolean;
  message: string;
  actionText: string;
  actionRoute: string;
}
```

---

### Frontend Updates Required

#### `covenantrix-desktop/src/types/global.d.ts`
**Status:** Update IPC interface
**Required Changes:**
Add new IPC method:
```typescript
getServicesStatus: () => Promise<ServiceStatusResponse>;
```

#### `covenantrix-desktop/electron/preload.js`
**Status:** Add IPC bridge
**Required Changes:**
Add to exposed API:
```javascript
getServicesStatus: () => ipcRenderer.invoke('services:status')
```

#### `covenantrix-desktop/electron/ipc-handlers.js`
**Status:** Add IPC handler
**Required Changes:**
Add handler:
```javascript
ipcMain.handle('services:status', async () => {
  const response = await axios.get(`${API_URL}/services/status`);
  return response.data;
});
```

---

## Validation Rules

### Default Mode
- Save **always succeeds** (even with no keys provided)
- No validation required on save
- Show informational messages about disabled features
- System admin manages `.env` keys externally

### Custom Mode
- Validate **only keys provided by user** (not required fields)
- Block save if **any provided key is invalid** (HTTP 400)
- Allow partial configs (e.g., only OpenAI, no Cohere/Google)
- Show warnings for missing optional keys (non-blocking)

### Per-Key Validation
- **OpenAI:** Format check (`sk-*`, length > 20) + API call (`embeddings.create`)
- **Cohere:** Format check (length > 20) + API call (`check_api_key()`)
- **Google:** Format check only (length > 20) - API validation complex for Cloud

---

## Error Messaging

### Feature Disabled Messages

**No OpenAI Key:**
```
⚠️ Chat and Upload Disabled

OpenAI API key not configured. Configure your API key in 
Settings → API Keys to enable these features.

[Go to Settings]
```

**No Cohere Key:**
```
ℹ️ Response Reranking Disabled

Cohere API key not configured. Responses will not be reranked 
for relevance. Configure Cohere key in Settings for better results.

[Go to Settings]
```

**No Google Key:**
```
ℹ️ OCR Disabled

Google Vision API key not configured. Image documents cannot 
be processed. Configure Google key in Settings to enable OCR.

[Go to Settings]
```

### Validation Error Messages

**Invalid OpenAI Key:**
```
❌ Invalid OpenAI API Key

The provided key is not valid. Please check and try again.
Ensure key starts with 'sk-' and is properly copied.
```

**Invalid Cohere Key:**
```
❌ Invalid Cohere API Key

The provided key is not valid. Please check and try again.
```

**Invalid Google Key:**
```
❌ Invalid Google API Key Format

The provided key format is invalid. Please check and try again.
```

---

## Implementation Summary

### Files to Modify (10)
1. `backend/core/dependencies.py` - Add availability helpers, fix OCR resolution
2. `backend/core/config.py` - Add documentation comments
3. `covenantrix-desktop/src/contexts/SettingsContext.tsx` - Add service status state
4. `covenantrix-desktop/src/features/settings/ApiKeysTab.tsx` - Verify all validations
5. `covenantrix-desktop/src/features/chat/ChatScreen.tsx` - Add feature guards
6. `covenantrix-desktop/src/features/upload/UploadScreen.tsx` - Add feature guards
7. `covenantrix-desktop/src/types/global.d.ts` - Add services status IPC
8. `covenantrix-desktop/electron/preload.js` - Add services status bridge
9. `covenantrix-desktop/electron/ipc-handlers.js` - Add services status handler
10. `covenantrix-desktop/src/hooks/useApiKeyStatus.ts` - Rename and expand to all services

### New Files (2)
1. `backend/api/routes/services.py` - Service status endpoint
2. `covenantrix-desktop/src/types/services.ts` - Service status types

### No Changes Required (5)
1. `backend/core/api_key_resolver.py` - Already correct
2. `backend/main.py` - Already correct
3. `backend/api/routes/settings.py` - Already correct
4. `backend/api/routes/chat.py` - Already correct
5. `backend/api/routes/documents.py` - Already correct

---

## Implementation Order

1. **Backend: Service Status Endpoint** - Create status route and helpers
2. **Backend: Dependencies Update** - Add availability helpers, fix OCR
3. **Frontend: Service Status Hook** - Rename and expand useApiKeyStatus
4. **Frontend: IPC Layer** - Add service status IPC bridge
5. **Frontend: Settings Context** - Add service status state and fetching
6. **Frontend: Feature Guards** - Add guards to chat and upload screens
7. **Frontend: Settings UI** - Verify validation messaging
8. **Testing** - Verify all scenarios work correctly

---

## Testing Scenarios

### Scenario 1: Default Mode - No System Keys
- Backend starts with `rag_engine = None`
- Chat/Upload disabled with clear messaging
- Settings allow switching to custom mode

### Scenario 2: Default Mode - System Keys Present
- Backend starts with system keys
- All features enabled
- Settings show "Using system keys"

### Scenario 3: Custom Mode - Valid Custom Keys
- User enters custom keys in Settings
- Validation passes on blur
- Save succeeds, services reload
- All features enabled with custom keys

### Scenario 4: Custom Mode - Invalid Custom Keys
- User enters invalid key in Settings
- Validation fails on blur with clear error
- Save blocked with validation error
- User corrects key, save succeeds

### Scenario 5: Custom Mode - Partial Keys
- User provides only OpenAI key (no Cohere/Google)
- Save succeeds (partial config allowed)
- Chat/Upload enabled
- Reranking/OCR disabled with info messages

### Scenario 6: Mode Switch - Default to Custom
- User switches mode to custom without entering keys
- Save succeeds
- All features disabled (custom mode has no keys)
- Clear messaging to configure custom keys

### Scenario 7: Mode Switch - Custom to Default
- User switches mode to default
- Save succeeds
- System keys take effect immediately
- Features availability based on system keys

---

## Key Architectural Decisions

### 1. Strict Mode Enforcement
- **Location:** `backend/core/api_key_resolver.py`
- **Logic:** User's explicit mode choice is absolute - no cross-mode fallback
- **Rationale:** Prevents confusion, respects user intent

### 2. Service Graceful Degradation
- **Location:** `backend/main.py` lifespan
- **Logic:** Missing key → service = `None` → features disabled
- **Rationale:** App remains usable with partial configuration

### 3. Validation Strategy
- **Location:** `backend/api/routes/settings.py`
- **Logic:** Validate provided keys only, allow partial configs
- **Rationale:** Don't force users to configure everything at once

### 4. Frontend Guard Pattern
- **Location:** Chat/Upload screens
- **Logic:** Check status → show banner → disable features
- **Rationale:** Clear user guidance instead of silent failures

### 5. Status as Source of Truth
- **Location:** `backend/api/routes/services.py`
- **Logic:** Single endpoint, queried on demand
- **Rationale:** Avoid state sync issues, frontend polls when needed

### 6. Global State Management
- **Location:** `backend/core/dependencies.py`
- **Logic:** Single RAG engine instance set at startup
- **Rationale:** Consistent behavior, clear lifecycle management
