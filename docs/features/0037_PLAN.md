# Technical Plan: Session vs Conversation Terminology Alignment & UI Data Staleness Fix

## Context
Fix semantic confusion between "session" (app lifecycle) and "conversation" (chat thread) in the usage tracking system. Currently, the system creates a new "session" for every chat message, which is incorrect. Additionally, fix UI data staleness where the subscription context shows outdated query counts.

### Terminology Definitions:
- **Session**: Application lifecycle from startup to shutdown/timeout (30+ minutes of inactivity)
- **Conversation**: A chat thread containing multiple back-and-forth queries/responses (already correctly implemented in chat system)
- **Query**: A single user question/message sent via chat interface (what we count and limit per tier)

## Phase 1: Backend Session Tracking Refactor

### Goal: Remove incorrect per-message session creation and align with app-level session tracking

#### 1.1 Remove Session Tracking from Chat Message Flow
**File:** `backend/api/routes/chat.py`

Current problematic code (lines ~85-130):
```python
session_id = str(uuid.uuid4())  # Creates new session per message
await subscription_service.usage_tracker.start_session(session_id, tier)
# ... message processing ...
await subscription_service.usage_tracker.end_session(session_id)
```

**Changes needed:**
- Remove `session_id = str(uuid.uuid4())` line
- Remove `await subscription_service.usage_tracker.start_session(session_id, tier)` call
- Remove `await subscription_service.usage_tracker.end_session(session_id)` call
- Remove all `await subscription_service.usage_tracker.end_session(session_id)` calls in error handlers

**Keep only:**
- Query limit checks (`check_query_allowed()`)
- Query recording (`record_query()`) - but remove session_id parameter

#### 1.2 Update Query Recording to Not Require Session ID
**File:** `backend/infrastructure/storage/usage_tracker.py`
**Method:** `record_query()` (lines ~150-180)

**Changes:**
- Make session_id parameter truly optional (currently required in practice)
- Remove the call to `increment_session_queries()` when session_id is provided
- Update method signature to make clear session_id is deprecated:

```python
async def record_query(
    self, 
    tier: str, 
    session_id: Optional[str] = None,  # Deprecated, kept for backward compatibility
    query_type: Optional[str] = None,
    success: bool = True,
    tokens_used: Optional[int] = None
) -> bool:
```

- Add deprecation warning if session_id is provided

#### 1.3 Update Queries Route
**File:** `backend/api/routes/queries.py`
Similar changes as chat.py:
- Remove any session_id generation
- Remove start_session() and end_session() calls
- Update record_query() call to not pass session_id

Locate around lines 30-80 where query processing occurs.

#### 1.4 Mark Session Methods as Deprecated
**File:** `backend/infrastructure/storage/usage_tracker.py`
**Methods to deprecate** (keep for backward compatibility but log warnings):
- `start_session()` (line ~290)
- `end_session()` (line ~310)
- `increment_session_queries()` (line ~330)

**Changes:**
- Add deprecation log warnings at start of each method
- Add docstring note: "DEPRECATED: Session tracking moved to application level"

#### 1.5 Update Session Analytics to Use Conversation Data
**File:** `backend/infrastructure/storage/usage_tracker.py`
**Method:** `get_session_analytics()` (line ~350)

**Changes:**
- Add comment explaining sessions are deprecated
- Return zero values for backward compatibility:

```python
return {
    "sessions_count": 0,
    "avg_queries_per_session": 0.0,
    "avg_session_duration_minutes": 0.0
}
```

- Keep method for API compatibility but mark as deprecated

#### 1.6 Update Analytics Endpoint
**File:** `backend/api/routes/subscription.py`
**Endpoint:** `GET /analytics` (around line 180)

**Changes:**
- Update to return conversation-based metrics instead of session metrics
- Calculate conversations_last_30_days from chat storage instead of usage_tracker sessions
- Keep API response structure compatible but change data source

**New calculation logic:**
```python
# Get conversations from chat storage
from core.dependencies import get_chat_service
chat_service = get_chat_service()
conversations = await chat_service.list_conversations()

# Filter last 30 days
cutoff_date = datetime.utcnow() - timedelta(days=30)
recent_conversations = [c for c in conversations if c.updated_at >= cutoff_date]

# Calculate metrics
conversations_count = len(recent_conversations)
total_queries = sum(len(c.messages) // 2 for c in recent_conversations)  # User messages only
avg_queries_per_conversation = total_queries / conversations_count if conversations_count > 0 else 0
```

## Phase 2A: Backend - Conversation-Based Analytics

### Goal: Replace session analytics with conversation analytics using existing chat storage

#### 2A.1 Create Conversation Analytics Method
**File:** `backend/infrastructure/storage/usage_tracker.py`
**New method to add after deprecated session methods:**

```python
async def get_conversation_analytics(self, days: int = 30) -> Dict[str, Any]:
    """
    Get conversation-based analytics
    Uses chat storage to calculate real conversation metrics
    
    Args:
        days: Number of days to analyze
        
    Returns:
        Analytics based on actual conversations
    """
```

**Algorithm:**
1. Import chat service from dependencies
2. Get all conversations from chat storage
3. Filter conversations with updated_at >= cutoff_date (now - days)
4. Calculate:
   - Total conversation count
   - Average queries per conversation (count user messages / conversation count)
   - Active conversations (conversations with messages in period)
5. Return dict with metrics

#### 2A.2 Update Analytics Response Schema
**File:** `backend/api/routes/subscription.py`
**Class:** `AnalyticsResponse` (around line 60)

**Changes:**
- Rename field from `sessions_last_30_days` to `conversations_last_30_days`
- Rename field from `avg_queries_per_session` to `avg_queries_per_conversation`
- Keep old field names as deprecated aliases for backward compatibility

## Phase 2B: Frontend - UI Data Staleness Fix

### Goal: Ensure UI always shows fresh data from usage_tracking.json after queries

#### 2B.1 Add Context Refresh After Queries
**File:** `covenantrix-desktop/src/contexts/SubscriptionContext.tsx`
**Current method:** `loadSubscription()` (around line 30)

**Changes:**
- Make method public in context value export
- Rename to `refreshSubscription()` for clarity
- Add to context interface:

```typescript
export interface SubscriptionContextValue {
  // ... existing fields
  refreshSubscription: () => Promise<void>;  // NEW
}
```

#### 2B.2 Trigger Refresh After Chat Messages
**File:** `covenantrix-desktop/src/features/chat/ChatPanel.tsx`
**Locate:** Message send handler (search for sendMessage or similar)

**Changes:**
- Import useSubscription hook
- Call refreshSubscription() after successful message send:

```typescript
const { refreshSubscription } = useSubscription();

// After successful message send
await sendMessageToBackend(...);
await refreshSubscription();  // Refresh usage stats
```

#### 2B.3 Update Analytics Dashboard Terminology
**File:** `covenantrix-desktop/src/features/subscription/AnalyticsDashboard.tsx`
**Changes at line ~70-80:**
- Replace "Sessions (30 days)" with "Conversations (30 days)"
- Replace "Avg Queries/Session" with "Avg Queries/Conversation"
- Update variable names:
  - `analytics.sessions_last_30_days` → `analytics.conversations_last_30_days`
  - `analytics.avg_queries_per_session` → `analytics.avg_queries_per_conversation`

#### 2B.4 Update TypeScript Interfaces
**File:** `covenantrix-desktop/src/types/subscription.ts`
**Interface:** `SubscriptionAnalytics` (around line 50)

**Changes:**
- Rename `sessions_last_30_days: number` to `conversations_last_30_days: number`
- Rename `avg_queries_per_session: number` to `avg_queries_per_conversation: number`
- Add deprecated aliases for backward compatibility during transition

#### 2B.5 Add Automatic Refresh on Tab Focus
**File:** `covenantrix-desktop/src/features/subscription/SubscriptionTab.tsx`
**Add effect around line 40:**

```typescript
useEffect(() => {
  // Refresh data when tab becomes visible
  const handleVisibilityChange = () => {
    if (!document.hidden) {
      loadAnalyticsData();
    }
  };
  
  document.addEventListener('visibilitychange', handleVisibilityChange);
  return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
}, []);
```

#### 2B.6 Fix Current Tier Card Data Source
**File:** `covenantrix-desktop/src/features/subscription/SubscriptionTab.tsx`
**Locate:** "Current Plan" card rendering (around line 150-180)

**Verify data binding:**
- Ensure card uses `usage?.queries_today` from subscription context
- Ensure context value comes from GET /subscription/status API
- Add data refresh on component mount
- Add console logging to debug stale data:

```typescript
console.log('Usage data:', usage);
console.log('Daily queries:', usage?.queries_today);
```

## Phase 3: Verification & Cleanup

#### 3.1 Add Logging for Data Flow Tracking
**Files:**
- `backend/api/routes/chat.py`
- `backend/api/routes/queries.py`
- `backend/domain/subscription/service.py`

**Add debug logs:**
- Before query recording: Log tier and current counts
- After query recording: Log updated counts
- In subscription status endpoint: Log returned usage data

#### 3.2 Remove Obsolete Session Data from JSON
**File:** `backend/infrastructure/storage/usage_tracker.py`
**Method:** `_initialize_storage()` (line ~40)

**Changes:**
- Remove `analytics.sessions[]` array from default data structure
- Keep `tier_upgrade_signals` only
- Update schema version from "1.1" to "1.2"

#### 3.3 Add Migration for Existing Files
**File:** `backend/infrastructure/storage/usage_tracker.py`
**Method:** `_migrate_schema()` (line ~100)

**Add migration case:**
```python
# Migrate from 1.1 to 1.2: Remove sessions array
if data.get("version") == "1.1":
    if "sessions" in data.get("analytics", {}):
        # Backup session count for reference
        session_count = len(data["analytics"]["sessions"])
        logger.info(f"Removing {session_count} deprecated session records")
        data["analytics"]["sessions"] = []
    data["version"] = "1.2"
```

## Critical Algorithms

### Algorithm 1: Conversation Analytics Calculation
**Purpose:** Replace session-based analytics with conversation-based analytics

**Steps:**
1. Load all conversations from chat storage
2. Filter conversations where updated_at >= (now - 30 days)
3. For each conversation:
   - Count user messages (role == "user")
   - Count assistant messages (role == "assistant")
4. Calculate metrics:
   - conversations_count = filtered conversations length
   - total_queries = sum of user messages across all conversations
   - avg_queries_per_conversation = total_queries / conversations_count (handle division by zero)
5. Return analytics dict

### Algorithm 2: Context Refresh Flow
**Purpose:** Ensure UI always shows latest data after user actions

**Steps:**
1. User sends chat message
2. Frontend calls backend chat endpoint
3. Backend records query in usage_tracking.json
4. Backend returns response
5. Frontend receives response
6. Frontend calls refreshSubscription() in context
7. Context calls GET /subscription/status API
8. Backend reads fresh data from usage_tracking.json
9. Context updates state with new data
10. All components using context re-render with fresh data

## Files Summary

### Backend Files Modified (6):
- `backend/api/routes/chat.py` - Remove session creation/tracking
- `backend/api/routes/queries.py` - Remove session creation/tracking
- `backend/infrastructure/storage/usage_tracker.py` - Deprecate session methods, add conversation analytics, update schema
- `backend/api/routes/subscription.py` - Update analytics endpoint to use conversations
- `backend/api/schemas/subscription.py` - Rename analytics response fields
- `backend/domain/subscription/service.py` - Add logging for data flow

### Frontend Files Modified (5):
- `covenantrix-desktop/src/contexts/SubscriptionContext.tsx` - Add refreshSubscription method
- `covenantrix-desktop/src/features/chat/ChatPanel.tsx` - Call refresh after messages
- `covenantrix-desktop/src/features/subscription/AnalyticsDashboard.tsx` - Update terminology
- `covenantrix-desktop/src/features/subscription/SubscriptionTab.tsx` - Add auto-refresh, verify data binding
- `covenantrix-desktop/src/types/subscription.ts` - Update interfaces

### Files Created (0):
No new files needed
