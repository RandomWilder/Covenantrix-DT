# Feature 0038: Simplified JWT Tier Transition Flows

## Overview

Implement a simplified JWT-based subscription system where JWT tokens contain only tier information, and all feature limits are defined in a single `TIER_LIMITS` configuration. This eliminates JWT feature overrides and creates a single source of truth for subscription limits.

## Core Design Principle

**JWT validates tier only. TIER_LIMITS defines all features.**

- JWT payload: `{tier, issued, expiry, license_id}`
- NO features in JWT
- Limits pulled from `TIER_LIMITS[tier]` config
- Single source of truth for all tier limits

## Current System Analysis

### Backend Architecture
- **JWT Structure**: Currently includes features in JWT payload
- **Feature Override**: `get_tier_features()` accepts `jwt_features` parameter for overrides
- **Storage**: Features stored in `user_settings.json` subscription section
- **API Response**: Features included in all subscription endpoints

### Frontend Dependencies
- **SubscriptionContext**: Reads `subscription.features` directly from storage
- **SubscriptionTab**: Displays limits from `subscription.features`
- **useUpload**: Validates file size against `subscription.features.max_doc_size_mb`
- **API Integration**: Expects features in API responses

## Required Changes

### Phase 1: Backend JWT Simplification

#### 1.1 Update JWT Structure
**File:** `backend/domain/subscription/license_validator.py`

**Changes:**
- Remove `features` field from JWT validation
- Update `required_fields` to: `["tier", "issued", "expiry", "license_id"]`
- Remove feature extraction logic from `extract_tier_info()`
- Update `generate_test_token()` to exclude features

**JWT Payload (New):**
```json
{
  "tier": "paid",
  "issued": 1729334400000,
  "expiry": 1760870400000,
  "license_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

#### 1.2 Simplify Tier Configuration
**File:** `backend/domain/subscription/tier_config.py`

**Changes:**
- Remove `jwt_features` parameter from `get_tier_features()`
- Remove JWT override logic
- Make function purely config-based

**New Function Signature:**
```python
def get_tier_features(tier: str) -> Dict[str, Any]:
    """Get tier features from config only"""
    if tier not in TIER_LIMITS:
        raise ValueError(f"Invalid tier: {tier}")
    return TIER_LIMITS[tier]
```

#### 1.3 Update Subscription Service
**File:** `backend/domain/subscription/service.py`

**Changes:**
- Remove JWT feature extraction in `transition_tier()`
- Update `activate_license()` to compute features from tier only
- Remove `jwt_features` parameter from `get_tier_features()` calls
- Ensure all feature access goes through `get_tier_features(tier)`

#### 1.4 Update API Responses
**File:** `backend/api/routes/subscription.py`

**Changes:**
- Ensure all endpoints compute features from tier
- Maintain API response structure for frontend compatibility
- Add feature computation in `get_subscription_status()`

**Implementation Pattern:**
```python
@router.get("/status")
async def get_subscription_status():
    subscription = await subscription_service.get_current_subscription_async()
    
    # Compute features from tier
    computed_features = get_tier_features(subscription.tier)
    
    return {
        "tier": subscription.tier,
        "features": computed_features,  # Always computed, never stored
        # ... other fields
    }
```

### Phase 2: Frontend Feature Computation

#### 2.1 Create Tier Limits Helper
**File:** `covenantrix-desktop/src/utils/tierLimits.ts` (NEW)

**Purpose:** Client-side copy of `TIER_LIMITS` for feature computation

```typescript
export const TIER_LIMITS = {
  trial: { max_documents: 3, max_doc_size_mb: 10, ... },
  free: { max_documents: 3, max_doc_size_mb: 10, ... },
  paid: { max_documents: -1, max_doc_size_mb: 100, ... },
  paid_limited: { max_documents: 3, max_doc_size_mb: 10, ... }
};

export const getTierLimits = (tier: string): FeatureFlags => {
  return TIER_LIMITS[tier] || TIER_LIMITS.free;
};
```

#### 2.2 Update SubscriptionContext
**File:** `covenantrix-desktop/src/contexts/SubscriptionContext.tsx`

**Changes:**
- Replace `subscription.features` access with `getTierLimits(subscription.tier)`
- Update `canUploadDocument()` to use computed features
- Update `canSendQuery()` to use computed features
- Update `getRemainingQuota()` to use computed features

**Before:**
```typescript
const { max_documents } = subscription.features;
```

**After:**
```typescript
const { max_documents } = getTierLimits(subscription.tier);
```

#### 2.3 Update SubscriptionTab
**File:** `covenantrix-desktop/src/features/subscription/SubscriptionTab.tsx`

**Changes:**
- Replace all `subscription.features` references with computed features
- Use `getTierLimits(subscription.tier)` for display

**Before:**
```typescript
{subscription.features.max_documents === -1 ? '∞' : subscription.features.max_documents}
```

**After:**
```typescript
{getTierLimits(subscription.tier).max_documents === -1 ? '∞' : getTierLimits(subscription.tier).max_documents}
```

#### 2.4 Update useUpload Hook
**File:** `covenantrix-desktop/src/hooks/useUpload.ts`

**Changes:**
- Replace `subscription.features.max_doc_size_mb` with computed value
- Use `getTierLimits(subscription.tier).max_doc_size_mb`

### Phase 3: Storage Schema Updates (Optional)

#### 3.1 Remove Features from Storage
**File:** `backend/api/schemas/settings.py`

**Option A: Remove entirely**
```python
class SubscriptionSettings(BaseModel):
    tier: str
    license_key: Optional[str]
    trial_started_at: Optional[str]
    trial_expires_at: Optional[str]
    grace_period_started_at: Optional[str]
    grace_period_expires_at: Optional[str]
    # NO features field
```

**Option B: Keep as computed property (recommended)**
```python
class SubscriptionSettings(BaseModel):
    # ... existing fields ...
    
    @property
    def features(self) -> FeatureFlags:
        """Computed from tier"""
        return FeatureFlags(**get_tier_features(self.tier))
```

## Tier Transition Flows Implementation

### 3.1 Trial → Free (Expiry)
**Trigger:** 7 days pass, app startup

**Implementation:**
- Check `trial_expires_at < now()` in `check_tier_expiry()`
- Transition to "free" tier
- Clear trial dates
- Force `api_keys.mode = "custom"`
- Apply `TIER_LIMITS["free"]` features

### 3.2 Paid → Paid_Limited (JWT Expiry)
**Trigger:** Paid JWT expires, app startup

**Implementation:**
- Validate JWT on startup
- If expired, transition to "paid_limited"
- Set grace period dates (7 days)
- Remove expired license_key
- Apply `TIER_LIMITS["paid_limited"]` features

### 3.3 Paid_Limited → Free (Grace Expiry)
**Trigger:** 7 days pass after grace period

**Implementation:**
- Check `grace_period_expires_at < now()`
- Transition to "free" tier
- Delete documents beyond first 3
- Clear grace period dates
- Apply `TIER_LIMITS["free"]` features

### 3.4 License Activation (Any → Paid)
**Trigger:** User activates valid JWT

**Implementation:**
- Validate JWT signature and expiry
- Extract tier from JWT
- Update subscription tier
- Store license_key
- Clear trial/grace dates
- Apply `TIER_LIMITS[tier]` features

## Implementation Phases

### Phase 1: Backend Changes (Breaking Changes)
1. Update JWT structure to remove features
2. Simplify `get_tier_features()` function
3. Update subscription service methods
4. Ensure API responses compute features
5. Test JWT validation and tier transitions

### Phase 2: Frontend Changes (Dependent on Backend)
1. Create `tierLimits.ts` utility
2. Update `SubscriptionContext` to use computed features
3. Update `SubscriptionTab` to use computed features
4. Update `useUpload` hook to use computed features
5. Test UI displays correct limits

### Phase 3: Storage Cleanup (Optional)
1. Remove features from storage schema
2. Update migration logic
3. Verify backward compatibility
4. Test with existing user data

## Testing Strategy

### Backend Testing
- JWT validation with new structure
- Tier transition flows
- Feature computation from tier
- API response compatibility

### Frontend Testing
- UI displays correct limits
- Upload validation works
- Query limits enforced
- Subscription status updates

### Integration Testing
- End-to-end tier transitions
- License activation flows
- Grace period handling
- Document deletion on downgrade

## Migration Safety

### Zero-Downtime Migration
1. Backend continues returning features in API (computed)
2. Frontend updated to use computed features
3. Remove features from storage (optional)
4. Verify all enforcement still works

### Rollback Plan
- Features in storage can be restored without code changes
- JWT structure can be reverted if needed
- API responses maintain compatibility

## Benefits

✅ **Single Source of Truth:** TIER_LIMITS defines everything  
✅ **No JWT Abuse:** Can't forge custom limits  
✅ **Better UX:** No manual downgrade required  
✅ **Simpler Code:** Less complexity in validation  
✅ **SaaS Standard:** Tier determines features, not tokens  
✅ **Easy Updates:** Change limits in config, affects all users  
✅ **Grace Period UX:** 7-day buffer before hard downgrade
