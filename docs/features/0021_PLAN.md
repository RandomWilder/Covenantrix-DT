# Feature 0021: Production API Keys via GitHub Secrets

## Brief Description

Inject production API keys into the application during the GitHub Actions build process. Currently, the application ships without default API keys in the `.env` file, requiring all users to provide their own keys. This feature will bundle production keys securely via GitHub Secrets, allowing the application to work out-of-the-box with default keys while preserving the existing custom key functionality.

## Files to Modify

### `.github/workflows/build.yml`
Add a new step before the "Build Electron App" step (after "Test Backend" and before line 188) to create a production `.env` file from GitHub Secrets.

### `.gitignore` (verify only)
Ensure `backend/.env` is already in `.gitignore` to prevent accidental commits of the production keys file.

## Implementation Details

### GitHub Secrets Setup (Manual - User Action Required)

In GitHub repository settings (Settings → Secrets and variables → Actions → New repository secret), add the following 5 secrets:

1. **Secret Name**: `PROD_OPENAI_API_KEY`
   - **Value**: Your production OpenAI API key

2. **Secret Name**: `PROD_COHERE_API_KEY`
   - **Value**: Your production Cohere API key

3. **Secret Name**: `PROD_GOOGLE_API_KEY`
   - **Value**: Your production Google Cloud API key (for Vision OCR)

4. **Secret Name**: `PROD_GOOGLE_CLIENT_ID`
   - **Value**: Your production Google OAuth client ID (for Google Drive integration)

5. **Secret Name**: `PROD_GOOGLE_CLIENT_SECRET`
   - **Value**: Your production Google OAuth client secret (for Google Drive integration)

### Build Workflow Modification

Add a new step in `.github/workflows/build.yml` after the "Test Backend" step (approximately after line 184) and before the "Build Electron App" step (line 188):

**Step Name**: "Inject Production API Keys"

**Logic**:
1. Create `backend/.env` file dynamically during the build
2. Populate it with the 5 production keys/credentials from GitHub Secrets
3. Include other necessary environment variables (e.g., `ENVIRONMENT=production`)
4. This file will be bundled into `extraResources/backend/` automatically by electron-builder

**Environment Variable Mapping**:
```
OPENAI_API_KEY=${{ secrets.PROD_OPENAI_API_KEY }}
COHERE_API_KEY=${{ secrets.PROD_COHERE_API_KEY }}
GOOGLE_API_KEY=${{ secrets.PROD_GOOGLE_API_KEY }}
GOOGLE_CLIENT_ID=${{ secrets.PROD_GOOGLE_CLIENT_ID }}
GOOGLE_CLIENT_SECRET=${{ secrets.PROD_GOOGLE_CLIENT_SECRET }}
ENVIRONMENT=production
```

**Platform Compatibility**: Use shell-agnostic approach (bash heredoc syntax) that works on both Windows and macOS runners.

## How It Works

1. **Build time**: GitHub Actions injects secrets into `backend/.env`
2. **Packaging**: electron-builder copies `backend/.env` to `extraResources/backend/` (already configured in `electron-builder.yml` lines 124-130)
3. **Runtime**: `backend-manager.js` loads `.env` file (lines 188-198) and passes variables to Python process environment
4. **Backend**: `config.py` reads environment variables via pydantic-settings (lines 50-59)
5. **Key resolution**: `api_key_resolver.py` uses these as system defaults when user is in "default" mode

## Custom Keys Functionality

**No changes required**. The existing custom key system remains completely independent:
- Users can still switch to "custom" mode and provide their own keys
- Custom keys are stored encrypted in `user_settings.json` via `UserSettingsStorage`
- API key resolution in `api_key_resolver.py` already handles both modes with strict separation

## Security Notes

- Keys are bundled in the Electron app and can be extracted by determined users
- This is acceptable for "default keys" that provide basic functionality
- Production keys should have usage limits/quotas configured at the provider level
- Consider monitoring usage for anomalies
- Custom keys remain the recommended approach for power users

## Testing

After implementation:
1. Trigger a build by pushing a version tag
2. Download the installer from GitHub Releases
3. Install and launch the app
4. Verify the app works without configuring custom keys (default mode)
5. Verify custom keys functionality still works when switching to custom mode

