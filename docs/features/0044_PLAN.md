# Timestamp Standardization Plan

## Description

Standardize timestamp handling across the entire application to use UTC timestamps consistently. The current issue shows timestamps appearing 3 hours behind local time, causing user confusion in chat history and other time-sensitive features. This plan implements full alignment using `datetime.utcnow()` in the backend and proper timezone handling in the frontend.

## Phase 1: Backend Standardization

### Files to Modify

**backend/domain/notifications/service.py**
- Line 51: Change `timestamp=datetime.now()` to `timestamp=datetime.utcnow()`
- Line 100: Change `cutoff_date = datetime.now() - timedelta(days=7)` to `cutoff_date = datetime.utcnow() - timedelta(days=7)`

**backend/api/routes/notifications.py**
- Line 109: Change `cutoff_date = datetime.now() - timedelta(days=7)` to `cutoff_date = datetime.utcnow() - timedelta(days=7)`

**backend/main.py**
- Line 166: Change `cutoff_date = datetime.now() - timedelta(days=7)` to `cutoff_date = datetime.utcnow() - timedelta(days=7)`

**backend/infrastructure/storage/user_settings_storage.py**
- Line 362: Change `timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")` to `timestamp = datetime.utcnow().strftime("%Y%m%d_%H%M%S")`

**backend/infrastructure/external/google_vision_ocr.py**
- Lines 139, 204: Change `datetime.now()` to `datetime.utcnow()` for processing time calculations

**backend/infrastructure/external/google_vision_client.py**
- Lines 114, 137, 169, 192, 225, 248, 617, 622: Change `datetime.now()` to `datetime.utcnow()` for processing time calculations

### Algorithm
1. Replace all `datetime.now()` calls with `datetime.utcnow()` in the backend
2. Ensure all timestamp creation uses UTC consistently
3. Maintain existing ISO format for API responses

## Phase 2: Frontend Date Utility Creation

### Files to Create

**covenantrix-desktop/src/utils/dateUtils.ts** (NEW FILE)
- Create centralized date utility functions
- `formatTimestamp(timestamp: string, options?: Intl.DateTimeFormatOptions): string`
- `formatRelativeTime(timestamp: string): string`
- `formatDate(timestamp: string): string`
- `formatDateTime(timestamp: string): string`
- Handle timezone conversion properly using browser's Intl API

### Algorithm
1. Create utility functions that properly handle UTC timestamp parsing
2. Use `new Date(timestamp)` which automatically converts UTC to local time
3. Apply consistent formatting options across the application
4. Handle edge cases and invalid timestamps gracefully

## Phase 3: Frontend Component Updates

### Files to Modify

**covenantrix-desktop/src/features/chat/Message.tsx**
- Replace inline `formatTime` function with imported `formatTimestamp` utility
- Update line 17-26 to use centralized utility
- Update line 91 to use `formatTimestamp(message.timestamp)`

**covenantrix-desktop/src/features/notifications/NotificationCard.tsx**
- Replace inline `formatRelativeTime` function with imported utility
- Update lines 12-25 to use centralized utility
- Update line 172 to use `formatRelativeTime(notification.timestamp)`

**covenantrix-desktop/src/features/upload/components/DriveFileItem.tsx**
- Replace inline `formatDate` function with imported utility
- Update lines 63-85 to use centralized utility
- Update line 77 to use `formatDate(dateString)`

**covenantrix-desktop/src/features/profile/components/GoogleAccountCard.tsx**
- Replace inline `formatDate` and `getRelativeTime` functions with imported utilities
- Update lines 43-73 to use centralized utilities
- Update lines 46, 69 to use utility functions

**covenantrix-desktop/src/features/chat/HistoryPanel.tsx**
- Replace inline `formatDate` function with imported utility
- Update lines 48-85 to use centralized utility
- Update line 127 to use `formatDate(conversation.updated_at)`

**covenantrix-desktop/src/features/chat/ContextPanel.tsx**
- Update line 155 to use `formatDate(document.uploaded_at)`

**covenantrix-desktop/src/features/documents/DocumentCard.tsx**
- Replace inline `formatDate` function with imported utility
- Update line 69 to use centralized utility

**covenantrix-desktop/src/features/subscription/AnalyticsDashboard.tsx**
- Update line 87 to use `formatDate(dateString)`

**covenantrix-desktop/src/features/subscription/GracePeriodWarning.tsx**
- Update line 54 to use `formatDate(dateString)`

**covenantrix-desktop/src/features/settings/SettingsBackup.tsx**
- Update lines 193, 232 to use `formatDateTime` utility

### Algorithm
1. Import date utilities in all components that format timestamps
2. Replace inline date formatting functions with centralized utilities
3. Ensure consistent timezone handling across all components
4. Maintain existing UI/UX while fixing timezone issues

## Phase 4: Context and Service Updates

### Files to Modify

**covenantrix-desktop/src/contexts/ChatContext.tsx**
- Update lines 68, 152, 197, 203 to use `new Date().toISOString()` consistently
- Ensure all timestamp creation uses ISO format

**covenantrix-desktop/src/contexts/SubscriptionContext.tsx**
- Update lines 107-108 to use proper date comparison utilities

**covenantrix-desktop/src/contexts/SettingsContext.tsx**
- Update lines 92, 115, 371, 418 to use consistent timestamp format

**covenantrix-desktop/src/utils/settings.ts**
- Update lines 47, 95 to use consistent timestamp format

**covenantrix-desktop/src/utils/settingsBackup.ts**
- Update lines 30, 92 to use consistent timestamp format

### Algorithm
1. Ensure all timestamp creation in contexts uses ISO format
2. Standardize date comparison logic
3. Maintain consistency between frontend and backend timestamp formats

## Implementation Notes

- All backend timestamps will be in UTC using `datetime.utcnow()`
- Frontend will parse UTC timestamps and display in user's local timezone
- The 3-hour difference issue will be resolved as timestamps will be properly converted
- No database migrations required as timestamps are stored as strings
- Backward compatibility maintained with existing timestamp formats
