# Feature 0047: Fix macOS Update Installation with Manual Launch

## Overview

Fix the macOS update mechanism to properly install downloaded updates while maintaining the current Windows-style user flow where the application does NOT auto-relaunch after installation. The user manually opens the application from their Applications folder after the update completes.

**Current Issue:** On macOS, after a successful update download and user clicking "Restart Now", the old version persists and opens on next launch. The update is downloaded but never extracted/installed due to `autoInstallOnAppQuit=false` configuration.

**Root Cause:** macOS uses ZIP-based delta updates that require in-process extraction, which only occurs when `autoInstallOnAppQuit=true`. Windows uses external NSIS installers that work independently of this setting.

## Technical Requirements

### Requirement 1: Enable Auto-Install for macOS
Enable `autoInstallOnAppQuit` configuration for macOS platform while keeping it disabled for Windows to maintain platform-specific update mechanisms.

**Files to Modify:**
- `covenantrix-desktop/electron/updater.js`

**Target Location:** Lines 10-13 (auto-updater configuration initialization)

**Changes Required:**
- Replace the current single `autoInstallOnAppQuit = false` configuration
- Implement platform-conditional logic using `process.platform === 'darwin'`
- Set `autoInstallOnAppQuit = true` for macOS (enables ZIP extraction)
- Set `autoInstallOnAppQuit = false` for Windows (maintains current behavior)
- Preserve existing settings for `autoDownload`, `allowDowngrade`, and `allowPrerelease`

**Technical Rationale:**
- macOS ZIP-based updates require the app process to extract and replace the app bundle
- Without `autoInstallOnAppQuit=true`, the downloaded ZIP remains unextracted
- Windows NSIS installers run as separate processes and don't require this flag
- ZIP extraction on macOS is fast (1-3 seconds) due to differential updates and APFS optimization

### Requirement 2: Prevent Auto-Relaunch After Installation
Ensure the application does NOT automatically relaunch after update installation on both platforms, requiring users to manually open the application.

**Files to Modify:**
- `covenantrix-desktop/electron/ipc-handlers.js`

**Target Location:** Lines 807-840 (IPC handler `update:install`)

**Changes Required:**
- Modify the `autoUpdater.quitAndInstall()` call parameters
- Change second parameter from `true` to `false` (isForceRunAfter)
- Current: `autoUpdater.quitAndInstall(false, true)`
- New: `autoUpdater.quitAndInstall(false, false)`
- Add logging to indicate platform and configuration
- Maintain existing `setImmediate` wrapper and error handling
- Preserve `app.removeAllListeners('window-all-closed')` call

**Parameter Explanation:**
- First parameter (isSilent): `false` = show installation progress on Windows NSIS
- Second parameter (isForceRunAfter): `false` = do NOT auto-launch after install

### Requirement 3: Optional Notification Text Update
Update user-facing notification text to clarify manual launch requirement after installation.

**Files to Modify (Optional):**
- `covenantrix-desktop/electron/updater.js`

**Target Locations:**
- Line 203: `createUpdateNotification` method (update_ready notification content)
- Line 298: `promptUserToInstall` fallback dialog (detail text)

**Changes Required:**
- Update notification content to mention manual relaunch
- Add platform-specific text indicating where to reopen (Applications folder vs Start Menu)
- Clarify that app will close to complete update
- Maintain existing action buttons and metadata structure

## Update Flow Algorithms

### Algorithm 1: Platform-Specific Installation Configuration
```
Initialize auto-updater:
1. Set autoDownload = false (require user approval)
2. Check platform:
   IF platform is macOS (darwin):
     SET autoInstallOnAppQuit = true
     REASON: Enable ZIP extraction on quit
   ELSE:
     SET autoInstallOnAppQuit = false
     REASON: Windows NSIS handles externally
3. Set allowDowngrade = false (security)
4. Set allowPrerelease = false (stability)
```

### Algorithm 2: Update Installation Without Relaunch
```
User clicks "Restart Now":
1. Log installation request with platform information
2. Schedule installation using setImmediate:
   a. Remove 'window-all-closed' listeners
   b. Call autoUpdater.quitAndInstall(false, false)
      - false: Show Windows installer progress
      - false: Do NOT auto-launch after install
3. Application quits

Background process (automatic):
4. IF macOS:
     - Extract ZIP to temporary location
     - Atomically replace app bundle in /Applications
     - Process completes in 1-3 seconds
   ELSE IF Windows:
     - Launch NSIS installer
     - Installer runs visibly
     - User sees installation progress

5. Installation completes, no app launch

User action required:
6. User manually opens application from:
   - macOS: Applications folder or Dock
   - Windows: Start Menu or Desktop shortcut
7. New version runs successfully
```

## File Structure Reference

### Primary Files
- `covenantrix-desktop/electron/updater.js` (362 lines)
  - Class: UpdateManager
  - Methods: constructor, setupEventListeners, sendStatusToWindow
  - Configuration: Lines 10-18 (auto-updater settings)
  
- `covenantrix-desktop/electron/ipc-handlers.js` (964 lines)
  - Function: registerUpdateHandlers (lines 783-843)
  - Handlers: 'update:download', 'update:install'

### Supporting Files (No Changes Required)
- `covenantrix-desktop/electron-builder.yml`
  - Lines 86-89: ZIP target configured correctly (before DMG)
  - Lines 99-105: hardenedRuntime and entitlements configured
- `covenantrix-desktop/build/entitlements.mac.plist`
  - App sandbox disabled for update replacement
- `.github/workflows/build.yml`
  - Lines 259-271: Code signing and notarization configured

## Expected Outcomes

### macOS Update Flow (Fixed)
1. User receives notification: "Version X.Y.Z is ready to install"
2. User clicks "Restart Now"
3. App quits immediately
4. Update extracts silently in background (1-3 seconds)
5. App does NOT auto-launch
6. User manually opens from Applications
7. ✅ New version runs successfully

### Windows Update Flow (Maintained)
1. User receives notification: "Version X.Y.Z is ready to install"
2. User clicks "Restart Now"
3. App quits immediately
4. NSIS installer runs visibly
5. Installer completes and closes
6. App does NOT auto-launch
7. User manually opens from Start Menu
8. ✅ New version runs successfully

## Testing Requirements

### macOS Testing Checklist
- [ ] Download update notification appears
- [ ] Update downloads successfully
- [ ] "Restart Now" button triggers quit
- [ ] App quits cleanly
- [ ] Update extracts without errors (check logs)
- [ ] App does NOT auto-relaunch
- [ ] Manual launch from Applications opens new version
- [ ] Version number updated in About dialog

### Windows Testing Checklist
- [ ] Download update notification appears
- [ ] Update downloads successfully
- [ ] "Restart Now" button triggers quit
- [ ] NSIS installer runs and shows progress
- [ ] Installer completes successfully
- [ ] App does NOT auto-relaunch
- [ ] Manual launch from Start Menu opens new version
- [ ] Version number updated in About dialog

### Log Verification
Check `electron-log` output for:
- `[Update Install] Platform: darwin` (macOS) or `win32` (Windows)
- `[Update Install] Calling quitAndInstall...`
- `quitAndInstall called successfully`
- No errors during extraction/installation

## Implementation Notes

### Why This Approach is Safe
- **Single responsibility:** Each platform handles updates in its optimal way
- **No auto-relaunch:** Eliminates timing issues and race conditions
- **Clean state:** App fully replaced before next manual launch
- **User control:** User decides when to reopen, no interruptions
- **Consistent UX:** Same behavior across platforms

### Cross-Platform Compatibility
The solution maintains platform-specific optimizations:
- **macOS:** In-process ZIP extraction (fast, atomic)
- **Windows:** External NSIS installer (familiar, visible progress)
- **Both:** Manual launch prevents conflicts and gives user control

### Backwards Compatibility
- Changes are in update installation flow only
- No changes to update checking or download mechanisms
- No changes to notification system
- Existing users on old versions can update to this fixed version

