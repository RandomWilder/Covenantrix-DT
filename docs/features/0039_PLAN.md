# Document-Specific RAG Query Filtering

## Feature Description

Implement document-specific filtering for RAG queries to ensure that when users select specific documents in the UI context panel, the chat queries only retrieve and use content from those selected documents, rather than searching across all documents in the RAG storage.

Currently, the `document_ids` parameter is passed from the frontend through the entire backend chain but is completely ignored by the RAG engine, causing queries to return content from all documents regardless of user selection.

## Technical Requirements

### Core Problem
- Frontend sends `document_ids` via `selectedDocuments` in chat context
- Backend receives `document_ids` in `ChatService.send_message_stream()`
- RAG engine methods `query()` and `query_stream()` ignore the `document_ids` parameter
- LightRAG queries all content in working directory without document filtering
- Users see mixed content from multiple documents even when selecting specific documents

### Files to Modify

#### Backend RAG Engine
- `backend/infrastructure/ai/rag_engine.py`
  - Add `document_ids: Optional[List[str]] = None` parameter to `query()` method (line 398-404)
  - Add `document_ids: Optional[List[str]] = None` parameter to `query_stream()` method (line 472-476)
  - Implement document filtering logic in both methods
  - Add logging for document filtering operations

#### Backend Chat Service
- `backend/domain/chat/service.py`
  - Update `query_stream()` call (line 241-244) to pass `document_ids` parameter
  - Update `query()` call (line 376) to pass `document_ids` parameter
  - Ensure `document_ids` from `send_message_stream()` method parameter flows to RAG engine

#### Backend Document Service
- `backend/domain/documents/service.py`
  - Update `query_documents()` method (line 523) to pass `document_ids` to RAG engine
  - Remove warning about document filtering not being supported (lines 518-520)

#### Backend Agent Data Access
- `backend/infrastructure/ai/agent_data_access.py`
  - Update `query_documents()` calls (lines 108, 114) to pass `document_ids` parameter

#### Backend LightRAG Storage
- `backend/infrastructure/storage/lightrag_storage.py`
  - Update `query_documents()` method (line 89) to pass `document_ids` parameter

## Implementation Algorithm

### Phase 1: RAG Engine Parameter Addition
1. Add `document_ids: Optional[List[str]] = None` parameter to both `query()` and `query_stream()` methods
2. Add conditional logic to handle document filtering when `document_ids` is provided
3. Implement pre-filtering approach by:
   - Extracting document content from specified document IDs
   - Creating temporary filtered context
   - Using filtered context for RAG query
4. Add comprehensive logging for document filtering operations

### Phase 2: Document Filtering Logic
1. **Pre-filtering Strategy**: Before calling LightRAG, filter available documents
   - Query document registry for specified document IDs
   - Extract content from only those documents
   - Create temporary working context with filtered documents
   - Pass filtered context to LightRAG query

2. **Post-filtering Strategy**: After LightRAG retrieval, filter results
   - Retrieve results from LightRAG as normal
   - Filter retrieved chunks/entities to only include content from specified documents
   - Return filtered results

3. **Hybrid Approach**: Combine both strategies for optimal results
   - Use pre-filtering to limit document scope
   - Use post-filtering to ensure result relevance
   - Maintain context quality while respecting document boundaries

### Phase 3: Integration Updates
1. Update all RAG engine method calls to pass `document_ids` parameter
2. Ensure backward compatibility - when `document_ids=None`, use current behavior
3. Add error handling for invalid document IDs
4. Update logging to track document filtering usage

## Technical Considerations

### LightRAG Integration Constraints
- LightRAG doesn't natively support document filtering
- Must implement custom filtering logic within existing architecture
- Maintain compatibility with LightRAG's `QueryParam` structure
- Preserve existing query modes (naive, local, global, hybrid, mix)

### Performance Implications
- Document filtering adds minimal overhead when `document_ids=None`
- Pre-filtering may reduce context quality but improves relevance
- Post-filtering maintains context quality but adds processing time
- Hybrid approach balances performance and quality

### Backward Compatibility
- All existing API calls continue to work unchanged
- Optional parameter defaults to `None` maintaining current behavior
- No breaking changes to method signatures
- Existing functionality preserved when `document_ids` not provided

## Implementation Phases

### Phase 1: Core RAG Engine Changes
- Modify `rag_engine.py` to accept `document_ids` parameter
- Implement basic document filtering logic
- Add comprehensive logging and error handling

### Phase 2: Service Layer Integration
- Update `ChatService` to pass `document_ids` to RAG engine
- Update `DocumentService` to utilize document filtering
- Update `AgentDataAccessService` for agent queries
- Update `LightRAGStorage` for storage operations

### Phase 3: Testing and Validation
- Test document filtering with single document selection
- Test document filtering with multiple document selection
- Test backward compatibility with no document selection
- Validate context quality and relevance
- Performance testing with large document sets

## Success Criteria

- When users select specific documents in UI, queries only return content from those documents
- Backward compatibility maintained - existing functionality unchanged
- Performance impact minimized
- Comprehensive logging for debugging and monitoring
- Error handling for edge cases (invalid document IDs, empty selections)
