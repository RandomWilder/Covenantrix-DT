# Feature 0016: Unified Google Drive Upload Experience

## Description

Unify the Google Drive file selection flow with the local file upload experience, providing consistent UX, detailed progress tracking, and state persistence. Google Drive files will be added to a shared upload queue alongside local files, processed through the same streaming pipeline with real-time progress updates.

**Key Requirements:**
- Fixed-height scrollable Drive file browser (max-height: min(50vh, 500px)) with sticky action bar at bottom
- "Add to Upload" button adds Drive files to shared FileList queue
- Same streaming progress UI for Drive and local files
- Source indicators using Lucide React icons (Computer for local, Cloud for Drive)
- Clear Drive selection after adding to queue
- Fix logging Unicode errors for Hebrew/non-ASCII filenames

---

## Phase 1: Type Definitions & Backend Streaming

### 1.1 Update Type Definitions

**File:** `covenantrix-desktop/src/types/document.ts`
- Add `source` field to FileItem type:
  ```typescript
  source: 'local' | 'drive'
  sourceAccount?: string  // Email for Drive files
  driveFileId?: string    // Google Drive file ID
  ```

**File:** `covenantrix-desktop/src/hooks/useUpload.ts`
- Update `FileItem` interface to include source fields
- Update `PersistedUploadState` to persist Drive file metadata

**File:** `backend/api/schemas/google.py`
- Keep existing `DriveFileDownloadRequest` and `DriveDownloadResult` schemas
- Add `DriveFileStreamRequest` schema for streaming endpoint:
  ```python
  class DriveFileStreamRequest(BaseModel):
      account_id: str
      file_ids: List[str]
  ```

### 1.2 Backend Streaming Endpoint

**File:** `backend/api/routes/google.py`
- Create new endpoint: `POST /api/google/drive/download/stream`
- Model after `/api/documents/upload/stream` pattern
- Algorithm:
  1. Validate account_id and file_ids
  2. Get valid access token from OAuth service
  3. For each file_id in loop:
     - Stage 1 (10%): Initializing - emit progress event
     - Download file metadata from Drive API
     - Stage 2 (25%): Reading - download file content from Drive
     - Stage 3 (40%): Understanding - call document_service.upload_document()
     - Stages 4-6 (60%-100%): Pass through document processing stages
     - Emit progress events at each stage
  4. Use async generator with Server-Sent Events (SSE)
  5. Return `StreamingResponse` with content-type "text/event-stream"

**File:** `backend/api/routes/google.py` (existing batch endpoint)
- Keep `/api/google/drive/download` for backward compatibility
- Consider deprecation path if needed

**File:** `backend/core/logging_config.py`
- Update `setup_logging()` function:
  - Set `stream.encoding = 'utf-8'` for StreamHandler
  - Handle Windows console encoding issues for Hebrew/Unicode filenames
  - Add try-except wrapper around log message formatting

---

## Phase 2: Frontend Service & Hook Updates

### 2.1 Google Service API Client

**File:** `covenantrix-desktop/src/services/googleService.ts`
- Add method: `downloadDriveFilesStream(accountId: string, fileIds: string[])`
- Returns async generator for SSE events
- Pattern based on `DocumentsApi.uploadDocumentsStream()`
- Parse SSE events into BatchProgressEvent format

### 2.2 Upload Hook Enhancements

**File:** `covenantrix-desktop/src/hooks/useUpload.ts`

**Function:** `addFiles(newFiles: File[])`
- Change signature to: `addFiles(newFiles: File[], source: 'local' | 'drive' = 'local')`
- Add optional parameters: `accountEmail?: string, driveFileIds?: string[]`
- Map Drive files to FileItem with source metadata

**Function:** `addDriveFiles(driveFiles: DriveFile[], accountId: string, accountEmail: string)`
- New function to add Drive files to queue
- Create placeholder File objects from Drive metadata
- Set source='drive' and populate Drive-specific fields
- Store driveFileId for backend processing

**Function:** `uploadGoogleDriveFiles()` (line 463)
- Replace current implementation
- Use new streaming endpoint
- Pattern identical to `uploadLocalFiles()` logic
- Map SSE progress events to FileItem status updates

**Function:** `startUpload()` (line 321)
- Remove `type` parameter - auto-detect from file source
- Group files by source: local vs Drive
- Process local files through `/api/documents/upload/stream`
- Process Drive files through `/api/google/drive/download/stream`
- Run both in parallel using `Promise.all()`
- Update shared progress state

---

## Phase 3: UI Component Updates

### 3.1 GoogleDriveSelector Restructure

**File:** `covenantrix-desktop/src/features/upload/components/GoogleDriveSelector.tsx`

**Props changes:**
- Change `onFilesSelected: (fileIds: string[], accountId: string) => void`
- To: `onAddToQueue: (files: DriveFile[], accountId: string, accountEmail: string) => void`

**UI Structure:**
```
<div className="space-y-4">
  {/* Account Selector - unchanged */}
  <DriveAccountSelector ... />
  
  {/* Navigation Bar - unchanged */}
  <DriveBreadcrumbs ... />
  
  {/* Search Bar - unchanged */}
  <DriveSearchBar ... />
  
  {/* Fixed-height scrollable file list */}
  <div className="border rounded-lg" style={{ maxHeight: 'min(50vh, 500px)' }}>
    <DriveFileList
      files={files}
      selectedFiles={selectedFiles}
      className="overflow-y-auto max-h-full"
      ...
    />
  </div>
  
  {/* Sticky action bar at bottom - only when files selected */}
  {selectedFiles.size > 0 && (
    <div className="sticky bottom-0 bg-white dark:bg-gray-800 border rounded-lg p-4">
      <div>â˜‘ {selectedFiles.size} files selected ({totalSize})</div>
      <button onClick={handleAddToQueue}>Add to Upload</button>
      <button onClick={clearSelection}>Clear</button>
    </div>
  )}
</div>
```

**Function:** `handleConfirmSelection()` (line 183)
- Rename to `handleAddToQueue()`
- Remove immediate download logic
- Call `onAddToQueue(selectedDriveFiles, accountId, accountEmail)`
- Clear selection: `setSelectedFiles(new Set())`
- Show toast: "Added X files to upload queue"

**Remove:**
- Drive-specific progress tracking state (lines 26-31 in UploadScreen)
- Separate progress UI for Drive (lines 196-238 in UploadScreen)

### 3.2 FileList Component Enhancement

**File:** `covenantrix-desktop/src/features/upload/components/FileList.tsx`

**Add source indicator:**
- Import Lucide icons: `import { Computer, Cloud } from 'lucide-react'`
- Add icon before filename:
  ```tsx
  <div className="flex items-center space-x-2">
    {file.source === 'local' ? (
      <Computer className="w-4 h-4 text-gray-500" />
    ) : (
      <Cloud className="w-4 h-4 text-blue-500" />
    )}
    <span>{file.file.name}</span>
  </div>
  ```
- Show account email for Drive files:
  ```tsx
  {file.source === 'drive' && file.sourceAccount && (
    <span className="text-xs text-gray-500">
      Drive - {file.sourceAccount}
    </span>
  )}
  ```

### 3.3 UploadScreen Integration

**File:** `covenantrix-desktop/src/features/upload/UploadScreen.tsx`

**Remove state (lines 26-31):**
- `isDriveUploading`
- `driveUploadProgress`
- These are now handled by unified `useUpload` hook

**Update handler (lines 37-87):**
- Remove `handleGoogleDriveFiles()` function
- Add: `handleAddDriveFiles(files: DriveFile[], accountId: string, accountEmail: string)`
- Implementation:
  ```typescript
  const handleAddDriveFiles = (files: DriveFile[], accountId: string, accountEmail: string) => {
    addDriveFiles(files, accountId, accountEmail)
    showToast(`Added ${files.length} Drive files to upload queue`, 'success')
  }
  ```

**Update GoogleDriveSelector props (line 190):**
- Change from `onFilesSelected={handleGoogleDriveFiles}`
- To: `onAddToQueue={handleAddDriveFiles}`

**Remove Drive-specific progress UI (lines 195-238):**
- Delete separate Drive progress display
- Unified progress shown via existing UploadProgress component (lines 244-248)

**Update "Start Upload" button logic (line 265):**
- Remove `handleStartUpload()` with tab checking
- Always call `startUpload()` without type parameter
- Hook auto-detects source from file metadata

**FileList display:**
- Show in both tabs (currently only in Local tab)
- Move FileList render outside tab conditional
- Position after tab content, before action buttons
- Show when `files.length > 0` regardless of active tab

### 3.4 UploadProgress Component

**File:** `covenantrix-desktop/src/features/upload/components/UploadProgress.tsx`
- No changes needed - already supports all required features
- Receives unified file list with Drive and local files mixed

---

## Implementation Details

### Drive File to FileItem Mapping

When adding Drive files to queue, create FileItem:
```typescript
{
  id: driveFile.id,  // Use Drive file ID as item ID
  file: new File([], driveFile.name),  // Placeholder File object
  filename: driveFile.name,
  source: 'drive',
  sourceAccount: accountEmail,
  driveFileId: driveFile.id,
  status: 'pending'
}
```

### Backend Drive Streaming Logic

```python
async def download_drive_files_stream(request: DriveFileStreamRequest):
    # Pre-validation
    access_token = await oauth_service.ensure_valid_token(request.account_id)
    
    async def generate_progress():
        for file_index, file_id in enumerate(request.file_ids):
            # Stage 1: Initializing
            yield progress_event(stage='initializing', progress=10)
            
            # Get metadata
            metadata = await api_service.get_file_metadata(access_token, file_id)
            filename = metadata.get('name')
            
            # Stage 2: Downloading from Drive
            yield progress_event(stage='reading', progress=25, message='Downloading from Drive...')
            content = await api_service.download_file(access_token, file_id)
            
            # Stage 3-6: Document processing (delegates to document_service)
            document = await document_service.upload_document(content, filename)
            
            # Emit completion
            yield progress_event(
                stage='completed',
                progress=100,
                document_id=document.id
            )
    
    return StreamingResponse(generate_progress(), media_type='text/event-stream')
```

### CSS for Fixed-Height Browser

**File:** `covenantrix-desktop/src/features/upload/components/GoogleDriveSelector.tsx`
```css
.drive-file-list-container {
  max-height: min(50vh, 500px);
  overflow-y: auto;
  overflow-x: hidden;
  border: 1px solid theme('colors.gray.200');
  border-radius: theme('borderRadius.lg');
}

.drive-action-bar {
  position: sticky;
  bottom: 0;
  background: theme('colors.white');
  border-top: 1px solid theme('colors.gray.200');
  padding: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
```

### State Persistence

Drive files in queue persist via existing localStorage mechanism in `useUpload`:
- `driveFileId` stored in persisted state
- On restore, create placeholder File objects
- Backend polling validates document IDs still exist
- If Drive file was mid-download during crash, status shows as "processing"

---

## Files to Modify

### Backend
1. `backend/api/routes/google.py` - Add streaming endpoint
2. `backend/api/schemas/google.py` - Add streaming request schema
3. `backend/core/logging_config.py` - Fix Unicode encoding

### Frontend - Types
4. `covenantrix-desktop/src/types/document.ts` - Add source fields

### Frontend - Services & Hooks
5. `covenantrix-desktop/src/services/googleService.ts` - Add streaming method
6. `covenantrix-desktop/src/hooks/useUpload.ts` - Unified source handling

### Frontend - Components
7. `covenantrix-desktop/src/features/upload/UploadScreen.tsx` - Remove Drive-specific logic
8. `covenantrix-desktop/src/features/upload/components/GoogleDriveSelector.tsx` - Fixed height + action bar
9. `covenantrix-desktop/src/features/upload/components/FileList.tsx` - Source indicators

---

## Testing Checklist

**Drive Browser UX:**
- [ ] File list scrolls internally, action bar stays visible
- [ ] Action bar only appears when files selected
- [ ] Selection count and total size shown correctly
- [ ] "Add to Upload" moves files to queue and clears selection

**Unified Queue:**
- [ ] Local and Drive files appear together in FileList
- [ ] FileList visible in both tabs
- [ ] Source icons show correctly (Computer/Cloud)
- [ ] Drive files show account email

**Upload Flow:**
- [ ] "Start Upload" processes mixed local + Drive files
- [ ] Progress shows detailed stages for both sources
- [ ] Drive files show "Downloading from Drive..." stage
- [ ] Backend polling works for Drive files
- [ ] State persists through app reload

**Logging:**
- [ ] Hebrew/Unicode filenames log without errors
- [ ] Console output displays correctly in Windows PowerShell

**Error Handling:**
- [ ] Drive token expiry during download shows proper error
- [ ] Failed Drive files show in progress with error message
- [ ] Can retry failed files individually

