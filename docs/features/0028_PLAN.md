# Upload Pipeline Optimization Quick Wins

## Context
Optimize the document upload pipeline to reduce processing time from 51 seconds to 5-10 seconds for single-page documents. The current bottlenecks are: event loop conflicts in subscription service, LightRAG's default configuration causing excessive LLM calls, and synchronous processing blocking HTTP requests.

## Files to Modify

### 1. Fix Event Loop Issue
**File:** `backend/domain/subscription/service.py`
- **Function:** `get_current_subscription()` (lines 47-69)
- **Change:** Remove synchronous event loop handling, use async method directly
- **Impact:** Prevents "This event loop is already running" error and subscription bypass

### 2. Optimize LightRAG Configuration  
**File:** `backend/infrastructure/ai/rag_engine.py`
- **Function:** `initialize()` (lines 318-369)
- **Change:** Add performance parameters to LightRAG initialization
- **Parameters to add:**
  - `chunk_size=800` (reduce from default 1200)
  - `max_workers=2` (limit concurrent LLM calls)
  - `llm_cache=True` (ensure caching enabled)

### 3. Background Processing
**File:** `backend/domain/documents/service.py`
- **Function:** `process_document()` (lines 151-307)
- **Change:** Make processing non-blocking by returning immediately
- **New function:** `_process_in_background()` for async processing
- **Impact:** HTTP request returns in <1 second, processing continues in background

## Implementation Steps

### Phase 1: Event Loop Fix (5 minutes)
1. Replace `get_current_subscription()` with direct async call
2. Update all callers to use `get_current_subscription_async()`
3. Remove `loop.run_until_complete()` pattern

### Phase 2: LightRAG Optimization (10 minutes)  
1. Add performance parameters to LightRAG constructor
2. Test with single document to verify 60-70% time reduction
3. Ensure caching remains enabled

### Phase 3: Background Processing (15 minutes)
1. Modify `process_document()` to return immediately with "processing" status
2. Create `_process_in_background()` task
3. Update progress tracking to work with background processing
4. Ensure document registry updates work asynchronously

## Expected Results
- **Event Loop:** Eliminates subscription service errors
- **LightRAG Config:** Reduces processing time from 51s to 15-20s  
- **Background Processing:** HTTP response time <1 second, processing continues asynchronously
- **Combined:** Single-page document processing in 5-10 seconds total
