# Feature 0034: Rotating Messages During 75% Processing Stage

## Description
Implement rotating progress messages during the 75% stage of document processing to provide visual feedback while LightRAG processes content. Messages rotate every 2-3 seconds without affecting the actual processing flow or breaking existing functionality.

## Files to Modify

### backend/domain/documents/service.py
- **Method**: `process_document()` (lines 151-307)
- **Location**: Stage 3 "Building connections" at 75% progress (lines 225-236)
- **Changes**:
  - Add rotating message task before `rag_engine.insert()` call
  - Implement background asyncio task for message rotation
  - Ensure proper task cleanup when insert completes or fails

## Implementation Details

### Algorithm
1. **Start Rotation Task**: At the 75% stage, create an asyncio background task
2. **Message Rotation**: Cycle through predefined messages every 2-3 seconds
3. **Progress Maintenance**: Keep progress at 75% throughout rotation
4. **Task Cleanup**: Cancel rotation task when `rag_engine.insert()` completes
5. **Continue Flow**: Proceed to 90% and 100% stages as normal

### Rotating Messages
Add new rotating messages to `STAGE_MESSAGES` dictionary:
```python
ROTATING_MESSAGES = [
    "Building knowledge connections...",
    "Analyzing document relationships...", 
    "Creating semantic links...",
    "Processing document structure...",
    "Establishing connections...",
    "Building knowledge graph..."
]
```

### Implementation Pattern
```python
# At 75% stage (before rag_engine.insert())
rotation_task = None
try:
    # Start rotating messages
    rotation_task = asyncio.create_task(
        self._rotate_messages(document_id, progress_callback)
    )
    
    # Insert into LightRAG (unchanged)
    await self.rag_engine.insert(extracted_content)
    
finally:
    # Always cancel rotation task
    if rotation_task and not rotation_task.done():
        rotation_task.cancel()
```

### New Helper Method
Add `_rotate_messages()` method to handle message rotation:
- Accepts document_id and progress_callback
- Cycles through ROTATING_MESSAGES every 2-3 seconds
- Updates registry and calls progress_callback
- Handles cancellation gracefully

## Key Requirements

### What NOT to Touch
- **rag_engine.insert()**: Leave completely unchanged
- **Progress percentages**: Keep 25%, 50%, 75%, 90%, 100% unchanged  
- **Streaming endpoint**: No modifications to API structure
- **Frontend code**: No changes needed - UI already displays stageMessage
- **progress_callback signature**: Keep optional and backward compatible

### Risk Mitigation
- **Parallel execution**: Rotation runs alongside, not inside rag_engine.insert()
- **Task cleanup**: Always cancel background task in finally block
- **Queue management**: Ensure rotating messages don't block processing
- **Error handling**: Rotation failures don't affect main processing flow

## Complexity Assessment
**LOW** - Single method modification with parallel task pattern, zero breaking changes to existing functionality.
