# Document Upload Feature - Technical Plan

## Brief Description

Implement a comprehensive document upload feature accessible via the Upload tab in the application. The feature will allow users to upload multiple documents through three methods: local file selection, Google Drive file selection, and drag-and-drop interface. All uploaded documents will be processed through LightRAG using the existing `/documents/upload` endpoint, with clear progress indication for success and failure states.

## Files and Functions to be Modified/Created

### Backend Changes

**Files to modify:**
- `backend/api/routes/documents.py` - Add batch upload endpoint
- `backend/api/schemas/documents.py` - Add batch upload schemas
- `backend/domain/documents/service.py` - Add batch processing methods
- `backend/domain/integrations/google_drive.py` - Implement file download functionality
- `backend/infrastructure/external/google_api.py` - Complete Google Drive API implementation

**New endpoints to create:**
- `POST /documents/upload/batch` - Handle multiple file uploads
- `POST /documents/upload/drive` - Handle Google Drive file downloads and processing

**Functions to modify:**
- `DocumentService.upload_document()` - Add batch processing support
- `DocumentService.process_document()` - Add progress tracking
- `GoogleDriveService.download_file()` - Implement actual download functionality
- `GoogleAPIService.download_file()` - Complete implementation

### Frontend Changes

**Files to create:**
- `covenantrix-desktop/src/features/upload/UploadScreen.tsx` - Main upload interface
- `covenantrix-desktop/src/features/upload/components/FileUploadArea.tsx` - Drag & drop component
- `covenantrix-desktop/src/features/upload/components/GoogleDriveSelector.tsx` - Google Drive file picker
- `covenantrix-desktop/src/features/upload/components/UploadProgress.tsx` - Progress tracking component
- `covenantrix-desktop/src/features/upload/components/FileList.tsx` - Selected files display
- `covenantrix-desktop/src/hooks/useUpload.ts` - Upload state management hook
- `covenantrix-desktop/src/services/api/UploadApi.ts` - Upload API service

**Files to modify:**
- `covenantrix-desktop/src/App.tsx` - Add routing for upload screen
- `covenantrix-desktop/src/components/layout/Sidebar.tsx` - Add navigation to upload screen
- `covenantrix-desktop/src/services/api/DocumentsApi.ts` - Add batch upload methods
- `covenantrix-desktop/src/types/document.ts` - Add upload progress types

**Electron IPC changes:**
- `covenantrix-desktop/electron/ipc-handlers.js` - Add file selection handlers
- `covenantrix-desktop/electron/preload.js` - Expose new IPC methods

## Algorithms and Implementation Details

### Phase 1: Data Layer (Backend API Extensions)

**Batch Upload Endpoint Algorithm:**
1. Accept multiple files via `List[UploadFile]` parameter
2. Validate each file individually (size, format, MIME type)
3. Create document entities for all valid files
4. Process files in parallel using asyncio
5. Return batch response with individual file results
6. Handle partial failures gracefully

**Google Drive Integration Algorithm:**
1. Validate OAuth credentials and Drive access
2. List files from specified folder or user selection
3. Filter files by supported MIME types
4. Download files in parallel using Google Drive API
5. Process downloaded files through existing document pipeline
6. Return processing results with file metadata

### Phase 2A: Frontend Upload Interface

**Drag & Drop Implementation:**
1. Create drop zone component with visual feedback
2. Handle `dragover`, `dragenter`, `dragleave`, `drop` events
3. Validate dropped files (type, size, count limits)
4. Add files to upload queue with preview
5. Support multiple file selection and removal

**File Selection Methods:**
1. **Local Files:** Use HTML file input with `multiple` attribute
2. **Google Drive:** Implement OAuth flow → file picker → download
3. **Drag & Drop:** Handle native browser drag events

**Progress Tracking Algorithm:**
1. Create upload queue with file states (pending, uploading, processing, completed, failed)
2. Track progress per file and overall batch progress
3. Display real-time status updates via WebSocket or polling
4. Show detailed error messages for failed uploads
5. Allow retry of failed uploads

### Phase 2B: Google Drive Integration

**OAuth Flow Implementation:**
1. Check for existing valid Google credentials
2. If expired/missing, initiate OAuth flow in new window
3. Store credentials securely in Electron storage
4. Use credentials to access Google Drive API

**File Selection Interface:**
1. Display Google Drive file browser with folder navigation
2. Show file previews with metadata (size, type, modified date)
3. Support multi-select with checkboxes
4. Filter files by supported document types
5. Show file size warnings for large files

### Phase 2C: Upload Processing & Status

**Upload Queue Management:**
1. Maintain upload queue with file metadata and status
2. Process uploads in configurable batches (default: 3 concurrent)
3. Show progress bars for each file and overall progress
4. Handle network interruptions and retry logic
5. Provide upload cancellation capability

**Status Display Algorithm:**
1. **Pending:** File queued, waiting to start
2. **Uploading:** File being uploaded to server (progress bar)
3. **Processing:** Server processing document (OCR, RAG insertion)
4. **Completed:** Successfully processed and indexed
5. **Failed:** Error occurred, show error message and retry option

## Implementation Phases

### Phase 1: Backend API Extensions
- Extend existing `/documents/upload` endpoint for batch processing
- Implement Google Drive file download functionality
- Add progress tracking to document processing
- Create batch upload response schemas

### Phase 2A: Core Upload Interface
- Create main upload screen with tabbed interface
- Implement drag & drop file area
- Add local file selection functionality
- Create file list display with status indicators

### Phase 2B: Google Drive Integration
- Implement OAuth authentication flow
- Create Google Drive file picker interface
- Add file download and processing pipeline
- Integrate with existing document service

### Phase 2C: Progress Tracking & Status
- Implement real-time progress updates
- Add comprehensive error handling and retry logic
- Create upload history and status persistence
- Add upload cancellation and queue management

## Key Technical Considerations

**File Size Limits:** Respect existing 50MB limit per file, with batch size limits
**Supported Formats:** PDF, DOCX, DOC, TXT, PNG, JPG, JPEG, TIFF
**Concurrent Processing:** Limit to 3 simultaneous uploads to prevent server overload
**Error Handling:** Graceful degradation for partial batch failures
**Progress Updates:** Real-time status via WebSocket or polling mechanism
**Google Drive Integration:** Secure OAuth flow with credential storage
**Drag & Drop:** Cross-browser compatibility with visual feedback
**Mobile Responsiveness:** Touch-friendly interface for drag operations

## Integration Points

**Backend Integration:**
- Leverages existing `DocumentService.upload_document()` method
- Uses current LightRAG processing pipeline via `RAGEngine.insert()`
- Integrates with `DocumentRegistry` for metadata storage
- Utilizes existing `DocumentProcessor` for text extraction and OCR

**Frontend Integration:**
- Extends current sidebar navigation system
- Integrates with existing document types and API schemas
- Uses current Electron IPC communication patterns
- Leverages existing UI component library and styling system

**Google Drive Integration:**
- Builds upon existing `GoogleOAuthService` and `GoogleDriveService`
- Extends current OAuth credential management
- Integrates with existing document processing pipeline
- Uses established error handling and logging patterns
