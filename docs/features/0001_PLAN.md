# Fix Download Progress Bar Display for Version Updates

## Problem Description

The download progress bar for version updates is not displaying despite the backend working properly. The issue is in the NotificationContext.tsx where the `fetchNotifications()` function overwrites the local download progress state with backend data that doesn't contain download progress information.

## Technical Analysis

### Current Flow
1. Electron updater sends download progress via `onUpdateStatus` event
2. NotificationContext receives progress and updates local state correctly
3. However, `fetchNotifications()` (called every 60 seconds) overwrites the download progress with backend data
4. Backend doesn't store download progress, so it gets lost

### Root Cause
The notification fetching mechanism doesn't account for active downloads and overwrites the local download progress state.

## Solution Strategy

### Phase 1: Fix Download Progress State Management
**Files to modify:**
- `covenantrix-desktop/src/contexts/NotificationContext.tsx`

**Changes needed:**
1. **Modify `fetchNotifications()` function** (lines 14-45):
   - Add logic to detect active downloads before fetching from backend
   - Preserve download progress state during backend fetches
   - Only update non-downloading notifications from backend

2. **Enhance download progress preservation** (lines 19-35):
   - Improve the existing download state preservation logic
   - Ensure download progress is never overwritten by backend data
   - Add proper state merging for notifications with active downloads

3. **Add download state tracking**:
   - Track which notifications are currently downloading
   - Prevent backend overwrites for downloading notifications
   - Maintain download progress until download completes

### Phase 2: Optimize Notification Polling During Downloads
**Files to modify:**
- `covenantrix-desktop/src/contexts/NotificationContext.tsx`

**Changes needed:**
1. **Disable notification polling during active downloads**:
   - Pause the 60-second interval when downloads are active
   - Resume polling after download completion
   - This prevents the overwrite issue entirely

2. **Add download state detection**:
   - Track active download state globally
   - Use this to control notification fetching behavior
   - Ensure clean state management

### Phase 3: Improve Download Progress Handling
**Files to modify:**
- `covenantrix-desktop/src/contexts/NotificationContext.tsx`
- `covenantrix-desktop/src/features/notifications/NotificationCard.tsx`

**Changes needed:**
1. **Enhance progress update logic** (lines 222-253):
   - Improve the notification update logic for download progress
   - Ensure proper state merging without losing progress
   - Add better error handling for progress updates

2. **Add download completion handling**:
   - Properly handle download completion
   - Clean up download state when appropriate
   - Resume normal notification polling

## Implementation Details

### Key Changes in NotificationContext.tsx

1. **Modify fetchNotifications function:**
```typescript
const fetchNotifications = useCallback(async () => {
  try {
    setIsLoading(true);
    const data = await notificationService.getAll();
    
    // Check if any downloads are active
    const hasActiveDownloads = notifications.some(n => n.downloadProgress?.isDownloading);
    
    if (hasActiveDownloads) {
      // Skip backend fetch during active downloads
      console.log('[NotificationContext] Skipping fetch during active download');
      return;
    }
    
    // Preserve existing downloadProgress state
    setNotifications(prev => {
      const existingDownloadStates = new Map();
      prev.forEach(n => {
        if (n.downloadProgress?.isDownloading) {
          existingDownloadStates.set(n.id, n.downloadProgress);
        }
      });
      
      return data.map(backendNotification => {
        const existingDownloadState = existingDownloadStates.get(backendNotification.id);
        if (existingDownloadState) {
          return { ...backendNotification, downloadProgress: existingDownloadState };
        }
        return backendNotification;
      });
    });
    
    // Calculate unread count
    const count = data.filter(n => !n.read && !n.dismissed).length;
    setUnreadCount(count);
  } catch (error) {
    console.error('Failed to fetch notifications:', error);
  } finally {
    setIsLoading(false);
  }
}, [notifications]); // Add notifications dependency
```

2. **Add download state tracking:**
```typescript
const [hasActiveDownloads, setHasActiveDownloads] = useState(false);

// Update download state tracking
useEffect(() => {
  const activeDownloads = notifications.some(n => n.downloadProgress?.isDownloading);
  setHasActiveDownloads(activeDownloads);
}, [notifications]);
```

3. **Modify polling interval:**
```typescript
// Only poll when no active downloads
useEffect(() => {
  if (hasActiveDownloads) {
    console.log('[NotificationContext] Pausing notification polling during download');
    return;
  }
  
  const interval = setInterval(fetchNotifications, 60000);
  return () => clearInterval(interval);
}, [fetchNotifications, hasActiveDownloads]);
```

### Key Changes in NotificationCard.tsx

1. **Ensure progress bar visibility:**
```typescript
{isExpanded && notification.downloadProgress?.isDownloading && (
  <div className="mt-3 mb-3">
    {/* Progress bar implementation - already exists */}
  </div>
)}
```

## Testing Strategy

1. **Test download progress display:**
   - Start a version update download
   - Verify progress bar appears and updates
   - Ensure progress is not lost during polling

2. **Test notification polling:**
   - Verify polling pauses during downloads
   - Confirm polling resumes after completion
   - Test normal notification fetching works

3. **Test state management:**
   - Verify download progress is preserved
   - Test multiple notifications with downloads
   - Ensure clean state transitions

## Risk Mitigation

1. **Preserve existing functionality:**
   - All existing notification features remain intact
   - No changes to backend API
   - No changes to Electron updater

2. **Backward compatibility:**
   - Changes are additive, not breaking
   - Existing notification behavior preserved
   - Graceful handling of edge cases

3. **Performance considerations:**
   - Minimal performance impact
   - Efficient state management
   - Proper cleanup of intervals

## Success Criteria

1. Download progress bar displays correctly during version updates
2. Progress updates in real-time without interruption
3. Notification polling doesn't interfere with download progress
4. All existing notification functionality remains intact
5. Clean state management with proper cleanup