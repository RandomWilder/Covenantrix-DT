# Feature 0023: Onboarding and Settings Alignment

## Overview
Align the Onboarding wizard and Settings modal to ensure consistent behavior, proper data persistence, and improved separation of concerns. Address three critical issues: unreliable onboarding trigger logic, inconsistent soft-save implementation between flows, and profile data not displaying after app restart.

## Current State Analysis

### Onboarding Flow (`SettingsSetup.tsx`)
- **Purpose:** First-run wizard for new users
- **Trigger:** `isFirstRun` flag calculated by comparing settings to default values
- **Data handling:** Calls `updateSettings()` directly (auto-save on change)
- **Steps:** Welcome → Profile → API Keys → Language → RAG → Appearance → Complete
- **Issue:** Profile fields don't display saved data on subsequent launches

### Settings Modal (`SettingsModal.tsx`)
- **Purpose:** Post-onboarding configuration interface  
- **Trigger:** User action (clicking Settings button)
- **Data handling:** Local state with soft-save (`localSettings`), persists on "Save & Apply"
- **Tabs:** API Keys, Subscription, Language, RAG, Appearance, Backup
- **Issue:** No Profile/Account tab exists

### Shared Infrastructure ✅
- Both use `SettingsContext` as provider
- Both use `UserSettings` type from `types/settings.ts`
- Both use same backend storage (`user_settings_storage.py`)
- Already properly architected with single source of truth

## Critical Issues

### Issue 1: Unreliable Onboarding Trigger
**Location:** `covenantrix-desktop/src/hooks/useSettings.ts` lines 36-66

**Current Logic:**
```typescript
const hasCustomApiKeys = context.settings.api_keys.mode === 'custom' && ...
const hasNonDefaultSettings = context.settings.language.preferred !== 'en' || ...
setIsFirstRun(!hasCustomApiKeys && !hasNonDefaultSettings);
```

**Problem:** Triggers onboarding every time settings match defaults (e.g., after reset), not just on actual first run.

**Solution:** Add explicit `onboarding_completed` boolean flag to settings schema.

### Issue 2: Profile Data Not Loading After Restart
**Location:** `covenantrix-desktop/src/features/onboarding/ProfileSetupStep.tsx` line 19

**Current Code:**
```typescript
const [profile, setProfile] = useState<ProfileSettings>(initialProfile || {
  first_name: '',
  last_name: '',
  email: ''
});
```

**Problem:** React `useState` only initializes once on mount. When component mounts, `settings` is still loading (null), so `initialProfile` is undefined. When settings load with actual data, the state doesn't update because `useState` doesn't re-run.

**Backend Evidence:** Logs show profile data IS returned: `profile: { first_name: 'asaf' }` (lines 953, 977 in terminal logs)

**Root Cause:** Classic React timing issue - initial value set before data loads, no sync mechanism after data arrives.

### Issue 3: Inconsistent Soft-Save Behavior
**Onboarding:** Auto-saves every change immediately via `onSave(cleanedProfile)` (line 38 in ProfileSetupStep)
**Settings Modal:** Soft-save with local state, persists only on "Save & Apply" button

**Problem:** Different UX patterns for same data types create user confusion.

## Implementation Plan

### Phase 1: Schema and Backend Updates

#### 1.1 Add `onboarding_completed` Flag to TypeScript Types
**File:** `covenantrix-desktop/src/types/settings.ts`

Add to `UserSettings` interface:
```typescript
export interface UserSettings {
  onboarding_completed?: boolean;  // Add this field
  api_keys: ApiKeySettings;
  rag: RAGSettings;
  // ... existing fields
}
```

#### 1.2 Add `onboarding_completed` to Backend Schema
**File:** `backend/api/schemas/settings.py`

Add to `UserSettings` class:
```python
class UserSettings(BaseModel):
    onboarding_completed: bool = Field(default=False, description="Whether initial onboarding completed")
    api_keys: ApiKeySettings = Field(default_factory=ApiKeySettings)
    # ... existing fields
```

#### 1.3 Update Settings Defaults and Validation
**Files:**
- `covenantrix-desktop/src/utils/settings.ts` - `getDefaultSettings()` function
- `covenantrix-desktop/src/contexts/SettingsContext.tsx` - `getDefaultSettings()` function

Add `onboarding_completed: false` to default settings.

#### 1.4 Update Backend Migration Logic
**File:** `backend/infrastructure/storage/user_settings_storage.py` - `_migrate_settings()` method

Add migration logic to set `onboarding_completed: false` for existing installations (preserve current experience).

### Phase 2: Fix Onboarding Trigger Logic

#### 2.1 Update `isFirstRun` Calculation
**File:** `covenantrix-desktop/src/hooks/useSettings.ts` lines 36-66

Replace complex heuristic with simple flag check:
```typescript
useEffect(() => {
  const checkFirstRun = async () => {
    try {
      if (context.settings) {
        // Simple: if onboarding_completed is false/undefined, show onboarding
        setIsFirstRun(!context.settings.onboarding_completed);
      }
    } catch (error) {
      console.error('Error checking first run status:', error);
      setIsFirstRun(true);
    }
  };
  checkFirstRun();
}, [context.settings]);
```

#### 2.2 Mark Onboarding Complete
**File:** `covenantrix-desktop/src/features/onboarding/SettingsSetup.tsx`

Update `handleOnboardingComplete` to set the flag:
```typescript
const handleComplete = async () => {
  // Mark onboarding as completed
  await updateSettings({ onboarding_completed: true });
  onComplete();
};
```

Also update skip handler to mark as completed (user chose to skip, don't show again).

### Phase 3: Implement Unified Soft-Save Behavior

#### 3.1 Update Onboarding to Use Local State
**File:** `covenantrix-desktop/src/features/onboarding/SettingsSetup.tsx`

**Changes:**
1. Add local state for settings: `const [localSettings, setLocalSettings] = useState<Partial<UserSettings>>({})`
2. Change `handleSettingsChange` to update local state only (no immediate `updateSettings()` call)
3. Update `handleNext()` to persist accumulated changes before step transition
4. Update `handleComplete()` to save all changes at once with `onboarding_completed: true`

**Algorithm:**
```
Step transition (Next button):
  1. Update local state with current step changes
  2. Do NOT persist to backend yet
  3. Navigate to next step
  4. Preserve local state across steps

Final completion:
  1. Merge all local state changes
  2. Add onboarding_completed: true
  3. Call updateSettings() once with complete object
  4. Apply settings to backend services
  5. Close wizard
```

#### 3.2 Update ProfileSetupStep to Support Controlled State
**File:** `covenantrix-desktop/src/features/onboarding/ProfileSetupStep.tsx`

**Current behavior:** Auto-saves on every keystroke
**New behavior:** Updates parent component state only (controlled component pattern)

**Changes:**
1. Add `useEffect` to sync local state when `initialProfile` prop changes
2. Remove auto-save from `handleChange` 
3. Keep local state management for immediate UI feedback
4. Call `onSave()` only for parent state updates (not backend)

**Implementation:**
```typescript
const [profile, setProfile] = useState<ProfileSettings>({
  first_name: '',
  last_name: '',
  email: ''
});

// Sync with incoming props (fixes the loading issue)
useEffect(() => {
  if (initialProfile) {
    setProfile({
      first_name: initialProfile.first_name || '',
      last_name: initialProfile.last_name || '',
      email: initialProfile.email || ''
    });
  }
}, [initialProfile]);

const handleChange = (field: keyof ProfileSettings, value: string) => {
  const updatedProfile = {
    ...profile,
    [field]: value || undefined
  };
  setProfile(updatedProfile);
  
  // Soft save - update parent state only
  const cleanedProfile: ProfileSettings = {
    first_name: updatedProfile.first_name?.trim() || undefined,
    last_name: updatedProfile.last_name?.trim() || undefined,
    email: updatedProfile.email?.trim() || undefined
  };
  onSave(cleanedProfile);  // Updates parent's localSettings, not backend
};
```

### Phase 4: Add Profile Tab to Settings Modal

#### 4.1 Create AccountSettings Component
**File:** `covenantrix-desktop/src/features/settings/AccountSettings.tsx` (create new)

**Features:**
- Display profile fields (first_name, last_name, email)
- Use controlled component pattern with `useEffect` sync (same as ProfileSetupStep fix)
- Soft-save updates to parent `localSettings`
- Privacy notice section
- Optional: Add Google Drive connection status display
- Optional: Add profile picture upload (future enhancement)

**Props:**
```typescript
interface AccountSettingsProps {
  settings: ProfileSettings;
  onChange: (settings: ProfileSettings) => void;
}
```

#### 4.2 Add Account Tab to Settings Modal
**File:** `covenantrix-desktop/src/features/settings/SettingsModal.tsx`

**Changes:**
1. Import `AccountSettings` component
2. Import `User` icon from lucide-react
3. Add `'account'` to `TabType` union
4. Add Account tab to `tabs` array (first position for prominence)
5. Add Account tab render case in content section
6. Pass `localSettings.profile` and onChange handler

**Tab order:**
```typescript
const tabs = [
  { id: 'account', label: 'Account', icon: User },
  { id: 'api-keys', label: 'API Keys', icon: Key },
  { id: 'subscription', label: 'Subscription', icon: CreditCard },
  // ... rest of tabs
];
```

### Phase 5: Update Default Settings Factory Functions

#### 5.1 Frontend Settings Utilities
**File:** `covenantrix-desktop/src/utils/settings.ts` - `getDefaultSettings()` function

Add:
```typescript
onboarding_completed: false,
profile: {
  first_name: undefined,
  last_name: undefined,
  email: undefined
}
```

#### 5.2 Frontend Settings Context
**File:** `covenantrix-desktop/src/contexts/SettingsContext.tsx` - `getDefaultSettings()` function

Add same defaults as above.

#### 5.3 Settings Validation
**File:** `covenantrix-desktop/src/utils/settings.ts` - `validateAndNormalizeSettings()` function

Ensure `onboarding_completed` and `profile` fields are properly normalized:
```typescript
return {
  onboarding_completed: settings?.onboarding_completed ?? false,
  profile: {
    first_name: settings?.profile?.first_name,
    last_name: settings?.profile?.last_name,
    email: settings?.profile?.email
  },
  // ... rest of fields
};
```

## Files to Modify

### Backend
1. `backend/api/schemas/settings.py` - Add `onboarding_completed` field to `UserSettings`
2. `backend/infrastructure/storage/user_settings_storage.py` - Update migration logic for new field

### Frontend - Types & Utilities
3. `covenantrix-desktop/src/types/settings.ts` - Add `onboarding_completed` to interface
4. `covenantrix-desktop/src/utils/settings.ts` - Update defaults and validation
5. `covenantrix-desktop/src/contexts/SettingsContext.tsx` - Update defaults

### Frontend - Onboarding
6. `covenantrix-desktop/src/hooks/useSettings.ts` - Simplify `isFirstRun` logic
7. `covenantrix-desktop/src/features/onboarding/SettingsSetup.tsx` - Add local state, update completion handler
8. `covenantrix-desktop/src/features/onboarding/ProfileSetupStep.tsx` - Add `useEffect` sync for profile loading

### Frontend - Settings
9. `covenantrix-desktop/src/features/settings/AccountSettings.tsx` - Create new component
10. `covenantrix-desktop/src/features/settings/SettingsModal.tsx` - Add Account tab

## Expected Behavior After Implementation

### Onboarding Trigger
- ✅ Shows only on truly first run (onboarding_completed = false/undefined)
- ✅ Never shows again after completion unless flag manually reset
- ✅ Persists through settings resets (flag independent of other settings)

### Profile Data Display
- ✅ ProfileSetupStep shows saved profile data when onboarding opens
- ✅ AccountSettings tab shows saved profile data when settings modal opens
- ✅ Works correctly even when data loads after component mount

### Soft-Save Consistency
- ✅ Both onboarding and settings use local state for changes
- ✅ Changes are batched and saved together
- ✅ User can review all changes before final save
- ✅ Can navigate between steps/tabs without losing unsaved changes
- ✅ Can cancel/close without persisting if desired

### User Experience
- ✅ Onboarding: All fields editable, changes saved on completion
- ✅ Settings: All fields editable, changes saved on "Save & Apply"
- ✅ Consistent behavior across both flows
- ✅ Clear indication of unsaved changes in settings modal
- ✅ Profile information accessible and editable post-onboarding

## Testing Checklist

### Onboarding Trigger
- [ ] Fresh install shows onboarding wizard
- [ ] Completing onboarding sets flag and never shows again
- [ ] Skipping onboarding sets flag and never shows again
- [ ] Resetting settings to defaults does NOT trigger onboarding
- [ ] Manually setting flag to false re-triggers onboarding

### Profile Data Loading
- [ ] Enter profile data in onboarding, complete wizard
- [ ] Restart app, open settings → Account tab
- [ ] Verify profile data displays correctly
- [ ] Enter profile data in settings, save
- [ ] Restart app, verify data persists

### Soft-Save Behavior
- [ ] Onboarding: Navigate between steps without losing data
- [ ] Onboarding: Close wizard (skip) without saving changes
- [ ] Settings: Make changes across multiple tabs
- [ ] Settings: Close without saving → changes discarded
- [ ] Settings: Save & Apply → all changes persisted at once

### Edge Cases
- [ ] Empty/null profile fields handled gracefully
- [ ] Profile fields with whitespace-only values trimmed to undefined
- [ ] Unicode characters in names handled correctly
- [ ] Email validation (format) - optional enhancement
- [ ] Very long name values (truncation/validation) - optional enhancement

## Migration Strategy

### Existing Users
- Backend migration automatically adds `onboarding_completed: false` to existing settings
- First app launch after update will NOT show onboarding (preserves current experience)
- Users can access all settings including new Account tab without re-onboarding

### New Users (Post-Update)
- Shows onboarding wizard on first launch
- Profile data collected during onboarding
- Flag set to true on completion
- Full settings access including Account tab

### Developer Reset
- To test onboarding again, manually edit `user_settings.json` and set `"onboarding_completed": false`
- Or delete settings file entirely for clean slate

