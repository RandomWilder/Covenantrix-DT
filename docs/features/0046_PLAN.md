# Feature 0046: Protect Subscription Tier from Settings Update Override

## Description

Fix critical bug where user subscription tier gets reset from `paid` back to `trial` when settings are updated. The issue occurs because the frontend sends the entire settings object (including stale subscription data) to the backend, which blindly overwrites the current subscription state. This happens after successful license activation when any settings update is triggered (e.g., changing UI preferences, API keys, or RAG settings).

**Current Behavior:**
1. User activates paid license → tier changes from `trial` to `paid` ✅
2. Settings dialog updates any setting → frontend sends entire settings object with old `tier: 'trial'` ⚠️
3. Backend saves the entire payload → paid tier gets overwritten back to `trial` ❌

**Expected Behavior:**
Subscription tier should only be modifiable through dedicated subscription management endpoints (`/api/subscription/activate`, `/api/subscription/upgrade-tier`), not through general settings updates.

## Root Cause

**Frontend Issue (`covenantrix-desktop/src/contexts/SettingsContext.tsx`):**
- Lines 106-120: `updateSettings()` sends the entire settings object to backend
- The subscription field includes whatever is currently in the frontend's local state
- After license activation, frontend state is not refreshed, so it still contains `tier: 'trial'`

**Backend Issue (`backend/api/routes/settings.py`):**
- Line 235: `update_settings()` endpoint accepts and saves the entire settings payload without protecting subscription data
- No validation or preservation of existing subscription state
- Subscription data should be treated as read-only in this endpoint

## Files to Modify

### Backend Changes

**File: `backend/api/routes/settings.py`**

**Function: `update_settings()` (lines 166-252)**
- Add protection logic before saving settings
- Load current settings from storage to get existing subscription state
- Replace incoming subscription data with preserved subscription data from disk
- Ensure subscription can only be modified through subscription-specific endpoints

**Algorithm:**
1. Validate API keys and tier compatibility (existing logic)
2. **NEW:** Load current settings from storage: `current_settings = await settings_storage.load_settings()`
3. **NEW:** Preserve subscription data: `request.settings.subscription = current_settings.subscription`
4. Update timestamp
5. Save settings (now with protected subscription data)
6. Return response

### Optional Enhancement

**File: `backend/infrastructure/storage/user_settings_storage.py`**

**Function: `_migrate_settings()` (lines 117-256)**
- Add detection and logging when subscription tier unexpectedly changes during settings migration
- This serves as an additional safeguard to catch similar issues in the future
- Log warning if subscription tier differs between incoming data and stored data

**Algorithm:**
1. During migration, check if incoming subscription tier differs from stored tier
2. If tier changed and no license activation occurred recently, log warning
3. Preserve stored subscription tier over incoming tier
4. Continue with normal migration logic

## Implementation Notes

### Why Backend Protection is Optimal

1. **Separation of Concerns:** Settings updates handle configuration; subscription management handles tier changes
2. **Security:** Prevents any client (UI, scripts, API calls) from accidentally or maliciously modifying subscription state
3. **Single Point of Control:** All subscription modifications must go through dedicated endpoints with proper validation
4. **Minimal Impact:** One-line change in settings endpoint; no frontend modifications required
5. **Future-Proof:** Protects against similar issues if new settings update paths are added

### Alternative Approaches Considered (Not Recommended)

**Frontend State Refresh:**
- Reload settings after license activation to sync subscription state
- Issue: Doesn't prevent root cause; race conditions possible; multiple update points needed

**Exclude Subscription from Updates:**
- Strip subscription field before sending to backend
- Issue: Fragile; easy to forget in future code; doesn't prevent direct API manipulation

## Testing Verification

After implementation, verify the following scenario:
1. User starts with `trial` tier
2. User activates paid license via JWT → tier becomes `paid`
3. User opens Settings dialog and changes any setting (e.g., LLM model, theme, language)
4. Settings are saved successfully
5. **Verify:** Subscription tier remains `paid` (not reset to `trial`)
6. **Verify:** Only `/api/subscription/activate` and `/api/subscription/upgrade-tier` can modify tier

## Affected Endpoints

**Protected Endpoints (subscription state preserved):**
- `POST /api/settings` - Update user settings (general configuration)

**Subscription Management Endpoints (tier modification allowed):**
- `POST /api/subscription/activate` - Activate license key
- `POST /api/subscription/upgrade-tier` - Manual tier upgrade
- `POST /api/subscription/deactivate` - Deactivate license

## Related Files (No Changes Required)

- `covenantrix-desktop/src/contexts/SettingsContext.tsx` - Frontend settings management
- `covenantrix-desktop/src/types/settings.ts` - Settings type definitions
- `covenantrix-desktop/src/utils/settings.ts` - Settings utilities
- `backend/api/schemas/settings.py` - Settings schema definitions
- `backend/domain/subscription/service.py` - Subscription service logic

