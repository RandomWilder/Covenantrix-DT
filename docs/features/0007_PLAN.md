# OCR Tool Integration for LightRAG Processing - Technical Plan

## Overview

Implementation of Google Vision API OCR tool integration into the LightRAG document processing pipeline. The OCR tool will be deployed as a fallback mechanism when standard text extraction methods fail to extract sufficient text from documents. The system will use Google Vision API for all OCR purposes, with proper integration into the existing document processing architecture while maintaining separation of concerns.

## Architecture Components

### Infrastructure Layer (External Integrations)

**Files to Create:**
- `backend/infrastructure/external/google_vision_client.py` - Google Vision API client implementation
- `backend/infrastructure/external/google_vision_ocr.py` - OCR-specific Google Vision integration

**Files to Modify:**
- `backend/domain/integrations/ocr.py` - **ENHANCE** existing OCRService with Google Vision API integration
- `backend/infrastructure/ai/document_processor.py` - **MODIFY** DocumentProcessor to use OCR as fallback

**Key Implementation Details:**
1. **Google Vision API Client** - Async HTTP client with proper authentication
2. **OCR Service Enhancement** - Replace pytesseract with Google Vision API calls
3. **Fallback Logic** - OCR only triggers when standard extraction fails or produces low-quality text
4. **Error Handling** - Graceful degradation when Google Vision API is unavailable
5. **Settings Integration** - OCR enable/disable and language preferences

### Domain Layer (Business Logic)

**Files to Modify:**
- `backend/domain/documents/service.py` - **ENHANCE** process_document method to track OCR usage
- `backend/domain/documents/models.py` - **ENHANCE** ProcessingResult to properly track OCR application

**Key Changes:**
1. **OCR Tracking** - Properly set `ocr_applied` flag when OCR is used
2. **Quality Validation** - Enhanced content validation with OCR fallback
3. **Processing Results** - Track OCR confidence and processing time
4. **Settings Integration** - OCR service respects user settings for enable/disable

### API Layer (Integration)

**Files to Modify:**
- `backend/api/routes/documents.py` - **ENHANCE** upload endpoints to handle OCR fallback
- `backend/core/dependencies.py` - **ADD** OCR service dependencies
- `backend/core/config.py` - **ADD** Google Vision API configuration

**Key Changes:**
1. **Upload Processing** - Enhanced document upload to use OCR fallback
2. **Batch Processing** - OCR support in batch upload operations
3. **Dependency Injection** - Wire OCR service into document processing pipeline
4. **Configuration Management** - Google Vision API key management

## Implementation Phases

### Phase 1: Google Vision API Integration

**Google Vision API Client:**
1. **Create GoogleVisionClient** (`backend/infrastructure/external/google_vision_client.py`)
   - Implement async HTTP client with Google Vision API v1
   - Add proper authentication using service account credentials
   - Handle image and PDF processing with appropriate API endpoints
   - Implement retry logic and error handling
   - Support multiple image formats (PNG, JPG, TIFF, BMP)

2. **Create GoogleVisionOCR** (`backend/infrastructure/external/google_vision_ocr.py`)
   - Implement OCR-specific methods for text extraction
   - Add confidence scoring and quality validation
   - Support language detection and preference settings
   - Handle batch processing for multiple images
   - Implement proper error handling and fallback

**OCR Service Enhancement:**
3. **Enhance OCRService** (`backend/domain/integrations/ocr.py`)
   - Replace pytesseract implementation with Google Vision API calls
   - Add proper Google Vision API integration methods
   - Implement confidence scoring and quality validation
   - Add language preference support
   - Maintain backward compatibility with existing interface

### Phase 2: DocumentProcessor Integration

**Fallback Logic Implementation:**
4. **Modify DocumentProcessor.extract_text()** (`backend/infrastructure/ai/document_processor.py`)
   - Add fallback logic: try standard extraction first
   - If no text extracted or quality is low, attempt OCR
   - Implement quality threshold for OCR triggering
   - Track OCR usage in processing results
   - Maintain existing extraction methods for non-image files

5. **Enhance Content Validation**
   - Improve `validate_content()` method to detect low-quality text
   - Add OCR-specific quality checks
   - Implement confidence-based validation
   - Add minimum character count and quality thresholds

**Processing Flow Enhancement:**
6. **Update Document Processing Pipeline**
   - Standard extraction → Quality validation → OCR fallback if needed
   - Proper tracking of OCR usage in processing results
   - Enhanced error handling for OCR failures
   - Maintain existing processing flow for successful extractions

### Phase 3: API Integration

**Document Upload Enhancement:**
7. **Update Document Upload Routes** (`backend/api/routes/documents.py`)
   - Modify single document upload to use OCR fallback
   - Update batch upload processing with OCR support
   - Add OCR status to response models
   - Implement proper error handling for OCR failures

8. **Enhance Response Models**
   - Add OCR usage tracking to upload responses
   - Include OCR confidence scores in processing results
   - Add OCR processing time to response metadata
   - Maintain backward compatibility with existing responses

**Dependency Injection:**
9. **Update Core Dependencies** (`backend/core/dependencies.py`)
   - Add OCR service dependency injection
   - Wire Google Vision API client into document processing
   - Add proper service initialization and configuration
   - Implement dependency resolution for OCR services

### Phase 4: Configuration & Settings

**Settings Integration:**
10. **Update Configuration** (`backend/core/config.py`)
    - Add Google Vision API key configuration
    - Add OCR enable/disable settings
    - Add language preference configuration
    - Add OCR quality thresholds and settings

11. **Settings API Enhancement**
    - Update settings endpoints to handle OCR configuration
    - Add OCR service status endpoints
    - Implement OCR settings validation
    - Add OCR service health checks

## Key Algorithms

### OCR Fallback Algorithm
```
1. Attempt standard text extraction (PDF, DOCX, etc.)
2. Validate extracted content quality
3. If quality < threshold OR no text extracted:
   a. Check if OCR is enabled in settings
   b. Validate file format supports OCR
   c. Call Google Vision API for OCR processing
   d. Validate OCR result quality
   e. Use OCR text if quality is acceptable
4. Mark ocr_applied=True if OCR was used
5. Return extracted text with processing metadata
```

### Content Quality Validation Algorithm
```
1. Check minimum character count (default: 50 characters)
2. Calculate letter-to-total-character ratio (minimum: 0.5)
3. Check for gibberish patterns and corruption
4. Validate text structure and readability
5. If quality fails, trigger OCR fallback
6. Return quality score and validation result
```

### Google Vision API Processing Algorithm
```
1. Validate image format and size limits
2. Prepare image for Google Vision API (base64 encoding)
3. Configure API request with language preferences
4. Send request to Google Vision API with retry logic
5. Parse response and extract text content
6. Calculate confidence score from API response
7. Validate OCR result quality and confidence
8. Return processed text with metadata
```

## Configuration Requirements

### Environment Variables
```bash
# Google Vision API Configuration
GOOGLE_VISION_API_KEY=your_google_vision_api_key
GOOGLE_VISION_PROJECT_ID=your_google_cloud_project_id
GOOGLE_APPLICATION_CREDENTIALS=path/to/service-account.json

# OCR Settings
OCR_ENABLED=true
OCR_MIN_CONFIDENCE=0.6
OCR_MIN_CHAR_COUNT=50
OCR_PREFERRED_LANGUAGE=en
```

### API Configuration
- **Google Vision API**: Text detection and document text detection
- **Rate Limits**: 1,800 requests/minute (free tier)
- **File Size Limits**: 20MB per image, 2,000 pages per PDF
- **Supported Formats**: PNG, JPG, TIFF, BMP, PDF

## Error Handling Strategy

### Graceful Degradation
1. **Google Vision API Failure** - Fallback to pytesseract if available
2. **OCR Processing Failure** - Return original extraction result
3. **Quality Validation Failure** - Attempt OCR with lower thresholds
4. **Network Timeout** - Retry with exponential backoff

### Error Types
- `GoogleVisionAPIError` - Google Vision API service unavailable
- `OCRProcessingError` - OCR text extraction failed
- `QualityValidationError` - Content quality below thresholds
- `ConfigurationError` - OCR settings or API key issues

## Performance Considerations

### Processing Time Optimization
- **Standard Extraction**: < 2 seconds for most documents
- **OCR Processing**: < 10 seconds for images, < 30 seconds for PDFs
- **Quality Validation**: < 1 second for content analysis
- **Total Processing**: < 35 seconds including OCR fallback

### Caching Strategy
- **OCR Results Cache** - Cache OCR results for identical images (1 hour TTL)
- **Quality Validation Cache** - Cache validation results for content analysis
- **Settings Cache** - Cache OCR settings to avoid repeated lookups

## Security Considerations

### API Key Management
- Store Google Vision API key securely in environment variables
- Use existing `APIKeyManager` for secure storage
- Implement key rotation for production environments
- Add API key validation in configuration startup

### Data Privacy
- Images sent to Google Vision API for OCR processing
- No personal data stored in OCR results
- Implement data retention policies for OCR cache
- Add audit logging for OCR usage

## Monitoring & Logging

### Key Metrics
- OCR usage frequency and success rates
- Google Vision API response times and error rates
- Content quality validation statistics
- Processing time distribution (standard vs OCR)

### Logging Strategy
- Log all OCR processing attempts with results
- Track Google Vision API usage and costs
- Monitor content quality validation metrics
- Log OCR fallback triggers and success rates

## Dependencies

### New Python Packages
```txt
google-cloud-vision>=3.4.0  # Google Vision API client
google-auth>=2.23.0         # Google authentication
google-auth-oauthlib>=1.1.0 # OAuth2 authentication
```

### External Services
- **Google Vision API** - Primary OCR service
- **Google Cloud Platform** - Authentication and billing
- **Existing pytesseract** - Fallback OCR service

## Integration Points

### Document Processing Flow
1. **File Upload** → **Standard Extraction** → **Quality Validation** → **OCR Fallback (if needed)** → **LightRAG Processing**

### Settings Integration
1. **User Settings** → **OCR Configuration** → **Service Initialization** → **Processing Pipeline**

### Error Handling
1. **Processing Error** → **OCR Attempt** → **Quality Check** → **Success/Failure Response**

## Success Criteria

### Functional Requirements
- OCR fallback triggers when standard extraction fails or produces low-quality text
- Google Vision API integration works with proper authentication
- OCR results are properly integrated into LightRAG processing pipeline
- Settings allow users to enable/disable OCR functionality

### Performance Requirements
- OCR processing completes within 30 seconds for typical documents
- System gracefully handles Google Vision API failures
- Processing time increases minimally when OCR is not needed
- OCR results maintain document processing quality standards

### Quality Requirements
- OCR confidence scores are properly tracked and reported
- Content quality validation prevents low-quality OCR results
- OCR fallback only triggers when necessary
- Existing document processing functionality remains unchanged
