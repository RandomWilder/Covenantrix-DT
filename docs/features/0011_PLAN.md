# Feature 0011: Fix Document Upload Progress Streaming

## Overview

Fix critical bugs in Feature 0010 that prevent proper progress stage streaming. Enable all 7 stages (initializing, reading, understanding, building_connections, finalizing, completed, failed) to stream to the frontend with accurate progress counting.

## Technical Approach

Use `asyncio.Queue` to bridge the async callback pattern with the generator yield requirement. This allows the service layer to emit progress events that the route layer can yield as SSE events.

---

## Backend Changes

### 1. Add Queue-Based Progress Streaming

**File:** `backend/api/routes/documents.py`

In the `upload_documents_stream` endpoint's `generate_progress_stream()` function:

**Before processing each file:**
- Create `asyncio.Queue` for progress events
- Define progress callback that puts events into the queue (doesn't yield directly)
- Create background task to run `service.process_document()` with the callback
- While task runs, pull events from queue and yield them as SSE
- Wait for task completion

**Implementation pattern:**
```python
progress_queue = asyncio.Queue()

async def queue_callback(stage: str, percent: int):
    await progress_queue.put({
        'stage': stage,
        'percent': percent
    })

# Run processing in background task
process_task = asyncio.create_task(
    service.process_document(
        document_id=document.id,
        extracted_content=extracted_text,
        processing_time=time.time() - start_time,
        ocr_applied=ocr_used,
        progress_callback=queue_callback
    )
)

# Yield progress events from queue until processing completes
while not process_task.done():
    try:
        event = await asyncio.wait_for(progress_queue.get(), timeout=0.1)
        # Create and yield DocumentProgressEvent
    except asyncio.TimeoutError:
        continue

await process_task  # Ensure task completes and raise any exceptions
```

**Also fix:**
- Track OCR usage from DocumentProcessor (don't hardcode `ocr_applied=False`)
- Update overall progress calculation to include current file progress

---

## Frontend Changes

### 2. Fix Progress Count Duplication

**File:** `covenantrix-desktop/src/hooks/useUpload.ts`

In `uploadLocalFiles()` function, inside the streaming loop:

**Change from:**
```typescript
if (file_progress.stage === 'completed') {
  status = 'completed'
  progress.completed++
}
```

**Change to:**
```typescript
const completedFiles = new Set<string>()
const failedFiles = new Set<string>()

// Inside loop:
if (file_progress.stage === 'completed' && !completedFiles.has(fileItem.id)) {
  status = 'completed'
  progress.completed++
  completedFiles.add(fileItem.id)
} else if (file_progress.stage === 'failed' && !failedFiles.has(fileItem.id)) {
  status = 'failed'
  progress.failed++
  failedFiles.add(fileItem.id)
}
```

---

### 3. Fix Google Drive Upload Signature

**File:** `covenantrix-desktop/src/hooks/useUpload.ts`

Update `uploadGoogleDriveFiles` function signature to match `uploadLocalFiles`:

```typescript
const uploadGoogleDriveFiles = async (
  files: FileItem[],
  progress: UploadProgress,
  updateFileStatus: (
    id: string, 
    status: FileItem['status'], 
    progress?: number, 
    error?: string,
    stage?: DocumentProgressStage,
    stageMessage?: string
  ) => void,
  setUploadProgress: (progress: UploadProgress) => void
)
```

---

### 4. Fix State Mutation

**File:** `covenantrix-desktop/src/hooks/useUpload.ts`

In `uploadLocalFiles()` streaming section, replace direct mutations with tracked counters:

**Change from:**
```typescript
progress.completed++
progress.failed++
```

**Change to:**
```typescript
let completedCount = 0
let failedCount = 0

// In loop, increment local counters
// After loop or on each update:
setUploadProgress({ 
  ...progress, 
  completed: completedCount, 
  failed: failedCount,
  files: [...files] 
})
```

---

## Files to Modify

**Backend:**
1. `backend/api/routes/documents.py` - Add queue-based progress streaming

**Frontend:**
2. `covenantrix-desktop/src/hooks/useUpload.ts` - Fix count duplication, signature, and state mutation

---

## Expected Outcome

Users will see all 7 progress stages streaming in real-time:
1. Initializing (10%)
2. Reading (25%)
3. Understanding (50%)
4. Building connections (75%)
5. Finalizing (90%)
6. Completed (100%)
7. Failed (on error)

Progress counts will be accurate (no duplication), and state updates will trigger proper React re-renders.

