# Document-Specific Query Implementation Plan

## Overview
Implement smart mode switching to achieve 95%+ document isolation by automatically switching to NAIVE mode when documents are selected, eliminating entity cross-contamination while maintaining optimal performance. The system will use pure chunk retrieval for document-specific queries and graph-enhanced retrieval for global queries.

## Core Algorithm
**Smart Mode Selection Logic:**
1. If `document_ids` provided → Force NAIVE mode + chunk filtering
2. If no `document_ids` → Use configured mode (HYBRID/MIX)
3. Map document IDs to chunk IDs using DocumentChunkMapper
4. Execute query with appropriate parameters

## Files to Modify

### Phase 1: Core Engine Changes

#### `backend/infrastructure/ai/rag_engine.py`
- **Method:** `query()` (line ~398)
  - Add `document_ids: Optional[List[str]] = None` parameter
  - Implement smart mode selection logic
  - Add chunk ID mapping for document filtering
  - Update logging to distinguish scoped vs unscoped queries
  - Return mode information in response

- **Method:** `query_stream()` (line ~472)
  - Apply identical logic as `query()` method
  - Add `document_ids` parameter
  - Same smart mode selection and chunk filtering

#### `backend/infrastructure/ai/document_chunk_mapper.py`
- **Status:** Already implemented (verify functionality)
- **Verify:** `map_documents_to_chunk_ids()` method works correctly
- **Verify:** Handles invalid document IDs gracefully
- **Verify:** Logs mapping operations

### Phase 2: Service Integration

#### `backend/domain/chat/service.py`
- **Method:** `send_message_stream()` (line ~241-244)
  - Pass `selected_documents` to RAG query as `document_ids`
  - Ensure both streaming and non-streaming paths support document filtering

#### `backend/domain/documents/service.py`
- **Method:** `query_documents()` (line ~523)
  - Add `document_ids: Optional[List[str]] = None` parameter
  - Remove existing warning about document filtering
  - Pass `document_ids` to RAG engine

#### `backend/infrastructure/ai/agent_data_access.py`
- **Method:** `query_documents()` (lines ~108, 114)
  - Add `document_ids: Optional[List[str]] = None` parameter
  - Pass through to RAG engine

#### `backend/infrastructure/storage/lightrag_storage.py`
- **Method:** `query_documents()` (line ~89)
  - Add `document_ids: Optional[List[str]] = None` parameter
  - Pass through to RAG engine

### Phase 3: UI Feedback (Optional)

#### `covenantrix-desktop/src/features/chat/ChatScreen.tsx`
- Add visual indicator showing query mode
- Display "Focused mode" when documents selected
- Display "Graph-enhanced mode" when no documents selected
- Use existing design system components

## Implementation Details

### Smart Mode Selection Logic
```python
if document_ids:
    # Document-specific → FORCE naive mode
    effective_mode = "naive"
    chunk_ids, _ = mapper.map_documents_to_chunk_ids(document_ids)
    params = QueryParam(
        mode="naive",
        top_k=top_k or self.top_k or 5,
        only_need_context=only_context,
        ids=chunk_ids if chunk_ids else None
    )
else:
    # Global query → use configured mode
    effective_mode = mode or self.search_mode or "hybrid"
    params = QueryParam(
        mode=effective_mode,
        top_k=top_k or self.top_k or 5,
        only_need_context=only_context,
        enable_rerank=self.use_reranking and effective_mode in ["hybrid", "mix"]
    )
```

### Performance Considerations
- **No overhead when not filtering:** `document_ids=None` → direct pass-through
- **Naive mode is faster:** No graph traversal, smaller context, lower token usage
- **Chunk mapping is O(n):** Where n = number of selected documents (typically < 10)

### Error Handling
- Graceful handling of invalid document IDs
- Fallback to global query if mapping fails
- Maintain backward compatibility

## Testing Strategy

### Test Cases
1. **Single Document Isolation:** Select one document, verify no cross-contamination
2. **Multi-Document Scope:** Select multiple documents, verify content from all
3. **Global Query:** No selection, verify graph-enhanced mode
4. **Hebrew Language:** Test with Hebrew documents and queries

### Validation Checklist
- [ ] NAIVE mode activated when documents selected
- [ ] HYBRID/MIX mode used when no selection
- [ ] Chunk IDs correctly mapped
- [ ] No entity leakage in document-specific queries
- [ ] Backward compatibility maintained
- [ ] Performance acceptable (< 3s queries)
- [ ] UI indicator shows mode (optional)
- [ ] Logging tracks scoped vs unscoped queries
- [ ] Hebrew queries work correctly
- [ ] Error handling for invalid document IDs

## Success Metrics
- Document Isolation Accuracy: 95%+
- Query Speed (Scoped): < 2.5s
- Query Speed (Global): < 3s
- Zero Cross-Document Leaks: 100%
- Backward Compatibility: 100%

## Rollback Plan
If issues arise:
1. Set `document_ids=None` in all service calls
2. System reverts to current behavior
3. No data loss, no breaking changes
