# Spell Check Context Menu Feature - Technical Plan

## Overview
Implement a spell correction feature that provides industry-standard right-click context menu functionality for misspelled words in the chat input field. The feature will detect misspelled words (already showing red zigzag underlines) and display a custom context menu with spelling suggestions when users right-click on them.

## Current State Analysis

### Existing Implementation
- **Chat Input Component**: `covenantrix-desktop/src/features/chat/ChatInput.tsx` - Uses HTML textarea with native browser spell check
- **Browser Spell Check**: Already enabled and showing red zigzag underlines for typos
- **Context Menu**: Currently no custom context menu implementation exists
- **UI Framework**: React + TypeScript + Tailwind CSS + Lucide React icons

### Key Files Identified
- `covenantrix-desktop/src/features/chat/ChatInput.tsx` - Main input component (lines 48-67)
- `covenantrix-desktop/src/features/chat/ChatPanel.tsx` - Parent component using ChatInput
- No existing context menu or dropdown components found

## Technical Implementation Plan

### Phase 1: Core Infrastructure

#### 1.1 Create Context Menu Component
**File**: `covenantrix-desktop/src/components/ui/ContextMenu.tsx`

**Purpose**: Reusable context menu component for spell check suggestions

**Features**:
- Positioned absolutely at cursor location
- Dark/light theme support matching existing design
- Keyboard navigation support (arrow keys, enter, escape)
- Click outside to close functionality
- Smooth animations using Tailwind CSS

**Props Interface**:
```typescript
interface ContextMenuProps {
  isVisible: boolean
  position: { x: number; y: number }
  suggestions: string[]
  onSelect: (suggestion: string) => void
  onClose: () => void
  onAddToDictionary?: () => void
}
```

#### 1.2 Create Spell Check Service
**File**: `covenantrix-desktop/src/services/spellCheckService.ts`

**Purpose**: Handle spell checking logic and suggestion generation

**Features**:
- Detect misspelled words using browser's native spell check
- Generate spelling suggestions using browser's native APIs and simple word matching
- Cache suggestions for performance
- Support for multiple languages using browser's language detection

**Dependencies**: 
- **Zero external dependencies** - Uses browser's native spell check APIs only
- Leverages existing React/TypeScript capabilities
- No additional npm packages required

#### 1.3 Create Spell Check Hook
**File**: `covenantrix-desktop/src/hooks/useSpellCheck.ts`

**Purpose**: React hook to manage spell check state and context menu

**Features**:
- Track context menu visibility and position
- Manage spell check suggestions
- Handle word selection and replacement
- Integrate with existing textarea ref

### Phase 2: Integration

#### 2.1 Update ChatInput Component
**File**: `covenantrix-desktop/src/features/chat/ChatInput.tsx`

**Changes Required**:
- Add `onContextMenu` event handler to textarea (line 51-67)
- Integrate `useSpellCheck` hook
- Add context menu positioning logic
- Prevent default context menu when spell suggestions are available

**Key Modifications**:
```typescript
// Add to existing textarea props
onContextMenu={handleContextMenu}
```

#### 2.2 No New Dependencies Required
**File**: `covenantrix-desktop/package.json`

**Dependencies**: 
- **No new dependencies needed** - Uses browser's native spell check APIs
- Leverages existing React, TypeScript, and Tailwind CSS
- Zero bundle size increase

### Phase 3: User Experience Enhancements

#### 3.1 Context Menu Styling
- Match existing application design system
- Use consistent colors from Tailwind config
- Implement smooth fade-in/out animations
- Ensure proper z-index layering

#### 3.2 Accessibility Features
- Keyboard navigation (arrow keys, enter, escape)
- Screen reader support with proper ARIA labels
- Focus management when context menu opens/closes

#### 3.3 Performance Optimizations
- Debounce spell check requests
- Cache suggestions for repeated words
- **No external library loading** - Uses browser's native APIs only

## Implementation Algorithm

### Context Menu Detection Flow
1. **Right-click Detection**: Listen for `contextmenu` event on textarea
2. **Word Extraction**: Get word at cursor position using `getWordAtCursor()`
3. **Spell Check**: Determine if word is misspelled using browser's native spell check
4. **Suggestion Generation**: If misspelled, generate suggestions using browser APIs and simple word matching
5. **Context Menu Display**: Show custom context menu with suggestions
6. **Word Replacement**: On suggestion selection, replace word in textarea

### Word Selection Algorithm
```typescript
function getWordAtCursor(textarea: HTMLTextAreaElement, x: number, y: number): string {
  // Get cursor position from mouse coordinates
  // Extract word boundaries using regex
  // Return the word under cursor
}
```

### Context Menu Positioning
```typescript
function calculateMenuPosition(event: MouseEvent): { x: number; y: number } {
  // Position menu at cursor location
  // Ensure menu stays within viewport bounds
  // Adjust for scroll position
}
```

## Files to Create/Modify

### New Files
1. `covenantrix-desktop/src/components/ui/ContextMenu.tsx` - Context menu component
2. `covenantrix-desktop/src/services/spellCheckService.ts` - Spell check logic
3. `covenantrix-desktop/src/hooks/useSpellCheck.ts` - React hook for spell check

### Modified Files
1. `covenantrix-desktop/src/features/chat/ChatInput.tsx` - Add context menu integration
2. **No package.json changes needed** - Zero dependencies approach

## Dependencies

### New Dependencies
- **Zero new dependencies** - Uses browser's native spell check APIs only
- No additional UI libraries needed (using existing Tailwind + Lucide React)

### Existing Dependencies Used
- React hooks (useState, useRef, useCallback)
- Tailwind CSS for styling
- Lucide React for icons
- TypeScript for type safety
- Browser's native spell check APIs

## Separation of Concerns

### Component Layer
- `ContextMenu.tsx` - Pure UI component, no business logic
- `ChatInput.tsx` - Integration point, minimal changes to existing component

### Service Layer
- `spellCheckService.ts` - Pure spell checking logic, no UI dependencies
- Reusable across different text input components

### Hook Layer
- `useSpellCheck.ts` - React-specific state management
- Encapsulates spell check logic for easy testing and reuse

## Minimal Disruption Strategy

### Existing Code Preservation
- No changes to existing ChatInput functionality
- Maintain all current props and behavior
- Add new features as optional enhancements

### Backward Compatibility
- Feature gracefully degrades if browser spell check is unavailable
- No impact on existing chat functionality
- Context menu only appears for misspelled words
- Uses browser's native capabilities (more reliable than external libraries)

### Performance Impact
- **Zero performance overhead** - Uses browser's native APIs only
- Debounced spell check to prevent excessive API calls
- Minimal memory footprint with efficient caching
- No external library loading or initialization

## Testing Strategy

### Unit Tests
- Context menu component rendering
- Spell check service accuracy
- Hook state management

### Integration Tests
- Right-click behavior on misspelled words
- Context menu positioning
- Word replacement functionality

### User Experience Tests
- Keyboard navigation
- Accessibility compliance
- Cross-browser compatibility

## Success Criteria

### Functional Requirements
- Right-click on misspelled word shows context menu with suggestions
- Clicking suggestion replaces the misspelled word
- Context menu closes on selection or click outside
- Keyboard navigation works properly

### Non-Functional Requirements
- No performance impact on existing chat functionality
- Consistent with application design system
- Accessible to users with disabilities
- Works across different browsers and operating systems
