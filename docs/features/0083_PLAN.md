# Feature 0083: JWT System & Tier Integration Alignment

## Overview

Fix critical gaps in the JWT-based subscription system where tier limits are defined but not consistently enforced across the application. The subscription service exists in isolation rather than being integrated into core business logic, leading to missing enforcement of document upload limits, query quotas, and API key mode restrictions.

## Current State Analysis

**JWT System:** ✅ Complete - JWT validation, tier configuration, usage tracking
**Tier Enforcement:** ❌ Missing - Limits defined but not enforced at operation level
**Service Integration:** ❌ Incomplete - Subscription service isolated from core business logic
**Configuration Alignment:** ❌ Gap - JWT features vs hardcoded tier config conflict

## Phase 1: Core Enforcement Integration (Data Layer)

**Goal:** Integrate subscription checks into core service initialization and add enforcement middleware

### 1.1 Subscription-Aware Service Initialization

**Files to modify:**
- `backend/core/dependencies.py` - Add subscription checks to service dependencies
- `backend/infrastructure/ai/rag_engine.py` - Add tier-based initialization
- `backend/domain/documents/service.py` - Add upload limit enforcement

**Changes:**
- Modify `get_rag_engine()` to check subscription limits before initialization
- Add `get_subscription_aware_document_service()` that enforces upload limits
- Update service dependency chain to include subscription validation

### 1.2 Tier Enforcement Middleware

**Files to create:**
- `backend/api/middleware/subscription_enforcement.py` - New middleware for tier enforcement

**Files to modify:**
- `backend/main.py` - Register subscription middleware
- `backend/api/routes/documents.py` - Add upload limit checks
- `backend/api/routes/chat.py` - Add query limit checks

**Implementation:**
- Create middleware that checks subscription limits before processing requests
- Add `check_upload_allowed()` calls in document upload endpoints
- Add `check_query_allowed()` calls in chat/query endpoints
- Return HTTP 403 with tier-specific error messages when limits exceeded

### 1.3 JWT Feature Override System

**Files to modify:**
- `backend/domain/subscription/tier_config.py` - Add JWT feature override logic
- `backend/domain/subscription/service.py` - Update feature flag resolution

**Changes:**
- Modify `get_tier_features()` to accept JWT features as override
- Update `SubscriptionService.activate_license()` to use JWT features when available
- Ensure JWT features take precedence over hardcoded tier limits

## Phase 2: API Endpoint Integration (Business Logic)

**Goal:** Enforce tier limits in all API endpoints that consume resources

### 2.1 Document Upload Enforcement

**Files to modify:**
- `backend/api/routes/documents.py` - Add upload limit checks
- `backend/domain/documents/service.py` - Add tier-aware document processing

**Implementation:**
- Add `subscription_service.check_upload_allowed()` before document processing
- Implement document count limits (3 for free/trial, unlimited for paid)
- Add file size validation based on tier limits
- Return appropriate error responses when limits exceeded

### 2.2 Query Limit Enforcement

**Files to modify:**
- `backend/api/routes/chat.py` - Add query limit checks
- `backend/api/routes/queries.py` - Add query limit checks
- `backend/domain/chat/service.py` - Add tier-aware query processing

**Implementation:**
- Add `subscription_service.check_query_allowed()` before query processing
- Implement monthly/daily query limits based on tier
- Track query usage via `subscription_service.record_query()`
- Return appropriate error responses when limits exceeded

### 2.3 API Key Mode Enforcement

**Files to modify:**
- `backend/core/api_key_resolver.py` - Add subscription-aware key resolution
- `backend/api/routes/settings.py` - Enhance API key mode validation

**Implementation:**
- Check `subscription.features.use_default_keys` before allowing default mode
- Enforce custom key requirement for free/paid_limited tiers
- Update key resolution to respect tier-based restrictions

## Phase 3: Service Degradation & User Experience (UI Integration)

**Goal:** Implement tier-based service degradation and user notifications

### 3.1 Service Availability Checks

**Files to modify:**
- `backend/core/dependencies.py` - Add tier-based service availability
- `backend/api/routes/health.py` - Add subscription status to health checks

**Implementation:**
- Add `subscription_service_available()` dependency check
- Implement graceful degradation when subscription limits exceeded
- Add subscription status to health endpoint responses

### 3.2 Tier Transition Notifications

**Files to modify:**
- `backend/domain/subscription/service.py` - Enhance transition notifications
- `backend/api/routes/subscription.py` - Add tier status endpoints

**Implementation:**
- Improve notification messages for tier transitions
- Add real-time tier status updates
- Implement usage warnings before limits are reached

### 3.3 Frontend Integration Points

**Files to modify:**
- `covenantrix-desktop/src/contexts/SettingsContext.tsx` - Add subscription status
- `covenantrix-desktop/src/features/settings/SettingsModal.tsx` - Add tier indicators

**Implementation:**
- Display current tier and remaining quotas in UI
- Show tier-specific feature availability
- Add upgrade prompts when limits approached

## Testing Strategy

**Phase 1 Testing:**
- Verify subscription middleware blocks requests when limits exceeded
- Test JWT feature override functionality
- Confirm service initialization respects tier limits

**Phase 2 Testing:**
- Test document upload limits (3 docs for free, unlimited for paid)
- Test query limits (50/month + 20/day for free, unlimited for paid)
- Verify API key mode enforcement

**Phase 3 Testing:**
- Test tier transition notifications
- Verify service degradation when limits exceeded
- Confirm UI displays correct tier status and limits

## Success Criteria

- All API endpoints enforce subscription limits
- JWT features override hardcoded tier configuration
- Service initialization respects tier-based restrictions
- Users receive clear feedback when limits exceeded
- Tier transitions trigger appropriate notifications
