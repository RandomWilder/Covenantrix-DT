# Feature 0019: Version Update Notification Alignment

## Overview
Fix text formatting and button functionality issues in the version update notification. The notification displays markdown symbols (`**`) as raw text, and the "Download Now" button is unresponsive. This plan addresses alignment issues and potential test code interference with minimal code changes.

## Issues Identified

### 1. Text Formatting Issue
**Location:** `covenantrix-desktop/src/features/notifications/NotificationCard.tsx` (lines 78-84)

**Problem:** 
- Notification content is displayed with `whitespace-pre-wrap` which preserves formatting but doesn't process markdown
- The `formatReleaseNotes()` function in `updater.js` (line 145) returns content with markdown syntax like `**Current Version:**` and `**New Version:**`
- Users see raw markdown symbols instead of bold text

**Root Cause:**
The content field contains markdown-formatted text but the NotificationCard component renders it as plain text without markdown processing.

### 2. "Download Now" Button Unresponsive
**Location:** `covenantrix-desktop/src/contexts/NotificationContext.tsx` (lines 78-135)

**Current Flow:**
1. Button click triggers `onAction(notification.id, action.action)` (NotificationCard.tsx line 130)
2. `handleAction` is called with notificationId and action='download_update' (NotificationContext.tsx line 86)
3. Handler calls `window.electronAPI.update.download()` (line 88)
4. IPC handler invokes `autoUpdater.downloadUpdate()` (ipc-handlers.js line 784)

**Potential Issues:**
- Action string mismatch (casing, typos)
- Event bubbling preventing click handler execution
- Missing or incorrect IPC handler registration
- Environment check failing (not in Electron mode)
- Silent error swallowing in async handler

### 3. "Later" Button Works Correctly
**Location:** `covenantrix-desktop/src/contexts/NotificationContext.tsx` (lines 118-127)

**Confirmed:** The "dismiss" action properly marks notification as read and collapses it. No changes needed.

---

## Investigation Steps (Before Code Changes)

### Step 1: Verify IPC Handler Registration
**File:** `covenantrix-desktop/electron/main.js`

Check that update handlers are registered on app initialization:
- Confirm `registerUpdateHandlers()` is called
- Verify timing (must be called before any IPC messages)
- Check for any conditional logic that might skip registration

### Step 2: Check Button Rendering
**File:** `covenantrix-desktop/src/features/notifications/NotificationCard.tsx`

Verify that:
- `notification.actions` array is populated correctly
- Actions contain proper structure: `{ label: 'Download Now', action: 'download_update' }`
- Button is not hidden by conditional rendering (line 123 conditions)
- No CSS preventing clicks (z-index, pointer-events, overlay)

### Step 3: Test Action Handler Execution
**File:** `covenantrix-desktop/src/contexts/NotificationContext.tsx`

Add console logging to verify:
- `handleAction` is called when button is clicked
- Action string value is exactly 'download_update'
- `isElectron()` check returns true
- No exception thrown in switch statement
- IPC call succeeds without error

### Step 4: Trace IPC Communication
**Files:** 
- `covenantrix-desktop/electron/preload.js` (lines 56-59)
- `covenantrix-desktop/electron/ipc-handlers.js` (lines 781-790)

Verify:
- `window.electronAPI.update.download` is defined in renderer
- IPC invoke reaches the handler
- `autoUpdater.downloadUpdate()` is called
- Check for any error in autoUpdater setup

### Step 5: Search for Mock/Test Data
**Scope:** Entire codebase

Search patterns:
- Hardcoded notification data with 'version_update' type
- Mock notification creation for testing
- Stubbed/overridden action handlers
- Test fixtures with update notifications
- Any code creating notifications outside of `updater.js`

---

## Proposed Fixes

### Fix 1: Process Markdown in Notification Content
**File:** `covenantrix-desktop/src/features/notifications/NotificationCard.tsx`

**Options:**

**Option A: Simple String Replacement (Minimal Change)**
```typescript
// Helper function to render basic markdown
function renderSimpleMarkdown(text: string): string {
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/\n/g, '<br />');
}

// Update content display (line 79-82)
<div className="mt-3 mb-3 max-h-[200px] overflow-y-auto rounded border border-gray-200 dark:border-gray-700 p-3 bg-gray-50 dark:bg-gray-800/50">
  <div 
    className="text-sm text-gray-700 dark:text-gray-300"
    dangerouslySetInnerHTML={{ __html: renderSimpleMarkdown(notification.content) }}
  />
</div>
```

**Pros:** 
- Minimal dependencies
- Simple implementation
- Only handles needed markdown (bold, italic, newlines)

**Cons:**
- Uses `dangerouslySetInnerHTML` (requires sanitization)
- Limited markdown support

**Option B: Remove Markdown Formatting from Source**
```javascript
// Update formatReleaseNotes in updater.js (line 145)
const formatted = `Current Version: ${app.getVersion()}\nNew Version: ${info.version}\n\nRelease Notes:\n${notes}\n\nDownload Size: ${downloadSize}`;
```

**Pros:**
- No frontend changes needed
- No security concerns
- Simplest solution

**Cons:**
- Less visually distinct without bold headings
- Already formatted with markdown in existing implementation

**Recommendation:** Option B (remove markdown from source) for minimal changes and no security concerns.

### Fix 2: Ensure Download Button Functionality

**File:** `covenantrix-desktop/src/contexts/NotificationContext.tsx` (lines 86-109)

**Changes:**

1. Add defensive logging:
```typescript
case 'download_update':
  console.log('[NotificationContext] Download update triggered', { notificationId });
  
  try {
    // Trigger update download via IPC
    const result = await window.electronAPI.update.download();
    console.log('[NotificationContext] Download initiated', result);
    
    if (!result.success) {
      console.error('[NotificationContext] Download failed:', result.error);
      // TODO: Show error to user
      return;
    }
    
    // Keep notification open and mark as downloading
    // ... existing code
  } catch (error) {
    console.error('[NotificationContext] Download exception:', error);
    // TODO: Show error to user
  }
  break;
```

2. Add click handler debugging to NotificationCard:
```typescript
onClick={(e) => {
  e.stopPropagation();
  console.log('[NotificationCard] Action button clicked', { 
    notificationId: notification.id, 
    action: action.action,
    actionLabel: action.label 
  });
  onAction(notification.id, action.action);
}}
```

**File:** `covenantrix-desktop/electron/ipc-handlers.js` (lines 781-790)

**Changes:**

Add logging and error handling:
```javascript
ipcMain.handle('update:download', async () => {
  try {
    console.log('[IPC] Update download requested');
    
    if (downloadInProgress) {
      console.warn('[IPC] Download already in progress');
      return { success: false, error: 'Download already in progress' };
    }
    
    downloadInProgress = true;
    
    // Trigger download update
    await autoUpdater.downloadUpdate();
    
    console.log('[IPC] Download started successfully');
    return { success: true };
  } catch (error) {
    downloadInProgress = false;
    console.error('[IPC] Failed to download update:', error);
    return { success: false, error: error.message };
  }
});
```

**File:** `covenantrix-desktop/electron/main.js`

**Verify:** `registerUpdateHandlers()` is called during app initialization (should already be present based on implementation in 0018)

### Fix 3: Clean Up Any Test/Mock Data

**Search and Remove:**
- Any hardcoded notification creation for testing
- Mock IPC handlers that override real handlers
- Stubbed update functions
- Test fixtures in non-test directories

**Specific Checks:**
1. `covenantrix-desktop/src/contexts/NotificationContext.tsx` - No mock notifications in initial state
2. `covenantrix-desktop/electron/updater.js` - No test mode overrides
3. `covenantrix-desktop/electron/ipc-handlers.js` - No conditional mock handlers

---

## Testing Plan

### Manual Testing Steps

1. **Launch app in development mode**
   - Open DevTools console
   - Check for environment detection logs

2. **Trigger update notification**
   - Use updater test mechanism or manual notification creation
   - Verify notification appears in notification panel

3. **Inspect notification content**
   - Expand notification
   - Verify no `**` symbols visible
   - Check formatting is readable

4. **Test "Later" button**
   - Click "Later"
   - Verify notification collapses
   - Verify notification marked as read

5. **Test "Download Now" button**
   - Click "Download Now"
   - Watch console for logs
   - Verify download progress appears
   - Verify button is replaced with progress bar

6. **Monitor IPC communication**
   - Check main process logs for IPC handler execution
   - Verify autoUpdater methods are called
   - Check for any errors in electron logs

### Console Verification Points

Expected console output when clicking "Download Now":
```
[NotificationCard] Action button clicked { notificationId: "...", action: "download_update", actionLabel: "Download Now" }
[NotificationContext] Download update triggered { notificationId: "..." }
[IPC] Update download requested
[IPC] Download started successfully
[NotificationContext] Download initiated { success: true }
```

If button doesn't respond, check for:
- Missing logs = click handler not firing
- Error in NotificationContext = IPC call failed
- Error in IPC handler = autoUpdater issue

---

## Files to Modify

### Primary Changes
1. `covenantrix-desktop/electron/updater.js` - Remove markdown from formatReleaseNotes (line 145)
2. `covenantrix-desktop/src/contexts/NotificationContext.tsx` - Add logging and error handling (lines 86-109)
3. `covenantrix-desktop/electron/ipc-handlers.js` - Add logging and return value checking (lines 781-790)
4. `covenantrix-desktop/src/features/notifications/NotificationCard.tsx` - Add debug logging to button click (line 128-131)

### Verification Only (No Changes Expected)
1. `covenantrix-desktop/electron/main.js` - Verify registerUpdateHandlers() is called
2. `covenantrix-desktop/electron/preload.js` - Verify update API is exposed
3. `covenantrix-desktop/src/services/api/notificationService.ts` - Verify no mock data

---

## Success Criteria

1. **Formatting:** Notification content displays without visible markdown symbols (`**`)
2. **Later Button:** Continues to work as expected (collapses notification, marks as read)
3. **Download Button:** Clicking triggers download, shows progress bar, logs confirm execution
4. **No Mock Data:** All notifications come from real update checks
5. **Error Handling:** Any failures are logged and visible in console
6. **User Experience:** Clean, professional notification display with functional buttons

---

## Rollback Plan

If changes cause issues:
1. Git revert to current commit
2. All changes are logging/formatting only - no breaking changes to logic
3. Remove debug logging if too verbose
4. Restore markdown formatting if users prefer it

---

## Notes

- This is a refinement of existing functionality (0018)
- No new dependencies required
- Changes focus on observability and bug fixing
- Minimal code changes to reduce risk
- Investigation phase comes before implementation

