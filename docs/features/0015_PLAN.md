# Feature 0015: Profile & Google Drive Integration

## Overview

Implement user profile management and Google Drive OAuth integration for the desktop application. Extends existing `user_settings.json` with profile data and Google account credentials. Enables browsing and uploading documents directly from Google Drive through OAuth 2.0 authentication. Desktop-first approach with JSON storage (no database/Firebase until SaaS migration).

**Storage Location:** `~/.covenantrix/rag_storage/user_settings.json` (extends existing)

**Key Principle:** Device = user. No authentication layer. Profile is configuration hub, not auth gateway.

---

## Phase 1: Data Layer & OAuth Core

**Goal:** Establish storage schema, encryption infrastructure, and OAuth service implementation. Phase is testable via backend endpoints without frontend.

### 1.1 Update Storage Schema

**File: `backend/api/schemas/settings.py`**

Add two new sections to `UserSettings` model:

```python
class ProfileSettings(BaseModel):
    """User profile information"""
    first_name: Optional[str] = None
    last_name: Optional[str] = None
    email: Optional[str] = None

class GoogleAccountSettings(BaseModel):
    """Google OAuth account (stored format)"""
    account_id: str
    email: str
    display_name: Optional[str] = None
    provider: str = "google"
    status: str  # connected/expired/revoked
    connected_at: str  # ISO datetime
    last_used: str  # ISO datetime
    # Credentials stored encrypted
    access_token: str
    refresh_token: Optional[str]
    token_expiry: str  # ISO datetime
    scopes: List[str]

class UserSettings(BaseModel):
    # Existing fields...
    profile: ProfileSettings = Field(default_factory=ProfileSettings)
    google_accounts: List[GoogleAccountSettings] = Field(default_factory=list)
```

**Note:** This schema differs from `domain/integrations/models.py` `OAuthAccount` dataclass. The dataclass is for runtime domain logic; this schema is for storage/API serialization. Conversion between them happens in the OAuth service layer.

### 1.2 Extend Encryption Infrastructure

**File: `backend/core/security.py`**

Add methods to encrypt/decrypt full OAuth credential structures (not just API key strings):

```python
class APIKeyManager:
    # Existing methods...
    
    def encrypt_oauth_credentials(self, credentials: Dict[str, Any]) -> Dict[str, Any]:
        """Encrypt OAuth tokens in credential dictionary"""
        # Encrypt access_token, refresh_token fields
        # Return dict with encrypted values
    
    def decrypt_oauth_credentials(self, credentials: Dict[str, Any]) -> Dict[str, Any]:
        """Decrypt OAuth tokens in credential dictionary"""
        # Decrypt access_token, refresh_token fields
        # Return dict with plain values
```

### 1.3 Update User Settings Storage

**File: `backend/infrastructure/storage/user_settings_storage.py`**

**Lines 107-169 (`_migrate_settings`):** Add migration for new schema:

```python
# Add profile section if missing
if "profile" not in data:
    data["profile"] = {
        "first_name": None,
        "last_name": None,
        "email": None
    }

# Add google_accounts section if missing
if "google_accounts" not in data:
    data["google_accounts"] = []
```

**Lines 171-200 (`_encrypt_sensitive_data`):** Add OAuth credential encryption:

```python
# Encrypt Google account credentials
if "google_accounts" in settings_dict:
    for account in settings_dict["google_accounts"]:
        if "access_token" in account:
            account["access_token"] = self.api_key_manager.encrypt_key(account["access_token"])
        if "refresh_token" in account and account["refresh_token"]:
            account["refresh_token"] = self.api_key_manager.encrypt_key(account["refresh_token"])
```

**Lines 202-244 (`_decrypt_sensitive_data`):** Add OAuth credential decryption with same pattern.

### 1.4 Update OAuth Configuration

**File: `backend/core/config.py`**

**Line 107:** Fix redirect URI to match backend port:

```python
google_oauth_redirect_uri: str = Field("http://localhost:8000/oauth/callback", env="GOOGLE_REDIRECT_URI")
```

### 1.5 Complete OAuth Service Implementation

**File: `backend/domain/integrations/google_oauth.py`**

Replace placeholder implementations (lines 20-97) with full OAuth flow:

**Dependencies:**
- Use `httpx` for HTTP requests to Google OAuth endpoints
- Google token endpoint: `https://oauth2.googleapis.com/token`
- Google userinfo endpoint: `https://www.googleapis.com/oauth2/v2/userinfo`

**`__init__`:** Inject dependencies:
```python
def __init__(self, config: Settings, storage: UserSettingsStorage):
    self.config = config
    self.storage = storage
```

**`list_accounts()` (line 25-35):**
- Load `user_settings.json` via `storage.load_settings()`
- Extract `google_accounts` array
- Convert each stored account to `OAuthAccount` dataclass
- Return list

**`get_authorization_url()` (line 37-55):**
- Build OAuth URL with: `client_id`, `redirect_uri`, `scope`, `response_type=code`, `access_type=offline`
- Scope: `https://www.googleapis.com/auth/drive.readonly`
- Generate random `state` parameter (store in memory for callback validation)
- Return full authorization URL string

**`handle_callback(code, state)` (line 57-97):**
- Validate `state` parameter matches stored value
- Exchange authorization code for tokens via POST to `https://oauth2.googleapis.com/token`:
  - Body: `code`, `client_id`, `client_secret`, `redirect_uri`, `grant_type=authorization_code`
- Parse response: `access_token`, `refresh_token`, `expires_in`
- Call userinfo endpoint to get email/name using access token
- Create `OAuthAccount` with:
  - `id`: uuid.uuid4()
  - `provider`: OAuthProvider.GOOGLE
  - `email`: from userinfo
  - `name`: from userinfo
  - `status`: OAuthStatus.CONNECTED
  - `connected_at`: datetime.utcnow()
  - `last_used`: datetime.utcnow()
  - `credentials`: OAuthCredentials with tokens
- Convert to storage format (`GoogleAccountSettings`)
- Load current settings, append to `google_accounts` array
- Save via `storage.save_settings()`
- Return `OAuthAccount`

**Add new method `refresh_access_token(account_id: str)`:**
- Load account from storage by `account_id`
- POST to token endpoint with `refresh_token`, `grant_type=refresh_token`
- Update `access_token` and `expires_at` in storage
- Return new access token

**Add new method `revoke_account(account_id: str)`:**
- Load account from storage
- POST to `https://oauth2.googleapis.com/revoke` with token
- Remove account from `google_accounts` array in storage
- Save settings

### 1.6 Extend Google API Service

**File: `backend/infrastructure/external/google_api.py`**

**Action:** Rename class and complete implementations. This file already exists; extend it rather than creating new `google_api_client.py`.

**Line 14:** Keep class name as `GoogleAPIService` (used by `google_drive.py`)

**`__init__` (line 19-28):** Add OAuth service dependency:
```python
def __init__(self, credentials: Optional[Dict] = None, oauth_service: Optional[GoogleOAuthService] = None):
    self.credentials = credentials
    self.oauth_service = oauth_service
```

**`list_files` (line 30-55):** Implement Drive API v3 call:
- Endpoint: `GET https://www.googleapis.com/drive/v3/files`
- Headers: `Authorization: Bearer {access_token}`
- Query params: `q` (folder filter), `pageSize`, `fields`
- Handle token expiration (401) → call `oauth_service.refresh_access_token()` → retry
- Parse response, return list of file metadata dicts

**`download_file` (line 57-74):** Implement Drive API v3 download:
- Endpoint: `GET https://www.googleapis.com/drive/v3/files/{file_id}?alt=media`
- Headers: `Authorization: Bearer {access_token}`
- Handle token expiration with refresh/retry
- Return bytes

### 1.7 Update Google Drive Service

**File: `backend/domain/integrations/google_drive.py`**

**Lines 263-280, 319-334 (`download_file`, `list_files`):** Update OAuth integration:
- Remove hardcoded "first account" selection
- Accept `account_id` parameter
- Load specific account from OAuth service
- Pass account's credentials to `GoogleAPIService`

**Method signatures:**
```python
async def download_file(self, account_id: str, file_id: str) -> tuple[bytes, str]
async def list_files(self, account_id: str, folder_id: Optional[str] = None, ...) -> ...
```

### 1.8 Create API Schemas for Google Endpoints

**New File: `backend/api/schemas/google.py`**

Define request/response models:

```python
class GoogleAccountResponse(BaseModel):
    account_id: str
    email: str
    display_name: Optional[str]
    status: str
    connected_at: str
    last_used: str

class GoogleAccountsListResponse(BaseModel):
    success: bool
    accounts: List[GoogleAccountResponse]

class DriveFileResponse(BaseModel):
    id: str
    name: str
    mime_type: str
    size: int
    modified_time: str
    web_view_link: Optional[str]

class DriveFilesListResponse(BaseModel):
    success: bool
    files: List[DriveFileResponse]
    account_id: str

class DriveDownloadRequest(BaseModel):
    account_id: str
    file_ids: List[str]
```

### 1.9 Create Google API Routes

**New File: `backend/api/routes/google.py`**

Consolidate Google-related routes (replaces scattered routes in `auth.py` and `integrations.py`):

```python
router = APIRouter(prefix="/api/google", tags=["google"])

@router.get("/accounts")
async def list_google_accounts() -> GoogleAccountsListResponse

@router.post("/accounts/connect")
async def initiate_oauth() -> AuthUrlResponse

@router.post("/accounts/callback")
async def handle_oauth_callback(code: str, state: Optional[str]) -> GoogleAccountResponse

@router.delete("/accounts/{account_id}")
async def remove_google_account(account_id: str)

@router.get("/drive/files")
async def list_drive_files(account_id: str, folder_id: Optional[str] = None) -> DriveFilesListResponse

@router.post("/drive/download")
async def download_drive_files(request: DriveDownloadRequest)
```

**Note:** Existing routes in `auth.py` (`/auth/google/*`) will be deprecated in favor of `/api/google/*` for consistency.

### 1.10 Register Google Router

**File: `backend/main.py`**

Add import and registration:
```python
from api.routes import google
app.include_router(google.router)
```

**Phase 1 Testing:**
- Start backend: `python backend/main.py`
- Test OAuth flow via curl/Postman:
  - GET `/api/google/accounts` → empty list
  - POST `/api/google/accounts/connect` → get auth URL
  - Visit URL in browser, authorize, copy callback code
  - POST `/api/google/accounts/callback?code=<code>` → account created
  - GET `/api/google/accounts` → see account
  - GET `/api/google/drive/files?account_id=<id>` → list Drive files
  - DELETE `/api/google/accounts/<id>` → account removed
- Verify `user_settings.json` contains encrypted credentials

---

## Phase 2: Profile UI & Onboarding

**Goal:** Add profile management UI, update onboarding to include profile step, implement frontend OAuth flow via Electron.

### 2.1 Add Profile Step to Onboarding

**New File: `covenantrix-desktop/src/features/onboarding/ProfileSetupStep.tsx`**

Create step component with:
- Three optional text inputs: First Name, Last Name, Email
- Info message: "Connect your Google Drive later from Profile settings to upload documents directly"
- Skip button and "Save & Continue" button
- No validation (all optional)
- On save: store in settings context under `profile` section

**File: `covenantrix-desktop/src/features/onboarding/OnboardingWizard.tsx`**

Update step sequence:
- Step 1: Welcome (existing)
- Step 2: Profile Setup (NEW)
- Step 3: API Keys (existing)
- Step 4: Complete (existing)

Update step counter logic to reflect 4 steps.

### 2.2 Update Settings Schema (Frontend)

**File: `covenantrix-desktop/src/types/settings.ts`**

Add to `UserSettings` interface (line 48-56):

```typescript
export interface ProfileSettings {
  first_name?: string;
  last_name?: string;
  email?: string;
}

export interface GoogleAccountSettings {
  account_id: string;
  email: string;
  display_name?: string;
  status: string;
  connected_at: string;
  last_used: string;
  scopes: string[];
}

export interface UserSettings {
  // Existing fields...
  profile?: ProfileSettings;
  google_accounts?: GoogleAccountSettings[];
}
```

**File: `covenantrix-desktop/src/utils/settings.ts`**

Update `getDefaultSettings` (line 11) to include:
```typescript
profile: {
  first_name: undefined,
  last_name: undefined,
  email: undefined
},
google_accounts: []
```

Update `validateAndNormalizeSettings` (line 46) to handle new sections.

### 2.3 Create Profile Screen Components

**New Directory: `covenantrix-desktop/src/features/profile/`**

**New File: `ProfileModal.tsx`**
- Main modal/dialog component
- Three tabs: User Info, Connected Accounts, API Keys
- Tab navigation state
- Close button

**New File: `tabs/UserInfoTab.tsx`**
- Form with First Name, Last Name, Email inputs
- Loads from `settings.profile`
- Save button calls `updateSettings({ profile: {...} })`

**New File: `tabs/ConnectedAccountsTab.tsx`**
- Lists Google accounts from `settings.google_accounts`
- Each account shows: email, connected date, last used date, status indicator
- "Connect Another Google Account" button → triggers OAuth
- "Remove Account" button per account → confirmation dialog → DELETE request

**New File: `tabs/ApiKeysTab.tsx`**
- Import and render existing ApiKeysTab from settings
- No changes needed; reuse existing component

**New File: `components/GoogleAccountCard.tsx`**
- Display single account with:
  - Email (primary text)
  - Connected date (formatted)
  - Last used (relative time, e.g., "2 hours ago")
  - Status badge (green=active, yellow=expiring, red=expired)
  - Remove button

**New File: `hooks/useGoogleAccounts.ts`**
- Custom hook for account management
- Methods: `listAccounts()`, `connectAccount()`, `removeAccount(id)`
- Wraps API calls to `/api/google/accounts`

### 2.4 Implement Electron OAuth Handler

**New File: `covenantrix-desktop/electron/oauth-handler.js`**

Implement OAuth window management:

```javascript
const { BrowserWindow } = require('electron');

function openOAuthWindow(authUrl, mainWindow) {
  const authWindow = new BrowserWindow({
    width: 500,
    height: 600,
    show: false,
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true
    }
  });

  authWindow.loadURL(authUrl);
  authWindow.show();

  // Intercept callback redirect
  authWindow.webContents.on('will-redirect', (event, url) => {
    if (url.startsWith('http://localhost:8000/oauth/callback')) {
      const urlObj = new URL(url);
      const code = urlObj.searchParams.get('code');
      const state = urlObj.searchParams.get('state');
      
      // Send to renderer
      mainWindow.webContents.send('oauth-callback', { code, state });
      
      authWindow.close();
    }
  });

  authWindow.on('closed', () => {
    // Cleanup
  });
}

module.exports = { openOAuthWindow };
```

**File: `covenantrix-desktop/electron/ipc-handlers.js`**

Add IPC handlers:

```javascript
const { openOAuthWindow } = require('./oauth-handler');

ipcMain.handle('google-oauth-start', async (event) => {
  // Call backend to get OAuth URL
  const response = await fetch('http://localhost:8000/api/google/accounts/connect', {
    method: 'POST'
  });
  const { auth_url } = await response.json();
  
  // Open OAuth window
  openOAuthWindow(auth_url, mainWindow);
  
  return { success: true };
});

// Renderer will send oauth-callback event with code via IPC
```

### 2.5 Create Profile Entry Point

**File: `covenantrix-desktop/src/components/layout/StatusBar.tsx`**

Add profile icon button:
- Icon: User circle
- On click: open ProfileModal
- Position: top-right corner of app

**File: `covenantrix-desktop/src/App.tsx`**

Add ProfileModal component (rendered conditionally based on state).

### 2.6 Update Frontend API Service

**New File: `covenantrix-desktop/src/services/googleService.ts`**

Create service for Google API calls:

```typescript
export const googleService = {
  async listAccounts(): Promise<GoogleAccountsListResponse> {
    const response = await fetch('http://localhost:8000/api/google/accounts');
    return response.json();
  },

  async connectAccount(): Promise<void> {
    // Trigger IPC to Electron
    await window.electronAPI.startGoogleOAuth();
  },

  async handleOAuthCallback(code: string, state: string): Promise<GoogleAccountResponse> {
    const response = await fetch(
      `http://localhost:8000/api/google/accounts/callback?code=${code}&state=${state}`,
      { method: 'POST' }
    );
    return response.json();
  },

  async removeAccount(accountId: string): Promise<void> {
    await fetch(`http://localhost:8000/api/google/accounts/${accountId}`, {
      method: 'DELETE'
    });
  },

  async listDriveFiles(accountId: string, folderId?: string): Promise<DriveFilesListResponse> {
    const params = new URLSearchParams({ account_id: accountId });
    if (folderId) params.append('folder_id', folderId);
    const response = await fetch(`http://localhost:8000/api/google/drive/files?${params}`);
    return response.json();
  }
};
```

### 2.7 Update Electron Preload API

**File: `covenantrix-desktop/electron/preload.js`**

Add Google OAuth methods to exposed API:

```javascript
contextBridge.exposeInMainWorld('electronAPI', {
  // Existing methods...
  
  startGoogleOAuth: () => ipcRenderer.invoke('google-oauth-start'),
  onOAuthCallback: (callback) => ipcRenderer.on('oauth-callback', (event, data) => callback(data))
});
```

### 2.8 Wire OAuth Callback in Frontend

**File: `covenantrix-desktop/src/features/profile/tabs/ConnectedAccountsTab.tsx`**

In component mount:
```typescript
useEffect(() => {
  window.electronAPI.onOAuthCallback(async ({ code, state }) => {
    try {
      const account = await googleService.handleOAuthCallback(code, state);
      // Reload settings to get updated google_accounts
      await settingsContext.loadSettings();
      showToast('Google account connected successfully', 'success');
    } catch (error) {
      showToast('Failed to connect Google account', 'error');
    }
  });
}, []);
```

**Phase 2 Testing:**
- Start app, complete onboarding → profile step appears
- Open profile from status bar icon
- Navigate to "Connected Accounts" tab
- Click "Connect Google Account"
  - Electron OAuth window opens with Google login
  - Authorize app
  - Window closes, account appears in list
- Remove account → confirmation → account removed
- Verify `user_settings.json` updates

---

## Phase 3: Google Drive File Selector & Upload

**Goal:** Enable browsing Google Drive and uploading files through existing upload pipeline.

### 3.1 Update Google Drive Selector Component

**File: `covenantrix-desktop/src/features/upload/components/GoogleDriveSelector.tsx`**

**Complete rewrite to align with new architecture:**

**State management:**
```typescript
const [selectedAccount, setSelectedAccount] = useState<string | null>(null);
const [currentFolder, setCurrentFolder] = useState<string | null>(null);
const [files, setFiles] = useState<DriveFileResponse[]>([]);
const [selectedFiles, setSelectedFiles] = useState<Set<string>>(new Set());
const [breadcrumbs, setBreadcrumbs] = useState<BreadcrumbItem[]>([]);
const [viewMode, setViewMode] = useState<'grid' | 'list'>('list');
const [isLoading, setIsLoading] = useState(false);
```

**Account selection:**
- Load accounts via `googleService.listAccounts()` on mount
- If no accounts: show empty state with "Connect Google Drive" button → opens ProfileModal to Connected Accounts tab
- If accounts exist: show dropdown selector
- On account change: reset folder, load root files

**File loading:**
- Call `googleService.listDriveFiles(selectedAccount, currentFolder)`
- Display in grid or list view based on `viewMode`
- Show file icons based on MIME type
- Checkbox selection

**Folder navigation:**
- Breadcrumbs show current path
- Click breadcrumb → navigate to that folder
- Click folder in list → navigate into it
- "Back" button → navigate to parent

**Search:**
- Debounced input
- Calls Drive API with search query
- Filters results by supported MIME types

**Selection actions:**
- "Select All" / "Clear Selection"
- Count and total size display
- "Upload Selected" button

**Lines to modify:**
- Line 36: Remove `/auth/google/status` check (use settings context accounts)
- Line 49: Update to `/api/google/drive/files?account_id=<id>`
- Line 67: Remove old auth flow (use Profile modal instead)
- Lines 136-156: Update empty state to link to Profile

### 3.2 Add Account Selector Component

**New File: `covenantrix-desktop/src/features/upload/components/DriveAccountSelector.tsx`**

Dropdown component:
- Lists available Google accounts from settings
- Current selection indicator
- "Add Another Account" option → opens ProfileModal
- "Manage Accounts" option → opens ProfileModal to Connected Accounts tab

### 3.3 Add File Explorer Components

**New File: `covenantrix-desktop/src/features/upload/components/DriveBreadcrumbs.tsx`**
- Displays folder navigation path
- Clickable breadcrumb items
- Handles navigation to parent folders

**New File: `covenantrix-desktop/src/features/upload/components/DriveFileList.tsx`**
- Container for file display
- Switches between grid/list view
- Handles selection state
- Props: files, viewMode, selectedFiles, onToggleSelect

**New File: `covenantrix-desktop/src/features/upload/components/DriveFileItem.tsx`**
- Individual file/folder display
- Shows icon, name, size, modified date
- Checkbox for selection
- Double-click folder → navigate into
- Props: file, isSelected, onToggle, onNavigate

**New File: `covenantrix-desktop/src/features/upload/components/DriveSearchBar.tsx`**
- Search input with debounce
- File type filter dropdown
- View mode toggle (grid/list)
- Props: onSearch, onFilterChange, viewMode, onViewModeChange

### 3.4 Implement Drive File Upload Flow

**File: `backend/api/routes/google.py`**

Add download endpoint implementation:

```python
@router.post("/drive/download")
async def download_drive_files(
    request: DriveDownloadRequest,
    drive_service: GoogleDriveService = Depends(),
    document_service: DocumentService = Depends()
):
    """
    Download files from Google Drive and process through upload pipeline
    
    Flow:
    1. Validate account exists and is active
    2. Download each file_id via drive_service.download_file()
    3. Convert bytes to UploadFile objects
    4. Pass to document_service.upload_document()
    5. Stream progress back to client
    """
    
    results = []
    for file_id in request.file_ids:
        try:
            # Download from Drive
            file_content, filename = await drive_service.download_file(
                account_id=request.account_id,
                file_id=file_id
            )
            
            # Create UploadFile
            upload_file = UploadFile(
                filename=filename,
                file=io.BytesIO(file_content)
            )
            
            # Process through existing pipeline
            result = await document_service.upload_document(upload_file)
            results.append(result)
            
        except Exception as e:
            results.append({"file_id": file_id, "error": str(e)})
    
    return {"success": True, "results": results}
```

**Key points:**
- Reuses existing `DocumentService.upload_document()` (no pipeline changes)
- Same OCR, text extraction, RAG insertion as local files
- Same error handling and progress tracking
- Drive files treated identically to local uploads after download

### 3.5 Update Upload Screen

**File: `covenantrix-desktop/src/features/upload/UploadScreen.tsx`**

Update tab structure:
- Tab 1: "Local Files" (existing FileUploadArea)
- Tab 2: "Google Drive" (GoogleDriveSelector)

Pass upload handler to GoogleDriveSelector:
```typescript
const handleGoogleDriveUpload = async (fileIds: string[], accountId: string) => {
  try {
    const response = await fetch('http://localhost:8000/api/google/drive/download', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ account_id: accountId, file_ids: fileIds })
    });
    
    const result = await response.json();
    // Show progress/results
    // Refresh document list
  } catch (error) {
    showToast('Upload failed', 'error');
  }
};
```

### 3.6 Add Error Handling & Edge Cases

**File: `backend/domain/integrations/google_oauth.py`**

Add token expiration handling:
```python
async def ensure_valid_token(self, account_id: str) -> str:
    """
    Ensure account has valid access token
    Refreshes if expired
    Returns valid access token
    """
    account = await self.get_account(account_id)
    
    if account.credentials.is_expired():
        new_token = await self.refresh_access_token(account_id)
        return new_token
    
    return account.credentials.access_token
```

**File: `backend/infrastructure/external/google_api.py`**

Add retry logic with exponential backoff:
```python
async def _request_with_retry(self, method: str, url: str, **kwargs) -> Any:
    """
    Make HTTP request with retry logic
    Handles 401 (token refresh), 429 (rate limit), 500 (server error)
    """
    max_retries = 3
    backoff = 1  # seconds
    
    for attempt in range(max_retries):
        try:
            response = await httpx.request(method, url, **kwargs)
            
            if response.status_code == 401:
                # Token expired - trigger refresh via oauth_service
                # Retry with new token
                pass
            elif response.status_code == 429:
                # Rate limited - wait and retry
                await asyncio.sleep(backoff * (2 ** attempt))
                continue
            elif response.status_code >= 500:
                # Server error - retry
                await asyncio.sleep(backoff * (2 ** attempt))
                continue
            
            response.raise_for_status()
            return response.json()
            
        except Exception as e:
            if attempt == max_retries - 1:
                raise
```

**Frontend error states:**
- Token expiration → prompt to reconnect account
- Network failures → show retry button
- Quota limits → user-friendly message with suggestion
- Large files (>50MB) → warning before upload
- Unsupported file types → filtered from list

### 3.7 Add Loading & Empty States

**File: `covenantrix-desktop/src/features/upload/components/GoogleDriveSelector.tsx`**

**Loading state:**
- Skeleton screens while fetching files
- Shimmer effect on file cards
- Progress spinner on upload button

**Empty state (no accounts):**
```tsx
<EmptyState
  icon={<Cloud />}
  title="Connect Google Drive"
  description="Authenticate with Google to access your Drive files"
  action={<Button onClick={openProfileModal}>Connect Google Drive</Button>}
/>
```

**Empty state (no files in folder):**
```tsx
<EmptyState
  icon={<FolderOpen />}
  title="No files in this folder"
  description="Upload files to your Google Drive to see them here"
/>
```

**Error state:**
```tsx
<ErrorState
  icon={<AlertCircle />}
  title="Failed to load Drive files"
  description={error.message}
  actions={[
    <Button onClick={retryLoad}>Try Again</Button>,
    <Button onClick={reconnectAccount}>Reconnect Account</Button>
  ]}
/>
```

### 3.8 Add Progress Tracking

**File: `backend/api/routes/google.py`**

Add Server-Sent Events (SSE) or WebSocket support for upload progress:
```python
@router.post("/drive/download/stream")
async def download_drive_files_stream(request: DriveDownloadRequest):
    """
    Stream download progress to client
    
    Yields:
    - {"type": "progress", "file_id": "...", "status": "downloading"}
    - {"type": "progress", "file_id": "...", "status": "processing"}
    - {"type": "complete", "file_id": "...", "document_id": "..."}
    - {"type": "error", "file_id": "...", "error": "..."}
    """
    async def generate():
        for file_id in request.file_ids:
            yield json.dumps({"type": "progress", "file_id": file_id, "status": "downloading"})
            # Download and process...
            yield json.dumps({"type": "complete", "file_id": file_id})
    
    return StreamingResponse(generate(), media_type="text/event-stream")
```

**Frontend integration:**
- Show per-file progress bars
- Display status (downloading, processing, complete)
- Allow cancellation
- Show errors inline

**Phase 3 Testing:**
- Open Upload screen → Google Drive tab
- Select account from dropdown
- Browse folders via breadcrumbs
- Search for files
- Toggle between grid/list view
- Select multiple files
- Click "Upload Selected"
  - Progress bars show for each file
  - Files processed through RAG pipeline
  - Success/error messages per file
- Navigate to Documents screen → verify files appear
- Test error cases:
  - Disconnect internet → error state + retry
  - Revoke OAuth permission in Google → token refresh failure → reconnect prompt
  - Select 50+ files → quota warning
  - Upload 100MB file → size warning

---

## Files Modified/Created Summary

**Backend (Modified):**
- `backend/core/config.py` - Fix redirect URI
- `backend/core/security.py` - Add OAuth credential encryption
- `backend/api/schemas/settings.py` - Add profile & google_accounts schemas
- `backend/infrastructure/storage/user_settings_storage.py` - Migration + encryption
- `backend/domain/integrations/google_oauth.py` - Complete OAuth implementation
- `backend/infrastructure/external/google_api.py` - Complete Drive API calls
- `backend/domain/integrations/google_drive.py` - Update method signatures
- `backend/main.py` - Register google router

**Backend (Created):**
- `backend/api/schemas/google.py` - Google API request/response schemas
- `backend/api/routes/google.py` - Google OAuth & Drive endpoints

**Frontend (Modified):**
- `covenantrix-desktop/src/types/settings.ts` - Add profile & google_accounts types
- `covenantrix-desktop/src/utils/settings.ts` - Add default values
- `covenantrix-desktop/src/features/onboarding/OnboardingWizard.tsx` - Add profile step
- `covenantrix-desktop/src/features/upload/components/GoogleDriveSelector.tsx` - Complete rewrite
- `covenantrix-desktop/src/features/upload/UploadScreen.tsx` - Wire upload handler
- `covenantrix-desktop/src/components/layout/StatusBar.tsx` - Add profile button
- `covenantrix-desktop/src/App.tsx` - Add ProfileModal

**Frontend (Created):**
- `covenantrix-desktop/src/features/onboarding/ProfileSetupStep.tsx`
- `covenantrix-desktop/src/features/profile/ProfileModal.tsx`
- `covenantrix-desktop/src/features/profile/tabs/UserInfoTab.tsx`
- `covenantrix-desktop/src/features/profile/tabs/ConnectedAccountsTab.tsx`
- `covenantrix-desktop/src/features/profile/tabs/ApiKeysTab.tsx`
- `covenantrix-desktop/src/features/profile/components/GoogleAccountCard.tsx`
- `covenantrix-desktop/src/features/profile/hooks/useGoogleAccounts.ts`
- `covenantrix-desktop/src/features/upload/components/DriveAccountSelector.tsx`
- `covenantrix-desktop/src/features/upload/components/DriveBreadcrumbs.tsx`
- `covenantrix-desktop/src/features/upload/components/DriveFileList.tsx`
- `covenantrix-desktop/src/features/upload/components/DriveFileItem.tsx`
- `covenantrix-desktop/src/features/upload/components/DriveSearchBar.tsx`
- `covenantrix-desktop/src/services/googleService.ts`

**Electron (Modified):**
- `covenantrix-desktop/electron/ipc-handlers.js` - Add OAuth IPC handlers
- `covenantrix-desktop/electron/preload.js` - Expose OAuth API

**Electron (Created):**
- `covenantrix-desktop/electron/oauth-handler.js` - OAuth window management

---

## Configuration Requirements

**Environment Variables (`.env`):**
```
GOOGLE_CLIENT_ID=<from GCP Console>
GOOGLE_CLIENT_SECRET=<from GCP Console>
GOOGLE_REDIRECT_URI=http://localhost:8000/oauth/callback
```

**Google Cloud Console Setup:**
1. Create/use existing "Covenantrix" GCP project
2. Enable Drive API
3. Create OAuth 2.0 Client ID (Desktop app type)
4. Add authorized redirect URI: `http://localhost:8000/oauth/callback`
5. Set OAuth consent screen (app name, scopes, test users for development)
6. Download credentials or copy Client ID/Secret to `.env`

**OAuth Scopes:**
- `https://www.googleapis.com/auth/drive.readonly` (read-only Drive access)
- `https://www.googleapis.com/auth/userinfo.email` (get user email)
- `https://www.googleapis.com/auth/userinfo.profile` (get user name)

---

## Security Considerations

1. **Token Storage:** All OAuth tokens encrypted at rest using existing `APIKeyManager`
2. **Client Secret:** Never exposed to frontend; backend-only via environment variables
3. **Scope Minimization:** Request only `drive.readonly`, no write permissions
4. **Token Refresh:** Automatic and transparent via backend service
5. **Revocation:** Proper cleanup via Google API on account removal
6. **HTTPS:** All Google API calls over HTTPS (localhost exception for OAuth callback)
7. **State Parameter:** Random state generation and validation to prevent CSRF

---

## Migration Notes

**Future SaaS Migration Path:**

When migrating to multi-user SaaS (Firebase/database):
1. Extract `profile` and `google_accounts` from `user_settings.json`
2. Create separate `users` and `oauth_accounts` tables/collections
3. Add user authentication layer
4. Associate settings/documents with user IDs
5. Update storage layer to use database instead of JSON files

**Current desktop approach intentionally keeps single-user simplicity while maintaining clean separation for future extraction.**

