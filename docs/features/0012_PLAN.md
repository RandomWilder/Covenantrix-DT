# Feature 0012: GitHub Actions Build Workflow Fixes

## Overview
Fix critical issues in the GitHub Actions build workflow that prevent successful creation of distributable artifacts for Windows and macOS. The current build.yml has configuration conflicts, path mismatches, and platform-specific issues that cause build failures or non-functional installers.

## Files to Modify

### 1. `.github/workflows/build.yml`
Complete workflow file requiring extensive modifications across multiple steps.

### 2. `covenantrix-desktop/package.json`
Remove duplicate electron-builder configuration from lines 81-124 (build section).

### 3. `covenantrix-desktop/electron-builder.yml`
Update output directory path and ensure it's the single source of truth for build configuration.

### 4. `covenantrix-desktop/build/entitlements.mac.plist` (CREATE)
Create macOS entitlements file referenced by electron-builder.yml line 66-67.

## Critical Issues to Fix

### Issue #1: Build Configuration Conflict
**Files**: `covenantrix-desktop/package.json`, `covenantrix-desktop/electron-builder.yml`

**Problem**: Two electron-builder configurations exist - one in package.json (lines 81-124) and one in electron-builder.yml. Electron Builder uses the YAML file, making package.json config redundant.

**Changes**:
- Remove entire `build` section from package.json (lines 81-124)
- Keep only electron-builder.yml as single source of configuration
- Ensure publish configuration remains in electron-builder.yml only

### Issue #2: Build Output Path Mismatch
**Files**: `covenantrix-desktop/electron-builder.yml`, `.github/workflows/build.yml`

**Problem**: electron-builder.yml specifies `output: dist` but GitHub Actions expects artifacts in `covenantrix-desktop/dist/release/`. Electron Builder outputs to dist/ directly (no release subfolder by default).

**Changes**:
- In electron-builder.yml, change:
  ```yaml
  directories:
    buildResources: build
    output: dist/release
  ```
- This makes actual output path match what GitHub Actions expects at line 284, 295-298

### Issue #3: Windows Installer Filename Pattern
**Files**: `.github/workflows/build.yml`

**Problem**: Line 336 searches for `*Setup*.exe` which is fragile and may miss installers if naming changes.

**Changes**:
- Replace line 336:
  ```bash
  find artifacts/ -name "*Setup*.exe" -exec cp {} release-files/ \;
  ```
  With:
  ```bash
  find artifacts/ -name "*.exe" -type f -exec cp {} release-files/ \;
  ```

### Issue #4: macOS Python Distribution Approach
**Files**: `.github/workflows/build.yml`

**Problem**: Lines 107-123 create a venv for macOS which includes hardcoded absolute paths, is not truly portable, has larger size, and the sed command (line 121) attempting path fixes is fragile.

**Changes**:
- Replace macOS Python distribution step (lines 107-123) with standalone Python approach similar to Windows
- Use python.org embeddable builds for macOS or python-build-standalone from PyOxidizer
- OR use Framework build approach with proper relocation:
  1. Download Python macOS installer (.pkg)
  2. Extract framework bundle
  3. Create minimal distribution with site-packages
  4. Install dependencies using pip with --target flag
  5. Make paths relative using install_name_tool for dylibs
- Ensure no hardcoded paths in any Python configuration files

**Algorithm**:
```
1. Download Python 3.11 macOS framework build
2. Extract to dist/python-dist/
3. Set up minimal Python.framework structure
4. Install pip using get-pip.py with --target to framework site-packages
5. Install requirements.txt packages with --target to framework site-packages
6. Run install_name_tool to fix any absolute paths in dylibs
7. Create python launcher script that sets PYTHONHOME correctly
8. Verify imports work with relative paths
```

### Issue #5: Backend Test Step Alignment
**Files**: `.github/workflows/build.yml`

**Problem**: Lines 202-265 test backend startup but don't replicate production environment correctly. Sets PYTHONPATH, changes to backend/ directory, but embedded Python might not respect this. Imports might fail.

**Changes**:
- Remove PYTHONPATH manipulation from line 210
- Rely on sys.path setup in backend/main.py (lines 9-13)
- Test should run backend exactly as backend-manager.js does:
  ```bash
  cd backend
  ../dist/python-dist/python.exe main.py  # Windows
  ../dist/python-dist/bin/python main.py  # macOS
  ```
- This matches backend-manager.js lines 56-60 production structure

### Issue #6: Build Structure Verification
**Files**: `.github/workflows/build.yml`

**Problem**: No verification that Python distribution and backend source are correctly packaged inside the built Electron app after electron-builder runs.

**Changes**:
- Add new step after "Build Electron App" (after line 275):
  ```yaml
  - name: Verify Packaged App Structure
    shell: bash
    run: |
      # Platform-specific verification
      if [ "${{ matrix.os }}" == "windows-latest" ]; then
        # Extract NSIS installer temporarily and check resources
        # Or check unpacked directory if --dir used
        echo "Verifying Windows app structure..."
        ls -la covenantrix-desktop/dist/release/win-unpacked/resources/
        test -d covenantrix-desktop/dist/release/win-unpacked/resources/backend
        test -d covenantrix-desktop/dist/release/win-unpacked/resources/python-dist
      else
        # macOS - mount DMG and verify
        echo "Verifying macOS app structure..."
        # Implementation for DMG verification
      fi
  ```

### Issue #7: Artifact Upload Path Patterns
**Files**: `.github/workflows/build.yml`

**Problem**: Lines 295-298 artifact upload paths won't find files if dist/release/ doesn't exist (related to Issue #2).

**Changes**:
- After fixing Issue #2, ensure paths are correct
- Add verification before upload:
  ```yaml
  - name: Verify Artifacts Before Upload
    shell: bash
    run: |
      echo "Checking for build artifacts..."
      ls -la covenantrix-desktop/dist/release/
      if [ "${{ matrix.os }}" == "windows-latest" ]; then
        test -f covenantrix-desktop/dist/release/*.exe
      elif [ "${{ matrix.os }}" == "macos-latest" ]; then
        test -f covenantrix-desktop/dist/release/*.dmg
      fi
  ```

### Issue #8: Linux Build Support
**Files**: `.github/workflows/build.yml`, `covenantrix-desktop/electron-builder.yml`

**Problem**: electron-builder.yml has Linux (AppImage) configuration (lines 82-88) but GitHub Actions matrix only includes Windows and macOS.

**Changes**:
- If Linux support is desired, add to matrix at line 26:
  ```yaml
  - os: ubuntu-latest
    platform: linux
    arch: x64
    python_url: https://www.python.org/ftp/python/3.11.6/Python-3.11.6.tgz
    python_exe: bin/python3
    artifact_pattern: "*.AppImage"
  ```
- Add Linux Python distribution step similar to Windows/macOS
- Update all platform conditionals to include Linux

**Note**: Decision needed - include Linux or remove from electron-builder.yml

### Issue #9: Python Package Installation Robustness
**Files**: `.github/workflows/build.yml`

**Problem**: Windows sitecustomize.py (line 86) uses `__file__` which might not always point to correct location. The python311._pth file should explicitly include paths.

**Changes**:
- After line 88, modify python311._pth more comprehensively:
  ```bash
  cat > dist/python-dist/python311._pth << EOF
  python311.zip
  .
  ./Lib
  ./Lib/site-packages
  import site
  EOF
  ```
- This ensures all necessary paths are in Python's search path without relying on sitecustomize.py

### Issue #10: Backend Working Directory Handling
**Files**: `backend/main.py`, `covenantrix-desktop/electron/backend-manager.js`

**Problem**: Backend-manager.js sets cwd to resources/backend/ (line 59) but backend might expect to find config files there. Need to verify path handling is correct.

**Changes**:
- Verify backend/main.py (lines 9-13) correctly handles sys.path for embedded Python
- Ensure backend code uses Path(__file__).parent for code-relative paths
- Verify UserSettingsStorage uses app data directory (already handled by main.js initializeUserDataDirectory)
- No changes needed if verification passes, otherwise document issue

### Issue #11: Release Metadata Files
**Files**: `.github/workflows/build.yml`

**Problem**: Lines 338-339 copy latest*.yml files which are platform-specific (latest.yml for Windows, latest-mac.yml for macOS, latest-linux.yml for Linux) and crucial for electron-updater auto-update feature.

**Changes**:
- Ensure latest*.yml files are properly included in artifact upload (lines 298)
- Verify they're copied to release-files in release job (line 339)
- Add explicit verification:
  ```bash
  echo "Verifying update metadata files..."
  ls -la release-files/latest*.yml || echo "WARNING: No update metadata files found"
  ```

### Issue #12: macOS Entitlements Files
**Files**: `covenantrix-desktop/build/entitlements.mac.plist` (CREATE)

**Problem**: electron-builder.yml lines 66-67 reference entitlements files that don't exist.

**Changes**:
- Create build/entitlements.mac.plist:
  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
  <plist version="1.0">
    <dict>
      <key>com.apple.security.cs.allow-jit</key>
      <true/>
      <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
      <true/>
      <key>com.apple.security.cs.disable-library-validation</key>
      <true/>
    </dict>
  </plist>
  ```

## Enhancement Opportunities (Not Blocking)

### Code Signing Configuration
**Files**: `.github/workflows/build.yml`, GitHub Secrets

**Changes**:
- Add secrets: CSC_LINK, CSC_KEY_PASSWORD, APPLE_ID, APPLE_APP_SPECIFIC_PASSWORD
- Add environment variables to Build Electron App step:
  ```yaml
  env:
    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    CSC_LINK: ${{ secrets.CSC_LINK }}
    CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
  ```

### macOS Notarization
**Files**: `.github/workflows/build.yml`

**Changes**:
- Add afterSign script configuration to electron-builder.yml
- Add notarization step after build for macOS
- Requires Apple Developer account and app-specific password

### Build Caching
**Files**: `.github/workflows/build.yml`

**Changes**:
- Cache Python distributions between builds:
  ```yaml
  - name: Cache Python Distribution
    uses: actions/cache@v4
    with:
      path: python-embed.zip
      key: python-3.11.6-${{ matrix.platform }}
  ```

## Implementation Order

1. **Phase 1 - Critical Path Fixes (Build Blockers)**
   - Issue #1: Remove duplicate config from package.json
   - Issue #2: Fix output directory path in electron-builder.yml
   - Issue #4: Fix macOS Python distribution approach
   - Issue #5: Fix backend test to match production

2. **Phase 2 - Reliability Improvements**
   - Issue #6: Add build structure verification
   - Issue #7: Add artifact verification before upload
   - Issue #3: Fix Windows installer pattern
   - Issue #9: Improve Python package installation
   - Issue #12: Create macOS entitlements file

3. **Phase 3 - Completeness**
   - Issue #10: Verify backend path handling
   - Issue #11: Verify release metadata handling
   - Issue #8: Decide on Linux support and implement

4. **Phase 4 - Enhancements (Optional)**
   - Code signing configuration
   - macOS notarization
   - Build caching

## Testing Strategy

After each phase:
1. Push tag to trigger build workflow
2. Verify workflow completes without errors
3. Download artifacts from GitHub Actions
4. Test installation on target platform
5. Verify backend starts correctly
6. Verify app functionality
7. Test auto-update mechanism (for signed builds)

## Success Criteria

- GitHub Actions workflow completes successfully on all platforms
- Installable artifacts (EXE, DMG) are uploaded to GitHub Releases
- Downloaded installers work on Windows 10/11 and macOS 12+
- Backend starts correctly within installed application
- Python dependencies are all accessible
- Update metadata files are present for auto-update functionality

