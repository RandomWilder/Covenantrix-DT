# Feature 0035: Fix Rotating Messages Data Flow Issues

## Description
Fix the data flow issues preventing rotating messages from appearing in the UI during the 75% processing stage. The rotating messages are being generated correctly in the backend but are not reaching the frontend due to field name mismatches and frontend polling overwrites.

## Files to Modify

### backend/api/routes/documents.py
- **Lines 339, 374**: Fix field name mismatch in streaming route
- **Issue**: Looking for `'stage_message'` but registry stores as `'processing.message'`
- **Fix**: Update field access to correct registry structure

### covenantrix-desktop/src/hooks/useUpload.ts
- **Lines 126-130**: Fix frontend polling overwriting rotating messages
- **Issue**: Hardcoded static message overwrites rotating messages from backend
- **Fix**: Use backend message when available, fallback to static only when needed

## Implementation Details

### Algorithm
1. **Backend Fix**: Update streaming route to access correct registry field
2. **Frontend Fix**: Preserve backend messages in polling, only use static as fallback
3. **Data Flow**: Ensure rotating messages flow from service → registry → streaming → UI

### Backend Fix (documents.py)
**Current problematic code**:
```python
actual_message = registry_data.get('stage_message', service.STAGE_MESSAGES.get(event['stage'], "Processing..."))
```

**Should be**:
```python
processing_data = registry_data.get('processing', {})
actual_message = processing_data.get('message', service.STAGE_MESSAGES.get(event['stage'], "Processing..."))
```

### Frontend Fix (useUpload.ts)
**Current problematic code**:
```typescript
} else if (backendDoc.status === 'processing') {
  newStatus = 'processing'
  newStage = 'building_connections'
  newMessage = 'Building knowledge connections...'  // ❌ HARDCODED!
}
```

**Should be**:
```typescript
} else if (backendDoc.status === 'processing') {
  newStatus = 'processing'
  newStage = backendDoc.processing?.stage || 'building_connections'
  newMessage = backendDoc.processing?.message || 'Building knowledge connections...'
}
```

## Key Requirements

### What NOT to Touch
- **Rotating message generation**: Leave `_rotate_messages()` method unchanged
- **Registry storage**: Keep existing `update_processing_stage()` method
- **UI components**: No changes to `UploadProgress.tsx` - already handles `stageMessage`
- **Streaming logic**: Only fix field access, don't change streaming flow
- **Progress percentages**: Keep 25%, 50%, 75%, 90%, 100% unchanged

### Risk Mitigation
- **Backward compatibility**: Fallback to static messages if registry data missing
- **No breaking changes**: All existing functionality preserved
- **Minimal changes**: Only fix the specific data flow issues identified
- **Error handling**: Graceful fallback if registry data is malformed

## Implementation Steps

### Step 1: Fix Backend Field Access
- Update `documents.py` lines 339 and 374 to access `processing.message` instead of `stage_message`
- Add error handling for missing processing data
- Test that rotating messages are retrieved from registry

### Step 2: Fix Frontend Message Override
- Update `useUpload.ts` polling to use backend message when available
- Preserve existing fallback to static messages
- Ensure rotating messages from streaming are not overwritten by polling

### Step 3: Verify End-to-End Flow
- Test that rotating messages appear during 75% stage
- Verify fallback to static messages works when registry data missing
- Confirm no regression in existing functionality

## Complexity Assessment
**LOW** - Two simple field access fixes with minimal code changes, zero breaking changes to existing functionality.
