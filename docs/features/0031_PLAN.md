# Upload Progress Optimization Implementation Plan

## Feature Description
Optimize the upload progress system to improve performance, user experience, and maintainability. The implementation focuses on memoization of expensive calculations, smart polling optimization, component re-rendering fixes, state normalization, enhanced error handling, progressive upload implementation, and advanced progress granularity.

## Critical Pitfalls and Considerations

### ⚠️ **CRITICAL: Maintain Existing Functionality**
- **State Persistence**: The current localStorage-based state restoration MUST be preserved
- **Backend Integration**: Existing streaming upload API patterns must remain unchanged
- **Context Dependencies**: useUpload depends on SubscriptionContext, UpgradeModalContext, and useToast - these relationships must be maintained
- **File Object Handling**: Current File object management for Drive files (placeholder objects) must be preserved

### ⚠️ **CRITICAL: Avoid Breaking Changes**
- **Hook Interface**: The useUpload hook's return interface must remain identical
- **Component Props**: All existing component prop interfaces must be preserved
- **Type Definitions**: Existing type definitions in document.ts must not be modified
- **API Contracts**: Backend API streaming contracts must remain unchanged

### ⚠️ **CRITICAL: Separation of Concerns**
- **Context Boundaries**: Do not mix upload logic with subscription or settings logic
- **Component Boundaries**: Maintain clear separation between upload components and other features
- **Service Boundaries**: Keep API service patterns consistent with existing codebase

## Technical Requirements

### Phase 1: High Priority Performance Optimizations

#### 1.1 Memoization of Expensive Calculations
**Files to modify:**
- `covenantrix-desktop/src/hooks/useUpload.ts`
- `covenantrix-desktop/src/features/upload/components/UploadProgress.tsx`
- `covenantrix-desktop/src/features/upload/components/FileList.tsx`

**Implementation details:**
- Add `useMemo` hooks for progress percentage calculations
- Memoize file list rendering to prevent unnecessary re-renders
- Cache expensive file size calculations and format operations
- Implement memoized selectors for derived state

**⚠️ PITFALLS TO AVOID:**
- Do not memoize functions that depend on changing state (files, progress)
- Ensure memoization dependencies are correctly specified
- Avoid over-memoization that could cause stale closures

#### 1.2 Smart Polling Optimization
**Files to modify:**
- `covenantrix-desktop/src/hooks/useUpload.ts`

**Algorithm:**
1. Implement adaptive polling intervals based on upload state:
   - Active uploads: 1000ms (fast polling)
   - Processing files: 5000ms (slower polling)
   - Idle state: no polling
2. Add polling state management with `useRef` for interval tracking
3. Implement exponential backoff for failed polling attempts
4. Add cleanup logic to prevent memory leaks

**⚠️ PITFALLS TO AVOID:**
- Do not break existing polling logic that handles backend validation
- Maintain the current 2-second polling interval as fallback
- Ensure polling cleanup happens on component unmount
- Do not interfere with existing backend document status mapping

#### 1.3 Component Re-rendering Fixes
**Files to modify:**
- `covenantrix-desktop/src/features/upload/components/UploadProgress.tsx`
- `covenantrix-desktop/src/features/upload/components/FileList.tsx`
- `covenantrix-desktop/src/features/upload/UploadScreen.tsx`

**Implementation details:**
- Replace array recreation with immutable updates using `useCallback`
- Implement `React.memo` for child components to prevent unnecessary re-renders
- Use `useCallback` for event handlers to maintain referential equality
- Optimize state updates to avoid cascading re-renders

**⚠️ PITFALLS TO AVOID:**
- Do not break existing event handler patterns
- Maintain existing component prop interfaces
- Ensure React.memo comparisons are correct to avoid blocking necessary updates

### Phase 2: Medium Priority Improvements

#### 2.1 State Normalization
**Files to modify:**
- `covenantrix-desktop/src/hooks/useUpload.ts`
- `covenantrix-desktop/src/types/document.ts`

**Implementation details:**
- Create normalized state structure with separate entities for files, progress, and upload state
- Implement action-based state updates using reducer pattern
- Add state selectors for derived data access
- Create immutable update utilities for state mutations

**⚠️ PITFALLS TO AVOID:**
- Do not break existing state persistence logic
- Maintain backward compatibility with localStorage format
- Ensure normalized state doesn't conflict with existing File object handling
- Do not change the existing FileItem interface structure

#### 2.2 Enhanced Error Handling
**Files to modify:**
- `covenantrix-desktop/src/hooks/useUpload.ts`
- `covenantrix-desktop/src/features/upload/components/UploadProgress.tsx`
- `covenantrix-desktop/src/services/api/DocumentsApi.ts`

**Implementation details:**
- Add retry mechanisms for failed uploads with exponential backoff
- Implement detailed error context with error codes and recovery suggestions
- Add error boundary components for graceful error handling
- Create error recovery workflows for different failure scenarios

**⚠️ PITFALLS TO AVOID:**
- Do not break existing error handling patterns
- Maintain existing toast notification system
- Ensure error boundaries don't interfere with existing error display
- Do not change existing error message formats

#### 2.3 Progressive Upload Implementation
**Files to modify:**
- `covenantrix-desktop/src/hooks/useUpload.ts`
- `covenantrix-desktop/src/services/api/DocumentsApi.ts`

**Algorithm:**
1. Implement batch upload processing with configurable batch size (default: 3 files)
2. Add upload queue management with priority handling
3. Implement pause/resume functionality for individual files
4. Add upload throttling to prevent UI blocking

**⚠️ PITFALLS TO AVOID:**
- Do not break existing parallel upload logic for local vs Drive files
- Maintain existing streaming upload API patterns
- Ensure batch processing doesn't interfere with existing progress tracking
- Do not change the existing upload completion flow

### Phase 3: Advanced Progress Granularity

#### 3.1 Enhanced Progress Tracking
**Files to modify:**
- `covenantrix-desktop/src/types/document.ts`
- `covenantrix-desktop/src/features/upload/components/UploadProgress.tsx`
- `covenantrix-desktop/src/hooks/useUpload.ts`

**Implementation details:**
- Add stage-specific progress tracking within each document processing stage
- Implement time estimation algorithms based on historical data
- Add bytes processed tracking for more accurate progress display
- Create progress visualization components with stage-specific indicators

**⚠️ PITFALLS TO AVOID:**
- Do not modify existing DocumentProgressStage enum
- Maintain existing progress display patterns
- Ensure new progress tracking doesn't conflict with existing stage mapping
- Do not change existing progress bar calculations

## Implementation Phases

### Phase 1: Core Performance (Immediate Impact)
1. Implement memoization in `useUpload` hook
2. Add smart polling optimization
3. Fix component re-rendering issues
4. Test performance improvements

### Phase 2: Architecture Improvements (Significant Improvement)
1. Implement state normalization
2. Add enhanced error handling
3. Implement progressive upload
4. Test reliability improvements

### Phase 3: UX Enhancement (Nice to Have)
1. Add advanced progress granularity
2. Implement enhanced progress visualization
3. Test user experience improvements

## Files to Create/Modify

**Core Files:**
- `covenantrix-desktop/src/hooks/useUpload.ts` - Main optimization target
- `covenantrix-desktop/src/features/upload/components/UploadProgress.tsx` - Progress display optimization
- `covenantrix-desktop/src/features/upload/components/FileList.tsx` - File list optimization
- `covenantrix-desktop/src/features/upload/UploadScreen.tsx` - Main screen optimization

**Supporting Files:**
- `covenantrix-desktop/src/types/document.ts` - Type definitions
- `covenantrix-desktop/src/services/api/DocumentsApi.ts` - API optimization
- `covenantrix-desktop/src/features/upload/components/FileUploadArea.tsx` - Upload area optimization

**New Files:**
- `covenantrix-desktop/src/hooks/useUploadOptimized.ts` - Optimized upload hook
- `covenantrix-desktop/src/utils/uploadHelpers.ts` - Upload utility functions
- `covenantrix-desktop/src/components/ErrorBoundary.tsx` - Error handling component

## Critical Implementation Notes

### **DO NOT:**
1. **Modify existing interfaces** - Keep all existing prop types and return types
2. **Break state persistence** - Maintain localStorage-based state restoration
3. **Change API contracts** - Keep existing streaming upload patterns
4. **Interfere with context dependencies** - Maintain existing context usage patterns
5. **Modify existing type definitions** - Keep document.ts types unchanged
6. **Break existing error handling** - Maintain current error display patterns
7. **Change existing polling logic** - Keep backend validation patterns intact

### **DO:**
1. **Add optimizations incrementally** - Test each change thoroughly
2. **Maintain backward compatibility** - Ensure existing functionality works
3. **Follow existing patterns** - Use established codebase conventions
4. **Preserve separation of concerns** - Keep upload logic isolated
5. **Test thoroughly** - Verify all existing functionality still works
6. **Document changes** - Clearly mark what was optimized and why
