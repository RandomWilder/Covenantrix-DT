# AI Assistant Chat Interface - Technical Plan

## Overview
Implement AI Assistant chat interface with three-panel resizable layout, leveraging existing RAG engine and agent framework. The implementation follows clean architecture principles with proper separation of concerns between domain, infrastructure, and API layers.

## Backend Implementation

### 1. Domain Layer - Chat Service
**File:** `backend/domain/chat/service.py` (NEW)

**Responsibilities:**
- Route messages to RAG engine or agent orchestrator
- Maintain conversation context
- Handle document context injection
- Format responses with citations

**Key Methods:**
```python
async def send_message(
    message: str,
    conversation_id: Optional[str],
    agent_id: Optional[str],
    document_ids: Optional[List[str]]
) -> ChatResponse

async def get_conversation_history(conversation_id: str) -> List[Message]
async def create_conversation(title: str) -> Conversation
async def delete_conversation(conversation_id: str) -> bool
```

**Integration Points:**
- Use existing `RAGEngine` for document Q&A (read-only)
- Use existing `AgentOrchestrator` for agent tasks (read-only)
- Use existing `DocumentService` for document access (read-only)

### 2. Domain Layer - Chat Models
**File:** `backend/domain/chat/models.py` (NEW)

**Data Models:**
```python
from datetime import datetime
from typing import List, Literal, Optional
from pydantic import BaseModel

class Conversation(BaseModel):
    id: str
    title: str
    created_at: datetime
    updated_at: datetime
    messages: List['Message']

class Message(BaseModel):
    id: str
    role: Literal["user", "assistant"]
    content: str
    sources: List['Source']
    timestamp: datetime

class ChatResponse(BaseModel):
    conversation_id: str
    message_id: str
    response: str
    sources: List['Source']
```

### 3. Domain Layer - Chat Exceptions
**File:** `backend/domain/chat/exceptions.py` (NEW)

**Exception Classes:**
```python
from core.exceptions import CovenantrixException
from fastapi import status

class ChatError(CovenantrixException):
    """Base chat error"""
    
    def __init__(self, message: str):
        super().__init__(
            message=message,
            error_code="CHAT_ERROR",
            status_code=status.HTTP_422_UNPROCESSABLE_ENTITY
        )

class ConversationNotFoundError(ChatError):
    """Conversation not found"""
    pass

class MessageProcessingError(ChatError):
    """Message processing failed"""
    pass
```

### 4. Infrastructure Layer - Chat Storage
**File:** `backend/infrastructure/storage/chat_storage.py` (NEW)

**Storage Strategy:**
- JSON files in `{WORKING_DIR}/conversations/`
- Separate file per conversation: `{conversation_id}.json`
- Index file for conversation metadata: `conversations_index.json`

**Key Methods:**
```python
async def save_conversation(conversation: Conversation) -> None
async def load_conversation(conversation_id: str) -> Optional[Conversation]
async def list_conversations() -> List[ConversationSummary]
async def delete_conversation(conversation_id: str) -> bool
```

### 5. API Layer - Chat Routes
**File:** `backend/api/routes/chat.py` (NEW)

**Endpoints:**
```python
POST   /chat/message                    # Send message, get response
GET    /chat/conversations             # List conversation history
POST   /chat/conversations             # Create new conversation
DELETE /chat/conversations/{id}        # Delete conversation
GET    /chat/conversations/{id}/messages # Get conversation messages
```

**Request/Response Schemas:**
```python
# Send message
class ChatMessageRequest(BaseModel):
    conversation_id: Optional[str] = None
    message: str
    agent_id: Optional[str] = None
    document_ids: Optional[List[str]] = None

class ChatMessageResponse(BaseResponse):  # Inherit from BaseResponse
    conversation_id: str
    message_id: str
    response: str
    sources: List[Source]
```

### 6. API Layer - Chat Schemas
**File:** `backend/api/schemas/chat.py` (NEW)

**Schema Definitions:**
```python
from api.schemas.common import BaseResponse
from typing import List, Optional
from pydantic import BaseModel

class ChatMessageRequest(BaseModel):
    conversation_id: Optional[str] = None
    message: str
    agent_id: Optional[str] = None
    document_ids: Optional[List[str]] = None

class ChatMessageResponse(BaseResponse):
    conversation_id: str
    message_id: str
    response: str
    sources: List[Source]  # Reuse existing Source type

class ConversationResponse(BaseResponse):
    conversation: Conversation

class ConversationListResponse(BaseResponse):
    conversations: List[Conversation]
    total_count: int

class MessageListResponse(BaseResponse):
    messages: List[Message]
    total_count: int
```

### 7. Dependency Injection
**File:** `backend/core/dependencies.py` (MODIFY)

**Add Chat Dependencies:**
```python
def get_chat_service() -> ChatService:
    """Get chat service with dependencies"""
    rag_engine = get_rag_engine()
    agent_orchestrator = get_agent_orchestrator()
    document_service = get_document_service()
    chat_storage = get_chat_storage()
    
    return ChatService(
        rag_engine=rag_engine,
        agent_orchestrator=agent_orchestrator,
        document_service=document_service,
        chat_storage=chat_storage
    )

def get_chat_storage() -> ChatStorage:
    """Get chat storage instance"""
    settings = get_settings()
    return ChatStorage(settings.storage.working_dir)
```

### 8. Router Integration
**File:** `backend/main.py` (MODIFY)

**Add Chat Router:**
```python
from api.routes import chat

# In create_application():
app.include_router(chat.router)
```

## Frontend Implementation

### 1. Chat Type Definitions
**File:** `covenantrix-desktop/src/types/chat.ts` (NEW)

**Type Definitions:**
```typescript
export interface Conversation {
  id: string
  title: string
  created_at: string
  updated_at: string
  messages: Message[]
}

export interface Message {
  id: string
  role: 'user' | 'assistant'
  content: string
  sources: Source[]
  timestamp: string
}

export interface ChatMessageRequest {
  conversation_id?: string
  message: string
  agent_id?: string
  document_ids?: string[]
}

export interface ChatMessageResponse {
  success: boolean
  conversation_id: string
  message_id: string
  response: string
  sources: Source[]
}

export interface ChatContextValue {
  // Conversation state
  activeConversation: Conversation | null
  conversations: Conversation[]
  
  // UI state
  selectedAgent: string | null
  isTyping: boolean
  
  // Actions
  sendMessage: (message: string, documentIds?: string[]) => Promise<void>
  createConversation: () => Promise<string>
  deleteConversation: (id: string) => Promise<void>
  selectAgent: (agentId: string | null) => void
}
```

### 2. Chat Context
**File:** `covenantrix-desktop/src/contexts/ChatContext.tsx` (NEW)

**State Management:**
- Import types from `../types/chat`
- Use existing `useToast` hook for error handling
- Follow existing context patterns from `SettingsContext`

### 3. Panel Layout Hook
**File:** `covenantrix-desktop/src/hooks/usePanelLayout.ts` (NEW)

**Layout State:**
```typescript
interface PanelLayout {
  leftWidth: number      // 10-30%
  rightWidth: number      // 10-30%
  leftCollapsed: boolean
  rightCollapsed: boolean
  centerWidth: number     // Calculated: 100 - leftWidth - rightWidth
}
```

**Constraints:**
- Center always 40-80% when both panels visible
- Center expands over collapsed panels
- Persist layout to localStorage

### 4. Chat Screen Component
**File:** `covenantrix-desktop/src/features/chat/ChatScreen.tsx` (NEW)

**Structure:**
```tsx
<div className="chat-screen">
  <ChatTopBar />
  <div className="panels-container">
    <HistoryPanel width={leftWidth} collapsed={leftCollapsed} />
    <Resizer onResize={handleLeftResize} />
    <ChatPanel width={centerWidth} />
    <Resizer onResize={handleRightResize} />
    <ContextPanel width={rightWidth} collapsed={rightCollapsed} />
  </div>
</div>
```

### 5. Panel Components

**History Panel** (`features/chat/HistoryPanel.tsx`):
- Conversation list with timestamps
- Search/filter conversations
- New chat button
- Delete conversation

**Chat Panel** (`features/chat/ChatPanel.tsx`):
- Reuse existing `MessageList` component
- Integrate existing `ChatInput` component
- Add typing indicator
- Auto-scroll on new messages

**Context Panel** (`features/chat/ContextPanel.tsx`):
- List active documents in context
- Show citation sources from responses
- Document preview on click
- Clear context button

**Panel Resizer** (`components/ui/Resizer.tsx`):
- Draggable split bar
- Visual feedback on hover/drag
- Snap to min/max widths
- Double-click to reset

### 6. Chat API Service
**File:** `covenantrix-desktop/src/services/api/ChatApi.ts` (NEW)

**API Methods:**
```typescript
class ChatApi extends ApiService {
  async sendMessage(request: ChatMessageRequest): Promise<ChatMessageResponse>
  async getConversations(): Promise<ConversationListResponse>
  async createConversation(title: string): Promise<ConversationResponse>
  async deleteConversation(id: string): Promise<void>
  async getConversationMessages(id: string): Promise<MessageListResponse>
}
```

### 7. Router Integration
**File:** `covenantrix-desktop/src/components/layout/AppLayout.tsx` (MODIFY)

**Add Chat Route:**
```tsx
case 'chat':
  return <ChatScreen />
```

**File:** `covenantrix-desktop/src/components/layout/Sidebar.tsx` (MODIFY)

**Add Chat Navigation:**
- Add chat navigation item with MessageSquare icon
- Follow existing navigation patterns

## Implementation Phases

### Phase 1: Backend Foundation (Data Layer)
1. Create `domain/chat/models.py` - data models
2. Create `domain/chat/exceptions.py` - exception classes
3. Create `infrastructure/storage/chat_storage.py` - persistence
4. Create `domain/chat/service.py` - business logic
5. Create `api/schemas/chat.py` - API schemas
6. Create `api/routes/chat.py` - API endpoints
7. Wire dependencies in `core/dependencies.py`
8. Add router to `main.py`

### Phase 2: Frontend Layout (UI Foundation)
1. Create `types/chat.ts` - type definitions
2. Create `hooks/usePanelLayout.ts` - layout state management
3. Create `components/ui/Resizer.tsx` - panel resizer component
4. Create `features/chat/ChatScreen.tsx` - main screen shell
5. Implement panel collapse/expand functionality
6. Test responsive behavior and constraints

### Phase 3: Chat Functionality (Core Features)
1. Create `contexts/ChatContext.tsx` - state management
2. Create `services/api/ChatApi.ts` - API integration
3. Build `features/chat/HistoryPanel.tsx` - conversation list
4. Build `features/chat/ChatPanel.tsx` - integrate existing components
5. Build `features/chat/ContextPanel.tsx` - document context
6. Wire API calls and test message flow
7. Add error handling with `useToast` hook

### Phase 4: Polish & Integration (UX Enhancement)
1. Add typing indicators
2. Implement auto-title generation
3. Add conversation search/filtering
4. Error handling and loading states
5. Integration testing
6. Performance optimization
7. Update `AppLayout.tsx` and `Sidebar.tsx` for navigation

## Safety Guardrails

### ‚ö†Ô∏è DO NOT BREAK
- Existing document upload/processing flow
- Current RAG query endpoint (`/queries`)
- Agent orchestrator task system (`/agents/tasks`)
- Document context management
- Settings and configuration

### ‚úÖ SAFE TO MODIFY
- Add new routes (don't modify existing)
- Add new storage modules (separate from document storage)
- Create new frontend components
- Add new context providers

### üîç CAREFUL INTEGRATION
- **RAG Engine**: Only read, don't modify core functionality
- **Agent Orchestrator**: Use existing task submission, don't change orchestrator
- **Document Service**: Use existing methods, don't alter schemas
- **Navigation**: Add route, maintain existing screens

## Data Flow

```
User sends message
    ‚Üì
ChatContext.sendMessage()
    ‚Üì
API: POST /chat/message
    ‚Üì
ChatService.send_message()
    ‚Üì
[If agent selected] ‚Üí AgentOrchestrator.submit_task()
[If no agent] ‚Üí RAGEngine.query()
    ‚Üì
Format response with sources
    ‚Üì
Save to ChatStorage
    ‚Üì
Return response
    ‚Üì
Update ChatContext
    ‚Üì
Render in MessageList
```

## Technical Considerations

### Conversation Context
- Include last 10 messages in RAG query for context
- Reset context on "New Chat"
- Maintain document context across conversation

### Performance
- Lazy load conversation history (paginate old conversations)
- Debounce panel resize events
- Virtual scrolling for long message lists (optional)

### State Persistence
- Save panel layout to localStorage
- Auto-save draft messages
- Persist active conversation ID

### Error Handling
- Network failure recovery
- API timeout handling
- Invalid agent selection fallback
- Missing document context warning

## Dependencies

### New Backend Dependencies
None - use existing packages

### New Frontend Dependencies
None - implement custom resize with native React hooks to avoid dependency bloat

## Success Criteria

‚úÖ User can start new conversation
‚úÖ User can send messages and receive responses
‚úÖ Responses include document citations
‚úÖ User can select different agents
‚úÖ Conversation history persists and loads
‚úÖ Panels resize and collapse correctly
‚úÖ Context panel shows active documents
‚úÖ Typing indicator shows during response
‚úÖ No disruption to existing features
‚úÖ Clean error messages on failure
