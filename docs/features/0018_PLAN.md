# Feature 0018: Version Update Notifications - Phase 2

## Overview
Transform version update detection from immediate dialogs to notification-based workflow. When updates are available, system creates notification silently, displays in notification center, and allows user to act on their own time. Replaces blocking `dialog.showMessageBox()` calls with notification creation via backend API. Implements two notification types: "Update Available" and "Update Ready to Install".

---

## Electron Main Process - Update Manager

### 1. Notification Creation Methods
**Modify File:** `covenantrix-desktop/electron/updater.js`

Add utility methods to UpdateManager class:
- `formatReleaseNotes(info)` - Format release notes with version comparison, notes text, and download size
- `formatBytes(bytes)` - Convert bytes to MB string (e.g., "145.8 MB")
- `async createUpdateNotification(info, notificationType)` - Create notification via backend POST API
  - notificationType: 'update_available' or 'update_ready'
  - Construct notification payload with title, summary, content, actions, metadata
  - Use dedup_key: `version_update_${info.version}` for update_available
  - Use dedup_key: `version_ready_${info.version}` for update_ready
  - Call backend: `POST ${backendUrl}/api/notifications`
  - Use global.backendUrl for URL resolution
  - Error handling: On failure, fallback to promptUserToDownload/promptUserToInstall (keep existing dialog methods as backup)
  - Log success/failure

### 2. Update Available Event Handler
**Modify File:** `covenantrix-desktop/electron/updater.js`

Replace `update-available` event handler (line 36-43):
- Remove call to `this.promptUserToDownload(info)`
- Add call to `await this.createUpdateNotification(info, 'update_available')`
- Notification payload:
  - type: 'version_update'
  - source: 'local'
  - title: `Version ${info.version} Available`
  - summary: `Update to Covenantrix ${info.version}`
  - content: Formatted release notes from formatReleaseNotes()
  - actions: [{ label: 'Download Now', action: 'download_update' }, { label: 'Later', action: 'dismiss' }]
  - metadata: { version, current_version, release_date, download_size, dedup_key }
- After notification created, send IPC event: `this.sendStatusToWindow('update-notification-created')`

### 3. Update Downloaded Event Handler
**Modify File:** `covenantrix-desktop/electron/updater.js`

Replace `update-downloaded` event handler (line 65-71):
- Remove call to `this.promptUserToInstall(info)`
- Add call to `await this.createUpdateNotification(info, 'update_ready')`
- Notification payload:
  - type: 'version_ready'
  - source: 'local'
  - title: `Update Ready to Install`
  - summary: `Version ${info.version} is ready`
  - content: Brief message about restart requirement
  - actions: [{ label: 'Restart Now', action: 'install_update' }, { label: 'Later', action: 'dismiss' }]
  - metadata: { version, current_version, dedup_key }
- After notification created, send IPC event: `this.sendStatusToWindow('update-ready-notification-created')`

### 4. Backup Dialog Methods
**Modify File:** `covenantrix-desktop/electron/updater.js`

Keep existing dialog methods but mark as fallback:
- `promptUserToDownload(info)` - Keep unchanged, used as fallback on notification creation failure
- `promptUserToInstall(info)` - Keep unchanged, used as fallback on notification creation failure
- Add comments indicating these are fallback mechanisms

### 5. HTTP Request Implementation
**Modify File:** `covenantrix-desktop/electron/updater.js`

In createUpdateNotification method:
- Use native fetch (Node 18+ support): `const response = await fetch(url, options)`
- Request configuration:
  - Method: POST
  - Headers: { 'Content-Type': 'application/json' }
  - Body: JSON.stringify(notificationData)
- Response handling: Check response.ok, throw error if not ok
- Error handling: Try/catch block, log error, fallback to dialog

---

## Frontend - Action Handling

### 1. Update Action Handler
**Modify File:** `covenantrix-desktop/src/contexts/NotificationContext.tsx`

Replace stub `handleAction` method (line 77-81) with full implementation:
- Switch on action parameter:
  - Case 'download_update': Call `window.electronAPI.update.download()`, dismiss notification after success
  - Case 'install_update': Call `window.electronAPI.update.install()`, dismiss notification (app will restart)
  - Case 'dismiss': Mark notification as read, collapse notification (already handled by markAsRead and toggleExpanded)
  - Default: Log unknown action warning
- Add async/await for IPC calls
- Error handling: Try/catch with console.error
- Update local state after actions (call dismissNotification for download_update and install_update)

### 2. Event Listener for Notification Creation
**Modify File:** `covenantrix-desktop/src/contexts/NotificationContext.tsx`

Add useEffect for IPC event listeners:
- Listen for 'update-notification-created' event
- Listen for 'update-ready-notification-created' event
- Handler: Call fetchNotifications() to refresh list
- Cleanup: Remove listeners on unmount
- Use window.electronAPI.onUpdateNotificationCreated callback registration

---

## IPC Bridge - Update Actions

### 1. Preload API Extension
**Modify File:** `covenantrix-desktop/electron/preload.js`

Add update actions to electronAPI object:
```
update: {
  download: () => ipcRenderer.invoke('update:download'),
  install: () => ipcRenderer.invoke('update:install')
},
onUpdateNotificationCreated: (callback) => {
  const handler = () => callback();
  ipcRenderer.on('update-notification-created', handler);
  return () => ipcRenderer.removeListener('update-notification-created', handler);
},
onUpdateReadyNotificationCreated: (callback) => {
  const handler = () => callback();
  ipcRenderer.on('update-ready-notification-created', handler);
  return () => ipcRenderer.removeListener('update-ready-notification-created', handler);
}
```

### 2. IPC Handlers for Update Actions
**Modify File:** `covenantrix-desktop/electron/ipc-handlers.js`

Add to registerNotificationHandlers function (or create separate registerUpdateHandlers):
- `update:download` handler:
  - Get updateManager instance
  - Call autoUpdater.downloadUpdate()
  - Set downloadInProgress flag
  - Return { success: true }
  - Error handling: Return { success: false, error: message }
- `update:install` handler:
  - Import autoUpdater from electron-updater
  - Call autoUpdater.quitAndInstall(false, true)
  - No return needed (app will quit)

### 3. Update Manager Access
**Modify File:** `covenantrix-desktop/electron/ipc-handlers.js`

Import updateManager from updater.js at top:
```
const { updateManager } = require('./updater')
```

Access updateInfo and trigger download:
- updateManager.updateInfo contains current update information
- Call autoUpdater.downloadUpdate() directly (imported from electron-updater)

---

## Implementation Details

### Notification Payload Structure

**Update Available Notification:**
```json
{
  "type": "version_update",
  "source": "local",
  "title": "Version 1.2.0 Available",
  "summary": "Update to Covenantrix 1.2.0",
  "content": "**Current Version:** 1.1.8\n**New Version:** 1.2.0\n\n**Release Notes:**\n[formatted notes]\n\n**Download Size:** 145.8 MB",
  "actions": [
    { "label": "Download Now", "action": "download_update" },
    { "label": "Later", "action": "dismiss" }
  ],
  "metadata": {
    "version": "1.2.0",
    "current_version": "1.1.8",
    "release_date": "2025-10-15",
    "download_size": 152847360,
    "dedup_key": "version_update_1.2.0"
  }
}
```

**Update Ready Notification:**
```json
{
  "type": "version_ready",
  "source": "local",
  "title": "Update Ready to Install",
  "summary": "Version 1.2.0 is ready",
  "content": "Covenantrix 1.2.0 has been downloaded and is ready to install.\n\nThe application will restart to complete the update.\n\nClick 'Restart Now' when ready.",
  "actions": [
    { "label": "Restart Now", "action": "install_update" },
    { "label": "Later", "action": "dismiss" }
  ],
  "metadata": {
    "version": "1.2.0",
    "current_version": "1.1.8",
    "dedup_key": "version_ready_1.2.0"
  }
}
```

### Deduplication Logic
- Update Available: dedup_key = `version_update_${version}` prevents duplicate notifications if app reopened before updating
- Update Ready: dedup_key = `version_ready_${version}` prevents duplicate ready notifications
- Backend service checks dedup_key in metadata, returns existing notification if found and not dismissed

### Release Notes Formatting
Algorithm in formatReleaseNotes(info):
1. Extract info.releaseNotes (string or HTML)
2. If HTML, strip tags to plain text (simple regex: replace /<[^>]*>/g with '')
3. Format structure:
   - Current Version: app.getVersion()
   - New Version: info.version
   - Release Notes section: Formatted notes text
   - Download Size: formatBytes(info.files[0]?.size)
4. Return as markdown string with line breaks

### Download Size Formatting
Algorithm in formatBytes(bytes):
1. If bytes null/undefined, return "Unknown"
2. Convert to MB: bytes / 1024 / 1024
3. Format to 2 decimal places: mb.toFixed(2)
4. Return "${mb} MB"

### Error Handling Strategy
All notification creation wrapped in try/catch:
```javascript
try {
  await this.createUpdateNotification(info, type);
  log.info('Notification created successfully');
} catch (error) {
  log.error('Failed to create notification, falling back to dialog:', error);
  // Call original dialog method as fallback
  this.promptUserToDownload(info);
}
```

This ensures zero disruption if notification system fails - user still gets update prompts via dialogs.

---

## File Modifications Summary

```
covenantrix-desktop/electron/
├── updater.js                   [MODIFY]
│   - Add formatReleaseNotes()
│   - Add formatBytes()
│   - Add createUpdateNotification()
│   - Replace update-available handler
│   - Replace update-downloaded handler
│   - Keep dialog methods as fallback
│
├── preload.js                   [MODIFY]
│   - Add update.download IPC method
│   - Add update.install IPC method
│   - Add onUpdateNotificationCreated event listener
│   - Add onUpdateReadyNotificationCreated event listener
│
└── ipc-handlers.js              [MODIFY]
    - Import updateManager from updater
    - Add update:download handler
    - Add update:install handler

covenantrix-desktop/src/
├── contexts/
│   └── NotificationContext.tsx  [MODIFY]
│       - Implement full handleAction logic
│       - Add useEffect for update notification events
│
└── types/
    └── notification.ts          [VERIFY]
        - Ensure action types match ('download_update', 'install_update', 'dismiss')
```

---

## Testing Scenarios

### Scenario 1: Update Available
1. Trigger update check (dev: mock autoUpdater event)
2. Verify notification created in backend storage
3. Verify red dot appears on bell icon
4. Open notification modal
5. Verify "Version X.X.X Available" notification displayed
6. Expand notification
7. Verify release notes, download size, action buttons visible
8. Click "Download Now"
9. Verify download starts (check logs)
10. Verify notification dismissed from list

### Scenario 2: Update Ready
1. After download completes (Scenario 1)
2. Verify new notification created: "Update Ready to Install"
3. Verify notification appears in list
4. Expand notification
5. Verify "Restart Now" and "Later" buttons visible
6. Click "Restart Now"
7. Verify app quits and installs update

### Scenario 3: Later Action
1. Expand update notification
2. Click "Later" button
3. Verify notification marked as read
4. Verify notification collapses
5. Verify notification remains in list
6. Verify red dot disappears (if only unread notification)
7. Re-expand notification
8. Verify action buttons still available

### Scenario 4: Dismiss Notification
1. Click X button on notification
2. Verify notification removed from list
3. Restart app (before updating)
4. Verify notification not present (dedup prevented recreation)

### Scenario 5: Fallback to Dialogs
1. Stop backend server
2. Trigger update check
3. Verify dialog appears (fallback)
4. Verify error logged about notification creation failure

### Scenario 6: Deduplication
1. Create update notification
2. Restart app (without updating)
3. Trigger update check again
4. Verify no duplicate notification created
5. Verify existing notification still present

### Scenario 7: Multiple Update Cycle
1. Update available notification created
2. Click "Download Now"
3. Download completes
4. Update ready notification created
5. Verify both notifications handled correctly
6. Original "update available" dismissed
7. New "update ready" notification displayed

---

## Implementation Order

1. **Update Manager Methods** (updater.js formatters and createUpdateNotification)
2. **Event Handler Modifications** (updater.js update-available and update-downloaded)
3. **IPC Handlers** (ipc-handlers.js update actions)
4. **Preload API** (preload.js update methods)
5. **Action Handler** (NotificationContext.tsx handleAction implementation)
6. **Event Listeners** (NotificationContext.tsx update notification events)
7. **Testing** (Manual verification of all scenarios)

Each step builds on previous, allowing incremental testing.

---

## Rollback Strategy

If critical issues discovered:
1. Comment out notification creation calls in updater.js
2. Uncomment original promptUserToDownload/promptUserToInstall calls
3. System reverts to dialog-based flow
4. Debug notification system separately
5. No changes to backend notification infrastructure needed (already working from Phase 1)

Keep dialog methods intact for 1 release cycle, then remove after notification system proven stable in production.

