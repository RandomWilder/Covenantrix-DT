# Upload Component Alignment and Visibility Plan

## Overview
This plan addresses the critical issues identified in the upload progress optimization review (0031_REVIEW.md) and ensures all upload components are properly aligned, visible, and functional on the upload tab. The implementation will consolidate multiple upload hooks, standardize interfaces, and fix component visibility issues.

## Current Issues Identified

### Critical Issues
1. **Interface Duplication**: Multiple `FileItem` interfaces across files with inconsistent properties
2. **Hook Fragmentation**: Three separate upload hooks (`useUpload`, `useUploadOptimized`, `useProgressiveUpload`) with overlapping functionality
3. **Component Visibility**: Upload components not properly displayed in UploadScreen
4. **Type Inconsistencies**: Different interfaces for the same data structures across components
5. **Memory Leaks**: Polling intervals not properly cleaned up
6. **Data Alignment**: API response structure mismatches

### Files Requiring Changes

#### Core Type Definitions
- `covenantrix-desktop/src/types/document.ts` - Consolidate FileItem interfaces
- `covenantrix-desktop/src/types/upload.ts` - Create unified upload types (new file)

#### Upload Hooks
- `covenantrix-desktop/src/hooks/useUpload.ts` - Main hook to consolidate functionality
- `covenantrix-desktop/src/hooks/useUploadOptimized.ts` - Remove (consolidate into useUpload)
- `covenantrix-desktop/src/hooks/useProgressiveUpload.ts` - Remove (consolidate into useUpload)
- `covenantrix-desktop/src/hooks/useUploadUnified.ts` - New unified hook (new file)

#### Upload Components
- `covenantrix-desktop/src/features/upload/UploadScreen.tsx` - Fix component visibility and integration
- `covenantrix-desktop/src/features/upload/components/UploadProgress.tsx` - Standardize interface
- `covenantrix-desktop/src/features/upload/components/EnhancedUploadProgress.tsx` - Remove (consolidate)
- `covenantrix-desktop/src/features/upload/components/ProgressVisualization.tsx` - Integrate into main progress
- `covenantrix-desktop/src/features/upload/components/FileList.tsx` - Update to use unified types

#### Utility Files
- `covenantrix-desktop/src/utils/uploadHelpers.ts` - Update to use unified types
- `covenantrix-desktop/src/services/api/DocumentsApi.ts` - Fix data alignment issues

## Implementation Plan

### Phase 1: Type System Consolidation

#### 1.1 Create Unified Upload Types
Create `covenantrix-desktop/src/types/upload.ts` with comprehensive type definitions:

```typescript
// Unified FileItem interface with all possible properties
export interface FileItem {
  id: string
  file: File
  filename: string
  documentId?: string
  status: 'pending' | 'uploading' | 'processing' | 'completed' | 'failed' | 'paused' | 'queued'
  progress?: number
  error?: string
  stage?: DocumentProgressStage
  stageMessage?: string
  source: 'local' | 'drive'
  sourceAccount?: string
  driveAccountId?: string
  driveFileId?: string
  priority?: number
  retryCount?: number
  maxRetries?: number
  createdAt: number
  updatedAt: number
}

// Unified UploadProgress interface
export interface UploadProgress {
  total: number
  completed: number
  failed: number
  current?: string
  files: FileItem[]
  startTime?: number
  estimatedTimeRemaining?: number
  overallProgress: number
}

// Upload queue management
export interface UploadQueue {
  pending: FileItem[]
  uploading: FileItem[]
  processing: FileItem[]
  completed: FileItem[]
  failed: FileItem[]
  paused: FileItem[]
}

// Upload statistics
export interface UploadStats {
  startTime: number
  totalFiles: number
  completedFiles: number
  failedFiles: number
  totalSize: number
  uploadedSize: number
  averageSpeed: number
  estimatedTimeRemaining: number
}
```

#### 1.2 Update Document Types
Update `covenantrix-desktop/src/types/document.ts` to remove duplicate interfaces and import from upload types.

### Phase 2: Hook Consolidation

#### 2.1 Create Unified Upload Hook
Create `covenantrix-desktop/src/hooks/useUploadUnified.ts` that consolidates all functionality:

**Core Features:**
- File management (add, remove, clear)
- Upload state management with reducer pattern
- Progress tracking with memoization
- Backend polling with proper cleanup
- Error handling and retry logic
- Batch processing capabilities
- Queue management
- Performance optimizations

**Hook Interface:**
```typescript
interface UseUploadReturn {
  // File management
  files: FileItem[]
  addFiles: (files: File[]) => void
  addDriveFiles: (files: Array<{id: string; name: string}>, accountId: string, accountEmail: string) => void
  removeFile: (fileId: string) => void
  clearFiles: () => void
  
  // Upload control
  isUploading: boolean
  startUpload: () => Promise<void>
  pauseUpload: () => void
  resumeUpload: () => void
  cancelUpload: () => void
  
  // Progress tracking
  uploadProgress: UploadProgress
  uploadStats: UploadStats
  queue: UploadQueue
  
  // File operations
  pauseFile: (fileId: string) => void
  resumeFile: (fileId: string) => void
  retryFile: (fileId: string) => void
  setFilePriority: (fileId: string, priority: number) => void
  
  // Computed values
  progressCalculations: {
    completed: number
    failed: number
    total: number
    overallProgress: number
    hasActiveUploads: boolean
    hasCompletedUploads: boolean
    hasFailedUploads: boolean
  }
  fileSizeInfo: {
    totalSize: number
    formattedTotalSize: string
    formatFileSize: (bytes: number) => string
  }
}
```

#### 2.2 Remove Duplicate Hooks
- Remove `useUploadOptimized.ts`
- Remove `useProgressiveUpload.ts`
- Update `useUpload.ts` to be a simple wrapper around `useUploadUnified`

### Phase 3: Component Standardization

#### 3.1 Update UploadScreen
Modify `covenantrix-desktop/src/features/upload/UploadScreen.tsx` to:

**Component Structure:**
```typescript
const UploadScreen: React.FC = () => {
  const {
    files,
    isUploading,
    uploadProgress,
    uploadStats,
    queue,
    addFiles,
    addDriveFiles,
    removeFile,
    clearFiles,
    startUpload,
    pauseUpload,
    resumeUpload,
    pauseFile,
    resumeFile,
    retryFile,
    setFilePriority,
    progressCalculations,
    fileSizeInfo
  } = useUploadUnified()

  // Component layout with proper visibility
  return (
    <div className="h-full flex flex-col">
      {/* Header */}
      <Header />
      
      {/* Feature Guard Banner */}
      <FeatureGuardBanner />
      
      {/* Tab Navigation */}
      <TabNavigation />
      
      {/* Main Content */}
      <MainContent>
        {/* File Upload Areas */}
        <FileUploadAreas />
        
        {/* File List - Always visible when files exist */}
        {files.length > 0 && (
          <FileList 
            files={files}
            onRemoveFile={removeFile}
            onPauseFile={pauseFile}
            onResumeFile={resumeFile}
            onRetryFile={retryFile}
            onSetPriority={setFilePriority}
          />
        )}
      </MainContent>
      
      {/* Progress Section - Always visible during upload */}
      {(isUploading || progressCalculations.hasActiveUploads) && (
        <ProgressSection>
          <UploadProgress 
            progress={uploadProgress}
            stats={uploadStats}
            queue={queue}
            onPauseUpload={pauseUpload}
            onResumeUpload={resumeUpload}
          />
        </ProgressSection>
      )}
      
      {/* Action Buttons - Always visible when files exist */}
      {files.length > 0 && (
        <ActionButtons />
      )}
    </div>
  )
}
```

#### 3.2 Consolidate Progress Components
Create single `UploadProgress` component that includes:

**Features:**
- Overall progress visualization
- File-by-file progress tracking
- Stage-specific progress indicators
- Queue management controls
- Upload statistics
- Error handling and retry options

**Component Structure:**
```typescript
interface UploadProgressProps {
  progress: UploadProgress
  stats: UploadStats
  queue: UploadQueue
  onPauseUpload: () => void
  onResumeUpload: () => void
  onPauseFile: (fileId: string) => void
  onResumeFile: (fileId: string) => void
  onRetryFile: (fileId: string) => void
  onSetPriority: (fileId: string, priority: number) => void
}
```

#### 3.3 Update FileList Component
Enhance `FileList` component to show:

**Features:**
- File status with icons
- Progress bars for active uploads
- Stage indicators
- Priority controls
- Pause/resume/retry buttons
- Error messages
- File size and source information

### Phase 4: API and Data Alignment

#### 4.1 Fix DocumentsApi Data Alignment
Update `covenantrix-desktop/src/services/api/DocumentsApi.ts` to handle both response formats:

```typescript
// Add type guards for API responses
const isDocumentListResponse = (response: any): response is DocumentListResponse => {
  return response && Array.isArray(response.documents)
}

const isDocumentListResponseWithData = (response: any): response is {data: DocumentListResponse} => {
  return response && response.data && Array.isArray(response.data.documents)
}

// Handle both formats in getDocuments method
const getDocuments = async (): Promise<DocumentListResponse> => {
  try {
    const response = await api.get('/documents')
    
    if (isDocumentListResponse(response)) {
      return response
    } else if (isDocumentListResponseWithData(response)) {
      return response.data
    } else {
      throw new Error('Invalid response format')
    }
  } catch (error) {
    // Enhanced error handling
    const errorContext = buildErrorContext(error as Error, { endpoint: '/documents' })
    console.error('Failed to get documents:', errorContext)
    throw new Error(`Failed to fetch documents: ${errorContext.message}`)
  }
}
```

#### 4.2 Add Proper Cleanup
Implement proper cleanup in all hooks:

```typescript
useEffect(() => {
  // Setup polling
  const interval = startPolling()
  
  return () => {
    // Cleanup polling
    if (interval) {
      clearInterval(interval)
    }
  }
}, [dependencies])
```

### Phase 5: Error Handling Standardization

#### 5.1 Create Error Handling Utilities
Create `covenantrix-desktop/src/utils/errorHandling.ts`:

```typescript
export interface ErrorContext {
  message: string
  code?: string
  endpoint?: string
  timestamp: number
  userAction?: string
}

export const buildErrorContext = (error: Error, context: Partial<ErrorContext>): ErrorContext => {
  return {
    message: error.message,
    code: (error as any).code,
    timestamp: Date.now(),
    ...context
  }
}

export const handleUploadError = (error: Error, fileId: string, retryCount: number): void => {
  const context = buildErrorContext(error, { 
    endpoint: '/upload',
    userAction: 'file_upload'
  })
  
  console.error(`Upload failed for file ${fileId}:`, context)
  
  // Implement retry logic
  if (retryCount < MAX_RETRIES) {
    // Schedule retry
  } else {
    // Mark as failed
  }
}
```

#### 5.2 Standardize Error Handling Across Components
Apply consistent error handling patterns to all upload-related components and hooks.

## Implementation Steps

### Step 1: Create Unified Types
1. Create `types/upload.ts` with comprehensive interfaces
2. Update `types/document.ts` to remove duplicates
3. Update all imports to use unified types

### Step 2: Implement Unified Hook
1. Create `useUploadUnified.ts` with all functionality
2. Implement reducer pattern for state management
3. Add proper cleanup and error handling
4. Test hook functionality

### Step 3: Update Components
1. Update `UploadScreen.tsx` to use unified hook
2. Consolidate progress components
3. Update `FileList.tsx` with enhanced features
4. Ensure proper component visibility

### Step 4: Fix API Issues
1. Update `DocumentsApi.ts` with data alignment fixes
2. Add proper error handling
3. Test API integration

### Step 5: Remove Duplicate Code
1. Remove `useUploadOptimized.ts`
2. Remove `useProgressiveUpload.ts`
3. Remove `EnhancedUploadProgress.tsx`
4. Update all imports

### Step 6: Testing and Validation
1. Test upload functionality
2. Verify component visibility
3. Test error scenarios
4. Validate performance improvements

## Expected Outcomes

### Functional Improvements
- ✅ Single, consistent upload interface
- ✅ Proper component visibility in upload tab
- ✅ Unified progress tracking
- ✅ Enhanced error handling
- ✅ Better performance with memoization
- ✅ Proper cleanup preventing memory leaks

### Code Quality Improvements
- ✅ Eliminated interface duplication
- ✅ Consolidated multiple hooks into one
- ✅ Standardized error handling
- ✅ Improved type safety
- ✅ Reduced code duplication
- ✅ Better maintainability

### User Experience Improvements
- ✅ Clear progress visualization
- ✅ Better error messages
- ✅ Consistent UI behavior
- ✅ Enhanced file management controls
- ✅ Improved upload performance

## Success Criteria

1. **Type Consistency**: All components use unified `FileItem` interface
2. **Hook Consolidation**: Single `useUploadUnified` hook replaces all others
3. **Component Visibility**: All upload components properly displayed in upload tab
4. **Error Handling**: Consistent error handling across all components
5. **Performance**: No memory leaks, proper cleanup, optimized rendering
6. **Functionality**: All upload features working correctly
7. **Code Quality**: Reduced duplication, improved maintainability

This plan addresses all critical issues identified in the review while maintaining backward compatibility and ensuring a smooth user experience.
