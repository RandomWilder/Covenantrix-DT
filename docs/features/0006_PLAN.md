# Market Research Agent Integration - Technical Plan

## Overview

Implementation of the Market Research Agent into the Covenantrix AI Assistant chat interface, enabling conversational rental property analysis with global market data. The agent will query processed documents via LightRAG, fetch real-time market data from external APIs (Numbeo, OpenStreetMap, Eurostat), and provide contextualized rent recommendations with confidence scoring.

## Architecture Components

### Domain Layer (Business Logic)

**Files to Create/Modify:**
- `backend/domain/agents/market_research.py` - **MODIFY** existing agent implementation
- `backend/domain/agents/base.py` - **MODIFY** interfaces for data access
- `backend/domain/agents/models.py` - **MODIFY** add market research specific models

**Key Changes:**
1. **Enhance MarketResearchAgent** - Implement real external data integration instead of mock data
2. **Extend IAgentDataAccess interface** - Add methods for document analytics and RAG queries
3. **Extend IExternalDataService interface** - Add market data fetching with geographic granularity
4. **Add market-specific models** - PropertyInfo, MarketData, RentRecommendation models

### Infrastructure Layer (External Integrations)

**Files to Create:**
- `backend/infrastructure/external/numbeo_api.py` - Numbeo API integration
- `backend/infrastructure/external/geocoding_service.py` - Enhanced geocoding with OSM Nominatim
- `backend/infrastructure/external/eurostat_api.py` - Eurostat API integration
- `backend/infrastructure/external/market_data_service.py` - Unified market data service

**Files to Modify:**
- `backend/infrastructure/external/market_data.py` - **REPLACE** mock implementation with real API calls
- `backend/infrastructure/external/geocoding.py` - **ENHANCE** with OSM Nominatim integration

**Key Implementation Details:**
1. **Numbeo API Integration** - Real estate data for 500+ global cities
2. **OpenStreetMap Nominatim** - Free geocoding and address validation
3. **Eurostat API** - EU housing statistics for European properties
4. **Fallback Chain** - Primary → Secondary → Fallback with confidence scoring
5. **Street-level Granularity** - Use city + street name for neighborhood-specific accuracy

### Infrastructure Layer (Data Access)

**Files to Create:**
- `backend/infrastructure/ai/agent_data_access.py` - Implements IAgentDataAccess
- `backend/infrastructure/external/external_data_service.py` - Implements IExternalDataService

**Key Implementation:**
1. **AgentDataAccessService** - Wraps RAGEngine and DocumentService for agent queries
2. **ExternalDataService** - Orchestrates multiple external APIs with fallback logic
3. **Geographic Intelligence** - Address normalization and multi-level fallback (city → region → country)

### API Layer (Integration)

**Files to Modify:**
- `backend/api/routes/chat.py` - **ENHANCE** agent routing in chat service
- `backend/core/dependencies.py` - **ADD** external data service dependencies
- `backend/core/config.py` - **ADD** external API configuration

**Key Changes:**
1. **Enhanced Chat Routing** - Improved agent selection and task routing
2. **Dependency Injection** - Wire external data services into agent system
3. **Configuration Management** - Add external API keys and settings

## Implementation Phases

### Phase 1: Core Infrastructure (Week 1)

**External API Services:**
1. **Create Numbeo API Service** (`backend/infrastructure/external/numbeo_api.py`)
   - Implement async HTTP client with retry logic
   - Add rate limiting (100 req/day free tier)
   - Handle API response parsing and error handling
   - Support city and property type filtering

2. **Create Enhanced Geocoding Service** (`backend/infrastructure/external/geocoding_service.py`)
   - Integrate OpenStreetMap Nominatim API
   - Implement address normalization and validation
   - Add caching with LRU eviction
   - Support reverse geocoding for coordinates

3. **Create Eurostat API Service** (`backend/infrastructure/external/eurostat_api.py`)
   - Implement EU housing statistics API client
   - Add data filtering by country/region
   - Handle API response parsing for rent statistics
   - Support multiple property types

**Data Access Layer:**
4. **Create Agent Data Access Service** (`backend/infrastructure/ai/agent_data_access.py`)
   - Implement IAgentDataAccess interface
   - Wrap existing RAGEngine for document queries
   - Add document analytics extraction methods
   - Support natural language querying of processed documents

5. **Create External Data Service** (`backend/infrastructure/external/external_data_service.py`)
   - Implement IExternalDataService interface
   - Orchestrate multiple external APIs
   - Implement fallback chain with confidence scoring
   - Add street-level granularity for market data

### Phase 2: Geographic Intelligence (Week 2)

**Enhanced Location Processing:**
1. **Address Normalization** - Standardize addresses across different formats
2. **Multi-level Fallback** - City → Region → Country data fetching
3. **Location-based Data Fetching** - Use geographic coordinates for precise market data
4. **Geographic Validation** - Validate addresses against real locations

**Market Data Service Integration:**
5. **Unified Market Data Service** (`backend/infrastructure/external/market_data_service.py`)
   - Combine Numbeo, OSM, and Eurostat data
   - Implement data quality scoring
   - Add market trend analysis
   - Support comparable property analysis

### Phase 3: Multi-source Strategy (Week 3)

**Data Source Integration:**
1. **Source Priority Chain** - Numbeo → Eurostat → Fallback
2. **Data Quality Validation** - Cross-reference multiple sources
3. **Confidence Scoring** - Rate recommendation reliability (0.5-0.9 range)
4. **Market Intelligence** - Cross-reference against 500+ cities worldwide

**Enhanced Agent Logic:**
5. **Update MarketResearchAgent** - Replace mock data with real API integration
6. **Improve Recommendation Algorithm** - Factor in property size, location, bedrooms, market trends
7. **Add Market Factors Analysis** - Include rent growth rate, occupancy rate, comparable properties

### Phase 4: Integration & Testing (Week 4)

**System Integration:**
1. **Wire Dependencies** - Update dependency injection in `core/dependencies.py`
2. **Add Configuration** - External API keys in `core/config.py`
3. **Update Chat Service** - Enhanced agent routing in chat interface
4. **Add Error Handling** - Graceful degradation when external services unavailable

**Testing & Validation:**
5. **API Integration Testing** - Test with real external APIs
6. **Geographic Testing** - Validate address geocoding and market data fetching
7. **Agent Testing** - End-to-end agent execution with real data
8. **Performance Testing** - Ensure response times under 10 seconds

## Key Algorithms

### Market Data Fetching Algorithm
```
1. Normalize input address using OSM Nominatim
2. Extract city and street name for granular search
3. Query Numbeo API with city + property details
4. If no data, fallback to Eurostat for EU properties
5. If still no data, use city-wide averages
6. Calculate confidence score based on data availability
7. Return market data with source attribution
```

### Rent Recommendation Algorithm
```
1. Extract property details from documents (size, bedrooms, location)
2. Fetch market data using geographic granularity
3. Calculate base recommendation from market average
4. Adjust for property size (size_sqm > 100: +10%, < 60: -10%)
5. Adjust for bedroom count and amenities
6. Calculate confidence: base(0.5) + data_quality(0.3) + location(0.1) + size(0.1)
7. Generate reasoning with market factors
```

### Geographic Intelligence Algorithm
```
1. Parse address into components (street, city, country)
2. Geocode using OSM Nominatim for coordinates
3. Validate address against real locations
4. Try street-level data first (city + street)
5. Fallback to city-level data if street unavailable
6. Fallback to region/country data if city unavailable
7. Return best available data with confidence score
```

## Configuration Requirements

### Environment Variables
```bash
# External API Configuration
NUMBEO_API_KEY=your_numbeo_api_key
OSM_NOMINATIM_BASE_URL=https://nominatim.openstreetmap.org
EUROSTAT_API_BASE_URL=https://ec.europa.eu/eurostat/api
GOOGLE_MAPS_API_KEY=your_google_maps_key  # Optional for enhanced geocoding
```

### API Rate Limits
- **Numbeo**: 100 requests/day (free tier)
- **OpenStreetMap Nominatim**: 1 request/second (free)
- **Eurostat**: Unlimited (free)
- **Google Maps**: 40,000 requests/month (if used)

## Error Handling Strategy

### Graceful Degradation
1. **Primary Source Failure** - Fallback to secondary source
2. **All Sources Failure** - Return cached data or generic recommendations
3. **Partial Data** - Use available data with reduced confidence
4. **Network Timeout** - Retry with exponential backoff

### Error Types
- `ExternalAPIError` - API service unavailable
- `GeocodingError` - Address geocoding failed
- `MarketDataError` - Market data fetching failed
- `AgentExecutionError` - Agent task execution failed

## Performance Considerations

### Caching Strategy
- **Geocoding Cache** - LRU cache for address coordinates (1000 entries)
- **Market Data Cache** - TTL cache for market data (1 hour)
- **Agent Results Cache** - Cache agent responses (30 minutes)

### Response Time Targets
- **Geocoding**: < 2 seconds
- **Market Data Fetching**: < 5 seconds
- **Agent Execution**: < 10 seconds total
- **Chat Response**: < 15 seconds end-to-end

## Security Considerations

### API Key Management
- Store external API keys in environment variables
- Use existing `APIKeyManager` for secure storage
- Implement key rotation for production
- Add API key validation in configuration

### Data Privacy
- No personal data sent to external APIs
- Only property addresses and characteristics
- Cache market data locally to reduce API calls
- Implement data retention policies

## Monitoring & Logging

### Key Metrics
- External API response times
- Agent execution success rates
- Market data accuracy scores
- Geographic coverage statistics

### Logging Strategy
- Log all external API calls with response times
- Track agent execution progress and results
- Monitor API rate limit usage
- Log geographic data quality metrics

## Dependencies

### New Python Packages
```txt
httpx>=0.24.0          # Async HTTP client
aiohttp>=3.8.0         # Alternative HTTP client
geopy>=2.3.0           # Geocoding utilities
python-dateutil>=2.8.0 # Date parsing
```

### External Services
- **Numbeo API** - Global real estate data
- **OpenStreetMap Nominatim** - Free geocoding
- **Eurostat API** - EU housing statistics
- **Google Maps API** - Optional enhanced geocoding

## Success Criteria

### Functional Requirements
- Agent successfully extracts property details from documents
- Market data fetched from real external APIs (not mock data)
- Rent recommendations generated with confidence scoring
- Geographic intelligence provides street-level accuracy
- Chat interface integrates agent seamlessly

### Performance Requirements
- Agent execution completes within 10 seconds
- External API calls complete within 5 seconds
- System handles API failures gracefully
- Geographic data covers 500+ global cities

### Quality Requirements
- Confidence scores range from 0.5 to 0.9
- Market data sourced from official APIs
- No web scraping or fragile data sources
- Extensible architecture for additional data sources
