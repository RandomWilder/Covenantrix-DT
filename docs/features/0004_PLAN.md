# Settings System - Technical Plan

## Overview
Implement a comprehensive Settings system that allows users to manage API keys, configure RAG behavior, set language preferences, and customize UI appearance through an intuitive interface. This moves the application from "developer tool" to "production-ready desktop application" by eliminating the need for `.env` file editing.

## Current State Analysis
- **Backend**: Uses Pydantic Settings with environment variables from `.env` files
- **Frontend**: Basic SettingsContext exists but not fully implemented
- **Storage**: No persistent user settings storage beyond environment variables
- **Security**: APIKeyManager exists for encryption but not integrated with user settings
- **IPC**: Basic settings IPC handlers exist in preload.js but not implemented in main process

## Architecture Changes

### Three-Layer Storage Strategy
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend (React)       â”‚  â† User interacts with Settings UI
â”‚   - SettingsContext      â”‚  â† Cached in memory for fast access
â”‚   - react-i18next (i18n) â”‚  â† Language switching
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ IPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Electron Main          â”‚  â† Secure storage layer
â”‚   - electron-store       â”‚  â† Encrypted API keys
â”‚   - Machine-keyed crypto â”‚  â† Derived encryption key
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ HTTP API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Python Backend         â”‚  â† Settings validation & application
â”‚   - Pydantic models      â”‚  â† Schema validation
â”‚   - ~/.covenantrix/      â”‚  â† File-based persistence
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Implementation Phases

### Phase 1: Data Layer (Backend + Storage)

#### Backend Changes
**Files to modify:**
- `backend/api/schemas/settings.py` (new)
- `backend/api/routes/settings.py` (new)
- `backend/core/config.py` (extend)
- `backend/core/security.py` (enhance APIKeyManager)
- `backend/infrastructure/storage/user_settings_storage.py` (new)

**Key changes:**
1. **Create Settings Schema** (`backend/api/schemas/settings.py`):
   ```python
   class UserSettings(BaseModel):
       api_keys: ApiKeySettings
       rag: RAGSettings  
       language: LanguageSettings
       ui: UISettings
       privacy: PrivacySettings
   ```

2. **Create Settings API Routes** (`backend/api/routes/settings.py`):
   - `GET /settings` - Retrieve current settings
   - `POST /settings` - Update settings
   - `POST /settings/api-keys/validate` - Validate API keys
   - `POST /settings/apply` - Apply settings to RAG engine

3. **Enhance Security Module** (`backend/core/security.py`):
   - Add machine-derived encryption key generation
   - Extend APIKeyManager for multiple key types
   - Add secure key validation methods

4. **Create User Settings Storage** (`backend/infrastructure/storage/user_settings_storage.py`):
   - JSON-based storage in `~/.covenantrix/user_settings.json`
   - Schema validation on load/save
   - Migration support for settings versioning

#### Electron Changes
**Files to modify:**
- `covenantrix-desktop/electron/main.js` (extend)
- `covenantrix-desktop/electron/ipc-handlers.js` (extend)
- `covenantrix-desktop/package.json` (add dependencies)

**Key changes:**
1. **Add Dependencies**:
   ```json
   "electron-store": "^8.1.0",
   "node-machine-id": "^1.1.12"
   ```

2. **Implement Secure Storage** in main.js:
   - Initialize electron-store with encryption
   - Create machine-derived encryption key
   - Handle API key encryption/decryption

3. **Extend IPC Handlers** in ipc-handlers.js:
   - `get-settings` - Retrieve settings from secure store
   - `update-settings` - Save settings to secure store
   - `validate-api-keys` - Test API keys before saving
   - `apply-settings` - Forward settings to backend

### Phase 2: Core UI (Settings Modal)

#### Frontend Changes
**Files to create/modify:**
- `covenantrix-desktop/src/features/settings/SettingsModal.tsx` (new)
- `covenantrix-desktop/src/features/settings/ApiKeysTab.tsx` (new)
- `covenantrix-desktop/src/features/settings/LanguageTab.tsx` (new)
- `covenantrix-desktop/src/features/settings/RAGTab.tsx` (new)
- `covenantrix-desktop/src/features/settings/AppearanceTab.tsx` (new)
- `covenantrix-desktop/src/contexts/SettingsContext.tsx` (implement)
- `covenantrix-desktop/src/types/settings.ts` (extend)
- `covenantrix-desktop/package.json` (add i18n dependencies)

**Key changes:**
1. **Add i18n Dependencies**:
   ```json
   "react-i18next": "^13.5.0",
   "i18next": "^23.7.6"
   ```

2. **Implement SettingsContext** with:
   - Settings state management
   - API key validation
   - Settings persistence via IPC
   - Real-time settings updates

3. **Create Settings Modal** with tabbed interface:
   - **API Keys Tab**: Mode selection (Default/Custom), key input, validation
   - **Language Tab**: Preferred language, agent language, UI language
   - **RAG Configuration Tab**: Search mode, top-K, reranking, OCR
   - **Appearance Tab**: Theme, compact mode, font size

4. **Extend Type Definitions** (`src/types/settings.ts`):
   ```typescript
   interface UserSettings {
     apiKeys: ApiKeySettings;
     rag: RAGSettings;
     language: LanguageSettings;
     ui: UISettings;
     privacy: PrivacySettings;
   }
   ```

### Phase 3: Integration (Wiring)

#### Settings Application Logic
**Files to modify:**
- `backend/infrastructure/ai/rag_engine.py` (extend)
- `backend/domain/integrations/ocr.py` (extend)
- `backend/main.py` (extend)
- `covenantrix-desktop/src/components/layout/Header.tsx` (add settings button)

**Key changes:**
1. **RAG Engine Integration**:
   - Apply language settings to prompts
   - Apply search mode and top-K settings
   - Apply reranking settings based on Cohere key availability

2. **OCR Integration**:
   - Toggle Google Vision usage based on settings
   - Apply language preferences to OCR processing

3. **Backend Settings Application**:
   - Load user settings on startup
   - Apply settings to RAG engine initialization
   - Handle settings changes at runtime

4. **Frontend Integration**:
   - Add settings gear icon to Header component
   - Implement settings modal trigger
   - Add settings change notifications

### Phase 4: Polish (UX Refinements)

#### User Experience Enhancements
**Files to create/modify:**
- `covenantrix-desktop/src/features/onboarding/SettingsSetup.tsx` (new)
- `covenantrix-desktop/src/hooks/useSettings.ts` (new)
- `covenantrix-desktop/src/utils/settings.ts` (new)
- `covenantrix-desktop/src/locales/` (new directory)

**Key changes:**
1. **First-Run Onboarding**:
   - Auto-open settings modal on first launch
   - Guide users through API key setup
   - Set up language preferences

2. **Settings Validation**:
   - Real-time API key validation
   - Settings change confirmation
   - Error handling and user feedback

3. **Internationalization Setup**:
   - Configure react-i18next
   - Add English and Spanish translations
   - Implement language switching

4. **Settings Persistence**:
   - Automatic settings save
   - Settings backup/restore
   - Settings migration handling

## Data Flow

### Settings Update Flow
1. User modifies settings in React UI
2. Frontend sends to Electron via IPC (`update-settings`)
3. Electron encrypts sensitive data and saves to secure store
4. Electron forwards to Python backend via HTTP API
5. Backend validates settings and persists to `~/.covenantrix/user_settings.json`
6. Backend applies settings to RAG engine and other services
7. Frontend receives confirmation and updates UI

### Settings Load Flow
1. App starts â†’ Electron reads from secure store
2. Electron sends settings to frontend via IPC response
3. React SettingsContext hydrates from Electron data
4. Backend loads from `user_settings.json` on API requests
5. Settings applied to RAG engine and services

## Security Model

### Encryption Strategy
- **API Keys**: AES-256 encryption via electron-store with machine-derived key
- **Non-sensitive Settings**: Plain JSON storage
- **Key Derivation**: Machine ID-based key generation (stable across reboots)
- **Validation**: All API keys validated before storage via test API calls

### Data Isolation
- **Keys never logged**: Sanitized from error messages and logs
- **No network transmission**: All settings stored locally only
- **Secure revocation**: Secure store cleared on app uninstall

## Settings Schema

### API Key Settings
```typescript
interface ApiKeySettings {
  mode: 'default' | 'custom';
  openai?: string;        // Only if mode === 'custom'
  cohere?: string;        // Only if mode === 'custom'  
  googleVision?: string;  // Only if mode === 'custom'
}
```

### RAG Settings
```typescript
interface RAGSettings {
  searchMode: 'naive' | 'local' | 'global' | 'hybrid';
  topK: number;           // 1-20
  useReranking: boolean;
  enableOCR: boolean;
}
```

### Language Settings
```typescript
interface LanguageSettings {
  preferred: 'en' | 'es' | 'fr' | 'he' | 'de';
  agentLanguage: 'auto' | 'en' | 'es' | 'fr' | 'he' | 'de';
  uiLanguage: 'auto' | 'en' | 'es';
}
```

### UI Settings
```typescript
interface UISettings {
  theme: 'light' | 'dark' | 'system';
  compactMode: boolean;
  fontSize: 'small' | 'medium' | 'large';
}
```

### Privacy Settings
```typescript
interface PrivacySettings {
  enableTelemetry: boolean;
  enableCloudBackup: boolean;  // future
  retainHistory: boolean;
}
```

## Migration Strategy

### From .env to Settings System
1. **Backward Compatibility**: Keep `.env` as fallback during transition
2. **Settings Migration**: Auto-migrate existing `.env` values to user settings
3. **Gradual Rollout**: Settings system takes precedence over `.env` when available
4. **Cleanup**: Remove `.env` dependency after successful migration

### Settings Versioning
- **Version 1.0**: Initial settings schema
- **Migration Support**: Handle schema changes gracefully
- **Backward Compatibility**: Support loading older settings versions

## Testing Strategy

### Unit Tests
- Settings schema validation
- API key encryption/decryption
- Settings persistence
- Settings application to services

### Integration Tests
- End-to-end settings flow
- IPC communication
- Backend settings API
- Settings migration

### User Acceptance Tests
- First-time user onboarding
- Settings modal functionality
- Language switching
- API key validation

## Success Criteria

### Functional Requirements
- âœ… 100% of users can configure API keys without touching `.env`
- âœ… Settings persist across app restarts with 0 data loss
- âœ… API key validation succeeds for valid keys, fails gracefully for invalid
- âœ… Language switching applies within 1 second
- âœ… Encrypted API keys cannot be extracted by examining local files

### Performance Requirements
- â±ï¸ Settings modal loads in <500ms
- â±ï¸ API key validation completes in <5 seconds
- â±ï¸ Language switch applies without page reload

### Security Requirements
- ğŸ”’ Zero API keys logged in application logs
- ğŸ”’ Zero API keys transmitted over network (except to provider for validation)
- ğŸ”’ Machine-bound encryption prevents key extraction

## Dependencies

### New Dependencies
- **Frontend**: `react-i18next`, `i18next` (localization)
- **Electron**: `electron-store`, `node-machine-id` (encrypted storage)
- **Backend**: No new dependencies (use existing FastAPI, Pydantic)

### Existing Systems Integration
- **LightRAG**: Apply settings to RAG engine (search mode, top-k, reranking)
- **Document Processing**: OCR toggle controls Google Vision usage
- **Auth System**: Settings tied to local user profile

## Risk Mitigation

| Risk | Impact | Mitigation |
|------|--------|------------|
| API key leakage | Critical | Encrypt at rest, sanitize logs, no network transmission |
| Settings corruption | High | Validate JSON schema on load, fallback to defaults |
| Migration from .env fails | Medium | Keep .env as fallback during transition period |
| i18n adds complexity | Medium | Start with 2 languages only, infrastructure for scaling |
| Encryption key lost | Low | Machine-derived (not user password), stable across reboots |

## Out of Scope (MVP)

- âŒ Cloud backup/sync of settings
- âŒ Settings import/export UI (manual JSON export acceptable)
- âŒ Full UI localization beyond EN/ES (infrastructure in place for future)
- âŒ Settings versioning/migration UI (handle via code)
- âŒ Multi-user profiles on same machine
- âŒ Admin/organization-level settings
- âŒ Settings presets (e.g., "Power User", "Beginner")
