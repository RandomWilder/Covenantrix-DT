# Enhanced Usage Tracking & Tier Management System

## Context
Enhance the usage_tracking.json storage structure and UsageTracker class to support comprehensive tier licensing enforcement, audit trails, and analytics capabilities. The system must track tier transitions, enforcement violations, feature usage, and provide data for upgrade signals while maintaining the existing query/document tracking functionality.

## Phase 1: Data Layer & Storage Structure (Core Foundation)

### Goal
Enhance usage_tracking.json schema and update UsageTracker class to support new data structures

### 1.1 Enhanced JSON Schema Definition
**File to modify:** `backend/infrastructure/storage/usage_tracker.py`

**Changes to `_initialize_storage()` method:**
Add new top-level sections to the default_data structure:
- `license` section with `current_tier`, `tier_history[]`, and `validation` sub-object
- `usage.enforcement` section with `violations[]` and `grace_periods` sub-object  
- `usage.features` section tracking feature-specific usage flags
- `analytics` section with `sessions[]` and `tier_upgrade_signals` sub-object
- `metadata` section with `last_updated`, `schema_version`, etc.

**Enhanced query history structure:**
- Add `session_id` field (string)
- Add `query_type` field (string: semantic_search, qa, chat, etc.)
- Add `success` field (boolean)
- Add `tokens_used` field (integer, optional)

**Enhanced document upload history:**
- Add `tier_at_upload` field (string)
- Add `format` field (string: pdf, docx, txt, etc.)

**Add new tracking fields to period tracking:**
- Add `period_start` timestamp to monthly/daily objects
- Add `tier_at_period_start` to monthly/daily objects

### 1.2 License Section Management
**File to modify:** `backend/infrastructure/storage/usage_tracker.py`

**New methods to implement:**
```python
async def record_tier_change(
    old_tier: str,
    new_tier: str, 
    reason: str,
    license_key: Optional[str] = None,
    expiration_date: Optional[str] = None
) -> None
```
- Append entry to `license.tier_history[]`
- Update `license.current_tier`
- Include start_date, end_date (previous entry), reason, license_key, expiration_date

```python
async def update_validation_status(
    last_validated: str,
    next_validation: str,
    last_online_check: str
) -> None
```
- Update `license.validation` sub-object fields
- Used for online license validation tracking

```python
async def get_license_history() -> List[Dict[str, Any]]
```
- Return complete tier history sorted by date
- Include tier, dates, reason, license_key

### 1.3 Enforcement & Violations Tracking
**File to modify:** `backend/infrastructure/storage/usage_tracker.py`

**New methods to implement:**
```python
async def record_violation(
    violation_type: str,  # "daily_query_limit", "monthly_query_limit", "document_limit", "file_size_limit"
    tier: str,
    limit: int,
    attempted: int,
    action_taken: str,  # "blocked", "warned", "grace_allowed"
    grace_used: bool = False
) -> None
```
- Append to `usage.enforcement.violations[]`
- Include timestamp, type, tier, limit, attempted, action_taken, grace_used

```python
async def update_grace_periods(
    query_overage_remaining: int,
    last_grace_reset: str
) -> None
```
- Update `usage.enforcement.grace_periods` fields
- Track remaining grace allowances

```python
async def get_violation_history(
    violation_type: Optional[str] = None,
    days: int = 30
) -> List[Dict[str, Any]]
```
- Return violations filtered by type and time range
- For analytics and support

### 1.4 Feature Usage Tracking
**File to modify:** `backend/infrastructure/storage/usage_tracker.py`

**New methods to implement:**
```python
async def record_feature_usage(
    feature_name: str  # "advanced_search", "export", "api_access", etc.
) -> None
```
- Update `usage.features.<feature_name>_used` to true
- Update `usage.features.last_feature_audit` timestamp

```python
async def get_feature_usage_stats() -> Dict[str, bool]
```
- Return which tier-specific features have been used
- For upgrade opportunity identification

### 1.5 Session-Based Analytics
**File to modify:** `backend/infrastructure/storage/usage_tracker.py`

**New methods to implement:**
```python
async def start_session(
    session_id: str,
    tier: str
) -> None
```
- Append new session to `analytics.sessions[]`
- Include session_id, start_time, tier, queries_count=0

```python
async def end_session(
    session_id: str
) -> None
```
- Update session end_time in `analytics.sessions[]`
- Calculate session duration

```python
async def increment_session_queries(
    session_id: str
) -> None
```
- Increment queries_count for active session

```python
async def get_session_analytics(
    days: int = 30
) -> Dict[str, Any]
```
- Return average queries per session, session duration, etc.
- For UX improvement insights

### 1.6 Upgrade Signals & Analytics
**File to modify:** `backend/infrastructure/storage/usage_tracker.py`

**New methods to implement:**
```python
async def calculate_upgrade_signals() -> Dict[str, Any]
```
- Calculate `tier_upgrade_signals.limit_hits_last_30_days`
- Calculate `tier_upgrade_signals.avg_queries_per_day`
- Calculate `tier_upgrade_signals.trending_up` (bool)
- Return signals dict for marketing automation

```python
async def get_complete_analytics() -> Dict[str, Any]
```
- Aggregate all analytics data
- Include usage stats, violation counts, feature usage, upgrade signals
- For admin dashboard/reporting

### 1.7 Enhanced Query Recording
**File to modify:** `backend/infrastructure/storage/usage_tracker.py`

**Modify existing `record_query()` method:**
- Accept additional parameters: session_id, query_type, success, tokens_used
- Update history_entry structure to include new fields
- Maintain backward compatibility with existing calls

### 1.8 Schema Migration Support
**File to modify:** `backend/infrastructure/storage/usage_tracker.py`

**New method to implement:**
```python
def _migrate_schema(self, data: Dict[str, Any]) -> Dict[str, Any]
```
- Check `data["version"]` and migrate if needed
- Add missing sections (license, enforcement, features, analytics, metadata)
- Preserve existing data during migration
- Update version to "1.1"
- Called in `_load_data()` if version mismatch detected

## Phase 2: Integration with Subscription Service (Business Logic)

### Goal
Integrate enhanced usage tracking with subscription service and enforce tier-based limits

### 2.1 Subscription Service Integration
**File to modify:** `backend/domain/subscription/service.py`

**Enhance `activate_license()` method:**
- Call `usage_tracker.record_tier_change()` after successful activation
- Pass old_tier, new_tier, reason="license_activation", license_key, expiration_date

**Enhance `check_tier_expiry()` method:**
- Call `usage_tracker.record_tier_change()` when tier changes due to expiry
- Pass reason="trial_expired" or "grace_period_expired"

**New method to implement:**
```python
async def get_upgrade_recommendations() -> Dict[str, Any]
```
- Call `usage_tracker.calculate_upgrade_signals()`
- Analyze violation history
- Return personalized upgrade recommendations

### 2.2 Query Limit Enforcement Enhancement
**File to modify:** `backend/domain/subscription/service.py`

**Enhance `check_query_allowed()` method:**
- On limit exceeded, call `usage_tracker.record_violation()`
- Include violation_type, tier, limit, attempted, action_taken="blocked"
- Track grace period usage if applicable

**Files to modify:** `backend/api/routes/chat.py`, `backend/api/routes/queries.py`

**Pass session context to query recording:**
- Extract or generate session_id from request context
- Pass query_type based on endpoint
- Record success/failure status
- Track tokens_used if available from LLM response

### 2.3 Document Upload Enforcement Enhancement
**File to modify:** `backend/domain/subscription/service.py`

**Enhance `check_upload_allowed()` method:**
- On limit exceeded, call `usage_tracker.record_violation()`
- Record file_size_limit violations separately from document_limit violations

**File to modify:** `backend/api/routes/documents.py`

**Pass tier context to document recording:**
- Include tier_at_upload in `record_document_upload()` call
- Record document format from file extension

### 2.4 Feature Usage Integration
**Files to modify:** `backend/api/routes/documents.py` (export endpoint), `backend/api/routes/chat.py` (advanced features), other routes with tier-specific features

**Add feature tracking calls:**
- Call `usage_tracker.record_feature_usage()` when tier-specific features are used
- Track: advanced_search, export, api_access, etc.

### 2.5 Session Management Integration
**File to modify:** `backend/api/routes/chat.py`

**Implement session tracking:**
- Generate or extract session_id from request headers/cookies
- Call `usage_tracker.start_session()` on first query in session
- Call `usage_tracker.increment_session_queries()` for each query
- Call `usage_tracker.end_session()` on session timeout/close

### 2.6 New API Endpoints
**File to modify:** `backend/api/routes/subscription.py`

**New endpoints to add:**
```python
@router.get("/analytics")
async def get_subscription_analytics()
```
- Return `usage_tracker.get_complete_analytics()`
- Include all analytics, violation history, upgrade signals

```python
@router.get("/license-history")
async def get_license_history()
```
- Return `usage_tracker.get_license_history()`
- Show complete tier transition audit trail

```python
@router.get("/upgrade-recommendations")
async def get_upgrade_recommendations()
```
- Call `subscription_service.get_upgrade_recommendations()`
- Return personalized upgrade suggestions

## Phase 3: Frontend Integration & User Experience (Parallel to Phase 2)

### Goal
Display enhanced analytics and enforcement data in UI, implement grace periods UX

### 3.1 TypeScript Type Definitions
**File to modify:** `covenantrix-desktop/src/types/subscription.ts`

**Add new interfaces:**
```typescript
export interface TierHistoryEntry {
  tier: SubscriptionTier;
  start_date: string;
  end_date: string | null;
  reason: string;
  license_key?: string;
  expiration_date?: string;
}

export interface ViolationRecord {
  timestamp: string;
  type: string;
  tier: string;
  limit: number;
  attempted: number;
  action_taken: string;
  grace_used: boolean;
}

export interface FeatureUsageStats {
  advanced_search_used: boolean;
  export_used: boolean;
  api_access_used: boolean;
  last_feature_audit: string;
}

export interface UpgradeSignals {
  limit_hits_last_30_days: number;
  avg_queries_per_day: number;
  trending_up: boolean;
}

export interface SubscriptionAnalytics {
  tier_history: TierHistoryEntry[];
  violations: ViolationRecord[];
  feature_usage: FeatureUsageStats;
  upgrade_signals: UpgradeSignals;
  sessions_last_30_days: number;
  avg_queries_per_session: number;
}
```

### 3.2 Subscription Context Enhancement
**File to modify:** `covenantrix-desktop/src/contexts/SubscriptionContext.tsx`

**Add new context methods:**
```typescript
getAnalytics: () => Promise<SubscriptionAnalytics>;
getLicenseHistory: () => Promise<TierHistoryEntry[]>;
getUpgradeRecommendations: () => Promise<string[]>;
```
- Implement methods using IPC calls to new backend endpoints

### 3.3 Analytics Dashboard Component
**File to create:** `covenantrix-desktop/src/features/subscription/AnalyticsDashboard.tsx`

**Component features:**
- Display tier history timeline
- Show violation chart/graph
- Display feature usage matrix
- Show upgrade signals with visual indicators
- Session statistics

### 3.4 Enhanced Subscription Tab
**File to modify:** `covenantrix-desktop/src/features/subscription/SubscriptionTab.tsx`

**Add new sections:**
- Tier history accordion/timeline
- Violation history table with filters
- Feature usage checklist
- Upgrade recommendations panel (if signals indicate opportunity)

### 3.5 Grace Period UI Enhancement
**File to modify:** `covenantrix-desktop/src/features/subscription/GracePeriodWarning.tsx`

**Show grace period details:**
- Display remaining grace allowances from usage_tracker
- Show recent violations that triggered grace
- Provide upgrade CTA when grace is running low

### 3.6 Violation Notification
**File to create:** `covenantrix-desktop/src/features/subscription/ViolationNotification.tsx`

**Show inline notifications when limits are hit:**
- Display when query/document limit exceeded
- Show count of recent violations
- Offer upgrade option or explain reset timing

### 3.7 IPC Handler Updates
**File to modify:** `covenantrix-desktop/electron/ipc-handlers.js`

**Add new handlers:**
```javascript
ipcMain.handle('subscription:get-analytics', async () => { ... });
ipcMain.handle('subscription:get-license-history', async () => { ... });
ipcMain.handle('subscription:get-upgrade-recommendations', async () => { ... });
```
- Implement handlers to call new backend endpoints via HTTP

### 3.8 Preload API Updates
**File to modify:** `covenantrix-desktop/electron/preload.js`

**Expose new methods in contextBridge.exposeInMainWorld:**
```javascript
subscription: {
  ...existing methods,
  getAnalytics: () => ipcRenderer.invoke('subscription:get-analytics'),
  getLicenseHistory: () => ipcRenderer.invoke('subscription:get-license-history'),
  getUpgradeRecommendations: () => ipcRenderer.invoke('subscription:get-upgrade-recommendations')
}
```

## Key Algorithms

### Tier Transition Recording Algorithm
1. Load current usage_tracking.json data
2. Get current tier from license.current_tier
3. Find last entry in license.tier_history[]
4. Set end_date on last entry to current timestamp
5. Append new entry with new_tier, start_date=now, reason, etc.
6. Update license.current_tier to new_tier
7. Save data back to storage

### Violation Detection & Grace Period Algorithm
1. Check if query/upload would exceed limit
2. If limit exceeded:
   - Check grace_periods.query_overage_remaining > 0
   - If grace available:
     - Decrement grace_periods.query_overage_remaining
     - Record violation with action_taken="grace_allowed", grace_used=true
     - Allow operation
   - Else:
     - Record violation with action_taken="blocked", grace_used=false
     - Reject operation with 429/402
3. Save updated data

### Upgrade Signal Calculation Algorithm
1. Load violations from last 30 days
2. Count limit_hits = violations where action_taken="blocked"
3. Load query history from last 30 days
4. Calculate avg_queries_per_day = total_queries / 30
5. Compare current 7-day average to previous 7-day average
6. Set trending_up = true if current > previous
7. Return signals dict

### Session Analytics Algorithm
1. Load all sessions from last 30 days
2. Filter complete sessions (have end_time)
3. Calculate:
   - Total sessions count
   - Average queries per session = sum(queries_count) / count
   - Average session duration = sum(end_time - start_time) / count
4. Return analytics dict

## Files Summary

### Phase 1 - Files Modified (1):
- `backend/infrastructure/storage/usage_tracker.py` - Add 15+ new methods, enhance existing methods, implement schema migration

### Phase 2 - Files Modified (5):
- `backend/domain/subscription/service.py` - Integrate tier change recording, add upgrade recommendations
- `backend/api/routes/subscription.py` - Add 3 new analytics endpoints
- `backend/api/routes/chat.py` - Add session tracking, enhanced query recording
- `backend/api/routes/queries.py` - Add session tracking, enhanced query recording
- `backend/api/routes/documents.py` - Enhanced document recording with tier/format

### Phase 3 - Files Modified (4):
- `covenantrix-desktop/src/types/subscription.ts` - Add 5 new interfaces
- `covenantrix-desktop/src/contexts/SubscriptionContext.tsx` - Add 3 new methods
- `covenantrix-desktop/src/features/subscription/SubscriptionTab.tsx` - Add analytics sections
- `covenantrix-desktop/src/features/subscription/GracePeriodWarning.tsx` - Show grace details
- `covenantrix-desktop/electron/ipc-handlers.js` - Add 3 new handlers
- `covenantrix-desktop/electron/preload.js` - Expose 3 new methods

### Phase 3 - Files Created (2):
- `covenantrix-desktop/src/features/subscription/AnalyticsDashboard.tsx` - New analytics UI
- `covenantrix-desktop/src/features/subscription/ViolationNotification.tsx` - Limit notification UI

## Testing Strategy

### Phase 1 Testing:
- Verify usage_tracking.json initializes with new schema structure
- Test schema migration from v1.0 to v1.1 on existing files
- Verify all new methods can read/write data correctly
- Test tier change recording with various scenarios
- Test violation recording with different violation types
- Verify session tracking persists across application restarts

### Phase 2 Testing:
- Activate license and verify tier_history is populated
- Hit query limit and verify violation is recorded
- Test grace period allows queries and decrements counter
- Upload document and verify tier_at_upload is stored
- Use tier-specific feature and verify feature_usage flag updates
- Call new analytics endpoints and verify complete data returned

### Phase 3 Testing:
- Open SubscriptionTab and verify analytics display correctly
- Hit limit and verify ViolationNotification appears
- Check grace period warning shows remaining allowances
- Verify tier history timeline displays chronologically
- Test upgrade recommendations appear when signals indicate opportunity
- Verify all IPC handlers respond with correct data structure

## Critical Notes

- **Backward Compatibility:** Schema migration in Phase 1 ensures existing usage_tracking.json files work without data loss
- **Atomic Operations:** All file writes in UsageTracker must be atomic to prevent corruption
- **Performance:** Consider caching frequently accessed data (current_tier, usage counts) in memory with TTL
- **Privacy:** Session tracking should use anonymous session IDs, not user-identifying data
- **Storage Size:** Implement automatic pruning of old history entries (e.g., keep violations for 90 days only)
- **Grace Periods:** Reset grace allowances monthly alongside query resets
- **Feature Flags:** Feature usage tracking should align with tier_config.py feature definitions
- **Error Handling:** All new methods must handle missing/corrupted data gracefully with fallbacks
