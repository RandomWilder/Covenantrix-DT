# Document Entity Extraction Feature - Technical Plan

## Overview
Implement a structured view of key information automatically extracted from documents - people, organizations, locations, financial amounts, and important dates - displayed in an organized, scannable format. This feature provides transparency into what the system understood from documents and serves as a quick reference for key facts.

## Data Source
All required data already exists in LightRAG's storage files:
- Entity data: `kv_store_llm_response_cache.json` (contains entity names, types, and descriptions)
- Relationship data: `kv_store_full_relations.json` (contains relationship pairs between entities)

No additional LLM calls or processing required.

## Backend Implementation

### 1. New API Schema (backend/api/schemas/documents.py)
Add new response models for entity extraction:

```python
class EntityInfo(BaseModel):
    """Individual entity information"""
    name: str
    description: str

class EntitySummary(BaseModel):
    """Grouped entity summary"""
    people: List[EntityInfo]
    organizations: List[EntityInfo]
    locations: List[EntityInfo]
    financial: List[EntityInfo]
    dates_and_terms: List[EntityInfo]

class DocumentEntitiesResponse(BaseModel):
    """Document entities response"""
    document_id: str
    document_name: str
    entity_summary: EntitySummary
```

### 2. Entity Extraction Service (backend/domain/entities/)
Create new domain service for entity processing:

**backend/domain/entities/models.py**
- `EntityType` enum (person, organization, geo, event, category)
- `Entity` dataclass with name, type, description, relationship_count
- `EntitySummary` dataclass for grouped entities

**backend/domain/entities/service.py**
- `EntityExtractionService` class
- `extract_document_entities(document_id: str) -> EntitySummary` method
- Implement filtering logic:
  - Phase 1: Type-based inclusion (person ‚Üí People, organization ‚Üí Organizations, geo ‚Üí Locations)
  - Phase 2: Smart filtering for "category" entities (relationship count ‚â• 3)
  - Phase 3: Semantic grouping (financial vs dates/terms based on description content)
  - Phase 4: Noise exclusion (filter out generic concepts like "Lease", "Property")

### 3. LightRAG Storage Integration (backend/infrastructure/storage/)
Extend `LightRAGStorage` class with entity extraction methods:

**backend/infrastructure/storage/lightrag_storage.py**
- `get_entity_cache(document_id: str) -> Dict[str, Any]` method
- `get_entity_relationships(document_id: str) -> Dict[str, Any]` method
- `count_entity_relationships(entity_name: str, relationships: Dict) -> int` method

### 4. API Route (backend/api/routes/documents.py)
Add new endpoint:

```python
@router.get("/{document_id}/entities", response_model=DocumentEntitiesResponse)
async def get_document_entities(
    document_id: str,
    service: DocumentService = Depends(get_document_service)
) -> DocumentEntitiesResponse:
```

### 5. Document Service Extension (backend/domain/documents/service.py)
Add method to `DocumentService`:
- `get_document_entities(document_id: str) -> EntitySummary` method
- Integrate with `EntityExtractionService` and `LightRAGStorage`

## Frontend Implementation

### 1. Type Definitions (covenantrix-desktop/src/types/document.ts)
Add new interfaces:

```typescript
export interface EntityInfo {
  name: string;
  description: string;
}

export interface EntitySummary {
  people: EntityInfo[];
  organizations: EntityInfo[];
  locations: EntityInfo[];
  financial: EntityInfo[];
  dates_and_terms: EntityInfo[];
}

export interface DocumentEntitiesResponse {
  document_id: string;
  document_name: string;
  entity_summary: EntitySummary;
}
```

### 2. API Service (covenantrix-desktop/src/services/api/)
Extend existing API service with entity extraction:

**covenantrix-desktop/src/services/api/documentService.ts**
- `getDocumentEntities(documentId: string): Promise<DocumentEntitiesResponse>` method

### 3. Document Card Enhancement (covenantrix-desktop/src/features/documents/)
Update `DocumentCard.tsx` to include entity summary:

- Add collapsible entity summary section
- Display entity counts with badges
- Use icons NOT Emojies for visual scanning (üë§ People, üè¢ Organizations, üìç Locations, üí∞ Financial, üìÖ Dates & Terms)
- Handle empty sections gracefully
- Make entity names clickable (future enhancement)

### 4. Entity Summary Component (covenantrix-desktop/src/features/documents/)
Create new component:

**covenantrix-desktop/src/features/documents/EntitySummary.tsx**
- Collapsible card format with clear sections
- Section headers with count badges
- Entity list with names and descriptions
- Conditional rendering (hide empty sections)
- Hover/toggle for descriptions

## Implementation Algorithm

### Entity Extraction Process:
1. **Read LightRAG Storage Files**:
   - Parse `kv_store_llm_response_cache.json` for entity extraction records
   - Parse `kv_store_full_relations.json` for relationship data

2. **Type-Based Filtering**:
   - Include entities with types: person, organization, geo
   - Count relationships for each entity

3. **Smart Category Filtering**:
   - For "category" type entities, only include those with ‚â•3 relationships
   - Analyze entity descriptions for semantic grouping

4. **Semantic Grouping**:
   - Financial: descriptions containing monetary/payment/cost language
   - Dates/Terms: descriptions containing temporal/duration language

5. **Noise Exclusion**:
   - Filter out generic concepts: "Lease", "Property", "Document", "Agreement"
   - Filter out process terms: "Approval Process", "Compliance"

6. **Response Assembly**:
   - Group entities by semantic category
   - Return structured JSON response

## File Changes Required

### Backend Files:
- `backend/api/schemas/documents.py` - Add entity response models
- `backend/domain/entities/models.py` - New entity domain models
- `backend/domain/entities/service.py` - New entity extraction service
- `backend/infrastructure/storage/lightrag_storage.py` - Add entity extraction methods
- `backend/api/routes/documents.py` - Add entities endpoint
- `backend/domain/documents/service.py` - Add entity extraction method

### Frontend Files:
- `covenantrix-desktop/src/types/document.ts` - Add entity interfaces
- `covenantrix-desktop/src/services/api/documentService.ts` - Add entity API method
- `covenantrix-desktop/src/features/documents/DocumentCard.tsx` - Enhance with entity summary
- `covenantrix-desktop/src/features/documents/EntitySummary.tsx` - New component

## Dependencies
- No new external dependencies required
- Uses existing LightRAG storage files
- Leverages existing document processing pipeline
- Integrates with current API structure
