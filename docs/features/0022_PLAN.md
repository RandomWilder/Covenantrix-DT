# Feature 0022: User Settings Storage Integrity & Alignment

## Overview

Fix critical gaps in user settings persistence and initialization to ensure all fields in `user_settings.json` are properly populated, stored, and loaded across sessions. Address missing trial initialization, incorrect feature flags defaults, unpersisted zoom_level field, and ensure privacy settings are properly captured in storage (UI to be added in future feature).

**Current State Issues:**
- Trial dates (`trial_started_at`, `trial_expires_at`) remain null despite tier being "trial"
- Feature flag `use_default_keys` defaults to false but should be true for trial tier
- UI zoom_level exists in frontend but not in backend schema (resets on restart)
- Privacy settings fields have no migration defaults and inconsistent initialization

**Storage File:** `~/.covenantrix/rag_storage/user_settings.json`

## Root Cause Analysis

### Issue 1: Trial Initialization Timing
- `SubscriptionService._initialize_trial()` exists but relies on `check_tier_expiry()` call during backend startup
- Migration creates subscription section with null dates, expecting later initialization
- Race condition: settings file created during migration without calling subscription service
- **Fix:** Initialize trial dates directly during migration when subscription section is created

### Issue 2: Feature Flags Schema Mismatch
- `backend/api/schemas/settings.py` FeatureFlags class has `use_default_keys: bool = Field(default=False)`
- `backend/domain/subscription/tier_config.py` TIER_LIMITS["trial"] specifies `"use_default_keys": True`
- Migration uses `get_tier_features("trial")` which returns correct value, but Pydantic may override
- `check_tier_expiry()` syncs features on startup, but fresh install may show wrong value initially
- **Fix:** Update FeatureFlags schema default to True to match trial tier

### Issue 3: Zoom Level Field Missing
- Frontend TypeScript (`covenantrix-desktop/src/types/settings.ts` line 39) has `zoom_level: number`
- Backend schema (`backend/api/schemas/settings.py` UISettings) completely missing this field
- Frontend AppearanceTab allows zoom adjustment, but changes aren't persisted
- SettingsContext applies zoom via Electron IPC on load, but resets to hardcoded 0.8 default
- **Fix:** Add zoom_level field to backend UISettings schema and migration logic

### Issue 4: Privacy Settings Storage Gaps
- Three fields exist: `enable_telemetry`, `enable_cloud_backup`, `retain_history`
- Migration adds privacy section but relies on schema defaults (lines 167-172)
- Frontend SettingsContext `getDefaultSettings()` includes privacy defaults
- Backend schema has correct defaults but migration doesn't explicitly set values
- **Fix:** Ensure migration explicitly sets privacy defaults and handles missing zoom_level in existing UI sections

## Files to Modify

### Backend Schema Changes

**1. `backend/api/schemas/settings.py`**
- **Line ~110:** Add `zoom_level` field to `UISettings` class
- **Line ~128:** Change `FeatureFlags.use_default_keys` default from `False` to `True`

**2. `backend/infrastructure/storage/user_settings_storage.py`**
- **Line ~164:** Add `zoom_level: 0.8` to UI section default in migration
- **Line ~173:** Add check for existing UI sections missing zoom_level field
- **Line ~193-206:** Update subscription section creation to initialize trial dates immediately
- **Line ~206:** Add check for existing subscription sections missing trial dates
- **Line ~167-172:** Verify privacy section defaults are explicit

### Backend Service Enhancement

**3. `backend/domain/subscription/service.py`**
- **Line ~332-358:** `_initialize_trial()` method - no changes needed, but add debug logging
- **Line ~149-151:** Trial initialization check in `check_tier_expiry()` - add logging for troubleshooting

### Frontend Validation

**4. `covenantrix-desktop/src/contexts/SettingsContext.tsx`**
- **Line ~288-318:** `getDefaultSettings()` - verify includes `zoom_level: 0.8` in UI section
- **Line ~321-357:** `validateAndNormalizeSettings()` - verify handles zoom_level field
- **Line ~314:** Verify privacy defaults are present

**5. `covenantrix-desktop/src/types/settings.ts`**
- **Line ~39:** Confirm `zoom_level` field exists (already present)
- **Line ~19:** Consider removing unused `google_vision` field from ApiKeySettings

## Implementation Details

### Phase 1: Backend Schema Alignment

#### Change 1: Add zoom_level to UISettings

**File:** `backend/api/schemas/settings.py` (UISettings class, after line 111)

Add field:
```python
zoom_level: float = Field(default=0.8, ge=0.5, le=2.0, description="Zoom level (50%-200%)")
```

Complete UISettings should be:
```python
class UISettings(BaseModel):
    """UI appearance settings"""
    theme: Theme = Field(default=Theme.SYSTEM, description="UI theme")
    compact_mode: bool = Field(default=False, description="Enable compact mode")
    font_size: FontSize = Field(default=FontSize.MEDIUM, description="Font size")
    zoom_level: float = Field(default=0.8, ge=0.5, le=2.0, description="Zoom level (50%-200%)")
```

#### Change 2: Fix FeatureFlags Default

**File:** `backend/api/schemas/settings.py` (FeatureFlags class, line 128)

Change from:
```python
use_default_keys: bool = Field(default=False, description="Allow default API keys")
```

To:
```python
use_default_keys: bool = Field(default=True, description="Allow default API keys")
```

This aligns with trial tier configuration in `tier_config.py`.

### Phase 2: Migration Logic Updates

#### Change 3: Initialize Trial Dates During Migration

**File:** `backend/infrastructure/storage/user_settings_storage.py`

**Location:** Line ~193, replace subscription section creation

Current code creates subscription with null dates. Change to:
```python
# Add subscription section if missing
if "subscription" not in data:
    logger.info("Adding subscription section to settings")
    from domain.subscription.tier_config import get_tier_features
    from datetime import datetime, timedelta
    
    # Initialize trial period immediately during migration
    now = datetime.utcnow()
    trial_duration = 7  # From TIER_LIMITS["trial"]["duration_days"]
    
    data["subscription"] = {
        "tier": "trial",
        "license_key": None,
        "trial_started_at": now.isoformat(),
        "trial_expires_at": (now + timedelta(days=trial_duration)).isoformat(),
        "grace_period_started_at": None,
        "grace_period_expires_at": None,
        "features": get_tier_features("trial"),
        "last_tier_change": now.isoformat()
    }
    needs_save = True
    logger.info(f"Trial period initialized during migration: {trial_duration} days from {now.isoformat()}")
```

**Also add:** After the subscription section creation block (around line 207), add check for existing subscriptions missing dates:

```python
# Fix existing trial subscriptions missing dates
if "subscription" in data:
    subscription = data["subscription"]
    if subscription.get("tier") == "trial" and subscription.get("trial_started_at") is None:
        logger.info("Fixing existing trial subscription with missing dates")
        from datetime import datetime, timedelta
        now = datetime.utcnow()
        trial_duration = 7
        subscription["trial_started_at"] = now.isoformat()
        subscription["trial_expires_at"] = (now + timedelta(days=trial_duration)).isoformat()
        if subscription.get("last_tier_change") is None:
            subscription["last_tier_change"] = now.isoformat()
        needs_save = True
```

#### Change 4: Add zoom_level to UI Migration

**File:** `backend/infrastructure/storage/user_settings_storage.py`

**Location:** Line ~160, update UI section defaults:

Change from:
```python
if "ui" not in data:
    data["ui"] = {
        "theme": "system",
        "compact_mode": False,
        "font_size": "medium"
    }
```

To:
```python
if "ui" not in data:
    data["ui"] = {
        "theme": "system",
        "compact_mode": False,
        "font_size": "medium",
        "zoom_level": 0.8
    }
```

**Also add:** After UI section creation (around line 166), add check for existing UI sections:

```python
# Ensure zoom_level exists in existing UI sections
if "ui" in data and "zoom_level" not in data["ui"]:
    logger.info("Adding zoom_level to existing UI settings")
    data["ui"]["zoom_level"] = 0.8
    needs_save = True
```

#### Change 5: Verify Privacy Defaults

**File:** `backend/infrastructure/storage/user_settings_storage.py`

**Location:** Line ~167-172, verify privacy section is explicit:

Current code should remain:
```python
if "privacy" not in data:
    data["privacy"] = {
        "enable_telemetry": False,
        "enable_cloud_backup": False,
        "retain_history": True
    }
```

This ensures privacy fields are explicitly set, not relying on schema defaults.

### Phase 3: Frontend Validation

#### Change 6: Verify Frontend Defaults

**File:** `covenantrix-desktop/src/contexts/SettingsContext.tsx`

**Location:** Line ~288, verify `getDefaultSettings()` includes zoom_level:

Should include:
```typescript
ui: {
  theme: 'system',
  compact_mode: false,
  font_size: 'medium',
  zoom_level: 0.8 // Must be present
}
```

**Location:** Line ~321, verify `validateAndNormalizeSettings()` handles zoom_level:

Should include:
```typescript
ui: {
  theme: settings?.ui?.theme || defaults.ui.theme,
  compact_mode: settings?.ui?.compact_mode ?? defaults.ui.compact_mode,
  font_size: settings?.ui?.font_size || defaults.ui.font_size,
  zoom_level: settings?.ui?.zoom_level ?? defaults.ui.zoom_level
}
```

If missing, add these fields.

### Phase 4: Enhanced Logging

#### Change 7: Add Trial Initialization Logging

**File:** `backend/domain/subscription/service.py`

**Location:** Line ~336, add debug logging to `_initialize_trial()`:

Add at start of method:
```python
logger.info(f"_initialize_trial() called - checking if trial needs initialization")
```

**Location:** Line ~149, add logging to `check_tier_expiry()`:

Add after trial check:
```python
if subscription.tier == "trial" and subscription.trial_started_at is None:
    logger.info("Trial tier detected without start date, calling _initialize_trial()")
    await self._initialize_trial()
    changed = True
else:
    logger.info(f"Trial status: tier={subscription.tier}, started_at={subscription.trial_started_at}")
```

## Verification Steps

After implementation, verify:

### Backend Verification
1. Delete existing `~/.covenantrix/rag_storage/user_settings.json`
2. Start backend
3. Check created file has:
   - `trial_started_at` and `trial_expires_at` with ISO datetime values
   - `features.use_default_keys: true`
   - `ui.zoom_level: 0.8`
   - All privacy fields explicitly set

### Frontend Verification
1. Open app
2. Go to Settings > Appearance
3. Change zoom level to 120%
4. Save settings
5. Restart app
6. Verify zoom level is still 120% (not reset to default)

### Migration Verification
1. Create test `user_settings.json` with missing fields:
   - UI section without zoom_level
   - Subscription section with null trial dates
2. Start backend
3. Verify migration adds missing fields and saves updated file
4. Check backend logs for migration messages

### Integration Test
1. Fresh install with no settings file
2. Backend startup initializes trial with dates
3. Frontend loads settings without errors
4. All default values match between backend and frontend
5. Settings save/load cycle preserves all fields

## Expected Changes Summary

**Backend Schema:**
- UISettings gains zoom_level field
- FeatureFlags.use_default_keys default changes from False to True

**Migration Logic:**
- Subscription section creation immediately initializes trial dates
- Existing trial subscriptions get dates filled if missing
- UI section includes zoom_level in defaults
- Existing UI sections get zoom_level added if missing
- Privacy defaults remain explicit

**Behavior Changes:**
- Fresh installs get fully populated trial subscription immediately
- Zoom level persists across app restarts
- No backend restart required for proper trial initialization
- Feature flags consistent with tier configuration from first load

**No Changes Needed:**
- Frontend AppearanceTab (zoom UI already works)
- Frontend TypeScript types (zoom_level already defined)
- API key resolution (null in default mode is correct behavior)
- Privacy settings (fields captured, UI deferred to future feature)

## Notes

- API keys showing `null` in default mode is **correct** - they load from `.env` at runtime via APIKeyResolver
- Trial initialization now happens during migration, not dependent on backend startup sequence
- Feature flag defaults now match trial tier configuration at schema level
- Privacy settings have no UI in this feature - fields are storage-only, UI to be added in future feature
- Zoom level field addition is backward compatible - existing settings get migrated automatically

