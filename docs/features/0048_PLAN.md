# Feature 0048: Pre-cache tiktoken Encodings for Corporate SSL Compatibility

## Context
End users on corporate computers encounter SSL certificate verification failures when the application attempts to download tiktoken encoding files at runtime from `openaipublic.blob.core.windows.net`. This is caused by:
1. Corporate SSL inspection proxies intercepting HTTPS connections
2. Embedded Python distributions lacking proper CA certificate bundles
3. tiktoken library attempting to download `o200k_base.tiktoken` encoding file during LightRAG initialization

The error manifests as:
```
ssl.SSLCertVerificationError: [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate
```

This completely blocks RAG engine initialization, preventing users from using chat and document upload features.

**Solution**: Pre-cache tiktoken encodings during the build process and bundle them with the application, eliminating any runtime downloads that would require SSL verification.

## Technical Requirements

### 1. Create tiktoken Pre-cache Script
**File**: `backend/scripts/cache_tiktoken_encodings.py` (new file)

This script will:
- Download and cache all required tiktoken encodings before packaging
- Cache encodings for models used by the application:
  - `o200k_base` (used by gpt-4o, gpt-4o-mini)
  - `cl100k_base` (used by gpt-4, gpt-3.5-turbo, text-embedding-3-large)
- Verify cache completeness and report any failures
- Output the cache directory location for bundling
- Support both development and CI/CD execution

Key encodings to cache:
- By encoding name: `o200k_base`, `cl100k_base`
- By model name: `gpt-4o`, `gpt-4o-mini`, `text-embedding-3-large`, `gpt-4o-2024-08-06`

The script must run with the same Python environment that will be bundled (to ensure cache compatibility).

### 2. Update Build Dependencies
**File**: `backend/requirements.txt`

Add missing dependencies:
- `tiktoken>=0.5.1` (if not already present)
- `certifi>=2023.7.22` (SSL certificate bundle as fallback)

### 3. Modify Backend Initialization to Use Bundled Cache
**File**: `backend/main.py`

At the very top of the file (after path setup, before other imports):
- Set `TIKTOKEN_CACHE_DIR` environment variable to point to bundled cache location
- Add logic to detect if running in production (packaged) vs development
- In production: Set cache directory to `resources/tiktoken-cache`
- In development: Use default tiktoken cache location
- Add fallback to create cache directory if missing
- Log the tiktoken cache directory being used for debugging

The logic should be:
```
if production_mode:
    cache_dir = os.path.join(resources_path, "tiktoken-cache")
    if os.path.exists(cache_dir):
        os.environ["TIKTOKEN_CACHE_DIR"] = cache_dir
        logger.info(f"Using bundled tiktoken cache: {cache_dir}")
    else:
        logger.warning("Bundled tiktoken cache not found, will attempt download")
```

### 4. Modify RAG Engine to Verify Cache
**File**: `backend/infrastructure/ai/rag_engine.py`

In the `initialize()` method, before LightRAG initialization:
- Pre-verify tiktoken encodings are available
- Log cache status and location
- If cache is missing, log warning but continue (will use certifi as fallback)
- Add try-except around tiktoken operations with informative error messages

Add before line 339 (LightRAG initialization):
```python
# Verify tiktoken cache is available
try:
    import tiktoken
    cache_dir = os.environ.get("TIKTOKEN_CACHE_DIR", tiktoken.get_encoding("o200k_base")._tiktoken_cache_dir)
    self.logger.info(f"[TIKTOKEN] Cache directory: {cache_dir}")
    
    # Pre-load encoding to verify cache works
    encoding = tiktoken.get_encoding("o200k_base")
    self.logger.info(f"[TIKTOKEN] Successfully loaded o200k_base encoding from cache")
except Exception as e:
    self.logger.warning(f"[TIKTOKEN] Cache verification failed: {e}")
    self.logger.warning("[TIKTOKEN] Will attempt to download encodings (may fail on corporate networks)")
```

### 5. Add tiktoken Cache to Bundle Configuration
**File**: `covenantrix-desktop/electron-builder.yml`

Under `extraResources` section (after line 189), add:
```yaml
  # tiktoken encoding cache for offline operation (SSL fix for corporate networks)
  - from: ../dist/tiktoken-cache
    to: tiktoken-cache
    filter:
      - "**/*"
```

This bundles the pre-cached tiktoken encodings with the application resources.

### 6. Create Build Script to Generate Cache
**File**: `covenantrix-desktop/scripts/cache-tiktoken.js` (new file)

Node.js script that:
- Runs before electron-builder packaging
- Executes the Python cache script with the correct Python environment
- Detects platform (Windows/macOS/Linux) and uses appropriate Python executable
- Copies tiktoken cache from Python's cache location to `dist/tiktoken-cache/`
- Verifies cache was created successfully
- Handles errors gracefully and logs clear messages

Platform-specific Python paths:
- Windows: `dist/python-dist/python.exe` or system Python
- macOS/Linux: `dist/python-dist/bin/python` or system Python

The script should:
1. Ensure Python dependencies are installed (tiktoken, certifi)
2. Run `backend/scripts/cache_tiktoken_encodings.py`
3. Detect tiktoken cache directory from script output
4. Copy cache to `dist/tiktoken-cache/`
5. Verify expected files exist in cache

### 7. Update Package.json Build Scripts
**File**: `covenantrix-desktop/package.json`

Modify build scripts to run tiktoken caching before packaging:

Add new script:
```json
"prebuild": "node scripts/cache-tiktoken.js"
```

This ensures tiktoken cache is generated before every build operation.

Update existing scripts to include prebuild hook:
- `package:win`, `package:mac`, `package:linux` already call `npm run build`, which will trigger `prebuild`
- No changes needed to existing scripts, just add the `prebuild` script

### 8. Update afterPack Hook for Cache Verification
**File**: `covenantrix-desktop/afterPack.js`

Add verification step:
- Check if `tiktoken-cache` directory exists in Resources
- Log warning if cache is missing
- Verify cache contains expected files (9866*.tiktoken files)
- Add to both macOS and Windows/Linux paths

Add after existing permission fixes:
```javascript
// Verify tiktoken cache exists
const tiktokenCachePath = path.join(resourcesPath, 'tiktoken-cache');
if (fs.existsSync(tiktokenCachePath)) {
  const files = fs.readdirSync(tiktokenCachePath);
  console.log(`✓ tiktoken cache bundled: ${files.length} files`);
} else {
  console.warn('WARNING: tiktoken cache not found - SSL issues may occur on corporate networks');
}
```

### 9. Add certifi as SSL Fallback
**File**: `backend/main.py`

After setting TIKTOKEN_CACHE_DIR, add SSL certificate configuration:
```python
# Configure SSL certificates for any runtime downloads (fallback)
try:
    import certifi
    os.environ['SSL_CERT_FILE'] = certifi.where()
    os.environ['REQUESTS_CA_BUNDLE'] = certifi.where()
    logger.info(f"[SSL] Configured certificate bundle: {certifi.where()}")
except ImportError:
    logger.warning("[SSL] certifi not available - SSL verification may fail")
```

This provides a fallback for any other SSL operations in the application.

### 10. Documentation Updates
**File**: `docs/features/0048_PLAN.md` (this file)

Include troubleshooting section for developers:
- How to manually cache encodings
- How to verify cache is bundled
- How to test on corporate networks
- Environment variables that affect behavior

## Implementation Details

### tiktoken Cache Directory Structure
```
dist/tiktoken-cache/
  └── 9b5ad71b2ce5302211f9c61530b329a4922fc6a4
      ├── o200k_base.tiktoken  (~1.8 MB)
      └── cl100k_base.tiktoken (~1.8 MB)
```

The cache directory name is a hash used by tiktoken for versioning. The pre-cache script automatically creates this structure.

### Build Process Flow
1. Developer runs `npm run package:win` (or mac/linux)
2. `prebuild` script runs → `cache-tiktoken.js`
3. `cache-tiktoken.js` executes Python cache script
4. Python script downloads and caches tiktoken encodings
5. `cache-tiktoken.js` copies cache to `dist/tiktoken-cache/`
6. `npm run build` compiles frontend
7. `electron-builder` packages application
8. `electron-builder` includes `tiktoken-cache` via `extraResources`
9. `afterPack.js` verifies cache exists
10. Final package includes bundled tiktoken cache

### Runtime Initialization Flow
1. Application starts, `main.py` loads
2. Sets `TIKTOKEN_CACHE_DIR` to bundled cache location
3. Configures certifi SSL certificates as fallback
4. RAG engine initializes
5. tiktoken loads encoding from bundled cache (no network request)
6. LightRAG initializes successfully
7. Application ready for use

### Testing Strategy
1. **Development**: Verify script runs and caches encodings
2. **Build**: Check `dist/tiktoken-cache/` exists after build
3. **Packaged App**: Inspect Resources directory for cache
4. **Runtime**: Check logs for "Using bundled tiktoken cache" message
5. **Corporate Network**: Test on machine with SSL inspection proxy

### Error Handling
- If pre-cache script fails during build: Log warning but continue (allow development builds)
- If bundled cache is missing at runtime: Log warning and attempt download (with certifi fallback)
- If tiktoken still fails: RAG engine initialization fails with clear error message

## Files Modified/Created

### New Files
1. `backend/scripts/cache_tiktoken_encodings.py` - Pre-cache script
2. `covenantrix-desktop/scripts/cache-tiktoken.js` - Build integration script

### Modified Files
1. `backend/requirements.txt` - Add certifi dependency
2. `backend/main.py` - Set TIKTOKEN_CACHE_DIR and SSL certificates
3. `backend/infrastructure/ai/rag_engine.py` - Add cache verification
4. `covenantrix-desktop/package.json` - Add prebuild script
5. `covenantrix-desktop/electron-builder.yml` - Bundle tiktoken cache
6. `covenantrix-desktop/afterPack.js` - Verify cache bundled

## Success Criteria
1. tiktoken encodings are cached during build process
2. Cache is bundled with application in Resources directory
3. Application uses bundled cache at runtime (no network requests)
4. Application works on corporate networks with SSL inspection
5. Build process includes cache verification
6. Clear logging indicates cache status
7. Graceful fallback if cache is missing

## Testing Checklist
- [ ] Run cache script manually, verify encodings downloaded
- [ ] Run full build, verify `dist/tiktoken-cache/` exists
- [ ] Inspect packaged app Resources directory for cache
- [ ] Run application, check logs for "Using bundled tiktoken cache"
- [ ] Test on corporate network with SSL inspection
- [ ] Test with bundled cache deleted (verify fallback works)
- [ ] Test on Windows, macOS, and Linux builds
- [ ] Verify build fails gracefully if Python not available

## Notes
- This solution eliminates 100% of tiktoken runtime downloads
- Cache size is ~3.6 MB (minimal impact on installer size)
- Works on air-gapped networks once installed
- No code signing impact (data files, not executables)
- Compatible with existing auto-update mechanism
- Certifi provides fallback for other SSL operations in the app

